# NTN Stack 整合測試套件

這個測試套件用於驗證 **10. Tier-1 Mesh 網絡與 5G 核心網橋接** 和 **11. UAV 失聯後的 Mesh 網絡備援機制** 功能的完整性。

## 🎯 測試目標

確保系統完全滿足 TODO.md 中規定的所有功能要求，特別是：

-   ✅ **Tier-1 Mesh 網絡與 5G 核心網無縫橋接**
-   ✅ **UAV 失聯後自動切換到 Mesh 網絡**
-   ✅ **衛星連接恢復時智能切回 NTN 模式**
-   ✅ **2 秒內重建連線性能要求**
-   ✅ **多 UAV 並發切換支援**
-   ✅ **完整的故障恢復機制**

## 📁 文件結構

```
tests/
├── README.md                          # 本文件
├── Makefile                           # 測試執行工具
├── run_all_integration_tests.py       # 統合測試執行器
├── test_mesh_bridge_integration.py    # Mesh 橋接功能測試
└── test_uav_mesh_failover_integration.py  # UAV 備援機制測試
```

## 🚀 快速開始

### 1. 環境準備

確保 NetStack API 服務已啟動：

```bash
# 在主目錄中啟動 NetStack 服務
cd /home/sat/ntn-stack
make run-netstack
```

### 2. 安裝測試依賴

```bash
cd tests
make install-deps
```

### 3. 執行測試

#### 執行所有測試（推薦）

```bash
make test-all
```

#### 分別執行測試

```bash
# 只執行 Mesh 橋接功能測試
make test-mesh

# 只執行 UAV 備援機制測試
make test-uav
```

### 4. 查看測試結果

```bash
# 查看最新測試日誌
make logs

# 查看測試覆蓋範圍
make coverage
```

## 📊 測試覆蓋範圍

### 🔧 Mesh 橋接功能測試

| 測試項目      | 描述                       | 狀態 |
| ------------- | -------------------------- | ---- |
| 服務健康檢查  | 檢查 NetStack API 服務狀態 | ✅   |
| Mesh 節點創建 | 創建各種類型的 Mesh 節點   | ✅   |
| Mesh 節點管理 | 節點更新、查詢、狀態管理   | ✅   |
| 橋接網關創建  | 創建 5G-Mesh 橋接網關      | ✅   |
| 橋接網關管理  | 網關配置和狀態管理         | ✅   |
| 網絡拓撲獲取  | 完整網絡拓撲發現和管理     | ✅   |
| 性能指標監控  | 節點和網關性能監控         | ✅   |
| 路由優化      | 全局和特定節點路由優化     | ✅   |
| 封包轉發模擬  | 封包轉發機制驗證           | ✅   |
| 快速演示      | 完整功能演示               | ✅   |
| 負載測試      | 並發請求處理能力           | ✅   |
| 故障恢復      | 節點故障和恢復處理         | ✅   |

### 🚁 UAV 備援機制測試

| 測試項目               | 描述                   | 狀態 |
| ---------------------- | ---------------------- | ---- |
| UAV 創建和初始化       | 創建測試 UAV 和軌跡    | ✅   |
| 備援監控註冊           | UAV 註冊到備援監控系統 | ✅   |
| 連接質量監控           | 實時連接質量評估       | ✅   |
| 失聯檢測觸發           | 信號品質下降檢測       | ✅   |
| 自動 Mesh 切換         | 失聯時自動切換到 Mesh  | ✅   |
| 手動網絡切換           | 手動切換網絡模式       | ✅   |
| 衛星連接恢復           | 信號改善時智能恢復     | ✅   |
| 切換性能測試           | 切換時間性能驗證       | ✅   |
| 多 UAV 並發切換        | 多個 UAV 同時切換      | ✅   |
| 服務統計和監控         | 服務狀態統計           | ✅   |
| 故障恢復能力           | 服務重啟後狀態恢復     | ✅   |
| 快速演示驗證           | 完整演示功能驗證       | ✅   |
| **2 秒內重建連線驗證** | **關鍵性能要求驗證**   | ✅   |

## 🎯 關鍵性能指標

### 切換性能要求

-   **目標**: 2 秒內重建連線
-   **測試方法**: 多次切換時間測量
-   **通過標準**: 最慢切換時間 < 2000ms
-   **實際結果**: 所有測試均在要求範圍內

### 成功率要求

-   **並發切換成功率**: ≥ 80%
-   **2 秒內恢復成功率**: ≥ 80%
-   **整體測試通過率**: 100%

## 🔧 故障排除

### 常見問題

#### 1. NetStack API 服務未啟動

```bash
# 錯誤信息：連接被拒絕
# 解決方案：
cd /home/sat/ntn-stack
make run-netstack
```

#### 2. 依賴缺失

```bash
# 錯誤信息：ModuleNotFoundError
# 解決方案：
make install-deps
```

#### 3. 測試超時

```bash
# 錯誤信息：請求超時
# 解決方案：檢查系統負載，確保服務響應正常
make check-env
```

### 調試建議

1. **檢查服務狀態**：

    ```bash
    make check-env
    ```

2. **執行煙霧測試**：

    ```bash
    make smoke-test
    ```

3. **查看詳細日誌**：

    ```bash
    make logs
    ```

4. **清理和重新開始**：
    ```bash
    make clean
    make test-all
    ```

## 📈 測試報告

測試執行後會產生詳細的日誌文件 `integration_tests_YYYYMMDD_HHMMSS.log`，包含：

-   每個測試的執行狀態
-   性能指標和時間統計
-   錯誤信息和故障詳情
-   功能覆蓋度分析
-   關鍵要求驗證結果

## 🏆 成功標準

測試通過的條件：

1. ✅ 所有 Mesh 橋接功能測試通過
2. ✅ 所有 UAV 備援機制測試通過
3. ✅ 切換時間滿足 2 秒要求
4. ✅ 並發處理能力達標
5. ✅ 故障恢復機制正常
6. ✅ 系統整體穩定性良好

當所有測試通過時，表示系統完全滿足 TODO.md 中的功能要求，可以投入生產使用。

## 📞 支援

如遇問題，請檢查：

1. NetStack API 服務狀態
2. 網絡連接
3. 系統資源使用情況
4. 測試日誌中的詳細錯誤信息

確保在執行測試前系統處於穩定狀態，並且所有必要的服務都已正確啟動。
