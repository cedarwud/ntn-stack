# NTN Stack æ¸¬è©¦å¥—ä»¶ Makefile
# ç°¡åŒ–ç‰ˆæœ¬ - æ”¯æ´æ‰å¹³åŒ–ç›®éŒ„çµæ§‹

.PHONY: help install test test-unit test-integration test-e2e test-api test-performance
.PHONY: test-netstack test-simworld test-deployment test-all test-smoke
.PHONY: test-priority test-critical test-high test-medium test-low
.PHONY: coverage report clean clean-all setup check-env

# é¡è‰²å®šç¾©
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
BLUE=\033[0;34m
CYAN=\033[0;36m
NC=\033[0m # No Color

# é è¨­ç›®æ¨™
help:
	@echo "$(CYAN)ğŸ§ª NTN Stack æ¸¬è©¦å¥—ä»¶$(NC)"
	@echo "=================================="
	@echo ""
	@echo "$(GREEN)ğŸ“‹ å¿«é€ŸæŒ‡ä»¤:$(NC)"
	@echo "  $(YELLOW)install$(NC)       - å®‰è£æ¸¬è©¦ä¾è³´"
	@echo "  $(YELLOW)test$(NC)          - åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  $(YELLOW)test-smoke$(NC)    - ç…™éœ§æ¸¬è©¦"
	@echo "  $(YELLOW)test-priority$(NC) - æŒ‰å„ªå…ˆç´šåŸ·è¡Œæ¸¬è©¦ (æ¨è–¦)"
	@echo "  $(YELLOW)coverage$(NC)      - åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š"
	@echo "  $(YELLOW)report$(NC)        - ç”Ÿæˆæ¸¬è©¦æ‘˜è¦å ±å‘Š"
	@echo ""
	@echo "$(GREEN)ğŸ¯ å„ªå…ˆç´šæ¸¬è©¦:$(NC)"
	@echo "  $(RED)test-critical$(NC)     - åªåŸ·è¡Œé—œéµæ¸¬è©¦"
	@echo "  $(YELLOW)test-high$(NC)         - åªåŸ·è¡Œé«˜å„ªå…ˆç´šæ¸¬è©¦"
	@echo "  $(BLUE)test-medium$(NC)       - åªåŸ·è¡Œä¸­å„ªå…ˆç´šæ¸¬è©¦"
	@echo "  $(CYAN)test-low$(NC)          - åªåŸ·è¡Œä½å„ªå…ˆç´šæ¸¬è©¦"
	@echo ""
	@echo "$(GREEN)ğŸ”§ æ¸¬è©¦é¡å‹:$(NC)"
	@echo "  $(BLUE)test-unit$(NC)         - å–®å…ƒæ¸¬è©¦"
	@echo "  $(BLUE)test-integration$(NC)  - æ•´åˆæ¸¬è©¦"
	@echo "  $(BLUE)test-e2e$(NC)          - ç«¯åˆ°ç«¯æ¸¬è©¦"
	@echo "  $(BLUE)test-api$(NC)          - API æ¸¬è©¦"
	@echo "  $(BLUE)test-performance$(NC)  - æ€§èƒ½æ¸¬è©¦"
	@echo ""
	@echo "$(GREEN)ğŸ“¦ æ¨¡çµ„æ¸¬è©¦:$(NC)"
	@echo "  $(BLUE)test-netstack$(NC)     - NetStack æ¨¡çµ„æ¸¬è©¦"
	@echo "  $(BLUE)test-simworld$(NC)     - SimWorld æ¨¡çµ„æ¸¬è©¦"
	@echo "  $(BLUE)test-deployment$(NC)   - éƒ¨ç½²æ¨¡çµ„æ¸¬è©¦"
	@echo ""
	@echo "$(GREEN)ğŸ› ï¸ å·¥å…·:$(NC)"
	@echo "  $(BLUE)setup$(NC)             - è¨­ç½®æ¸¬è©¦ç’°å¢ƒ"
	@echo "  $(BLUE)check-env$(NC)         - æª¢æŸ¥ç’°å¢ƒ"
	@echo "  $(BLUE)clean$(NC)             - æ¸…ç†æ¸¬è©¦ç·©å­˜"
	@echo "  $(BLUE)clean-all$(NC)         - æ¸…ç†æ‰€æœ‰æ¸¬è©¦ç”¢ç‰©"

# ============================================================================
# å®‰è£å’Œè¨­ç½®
# ============================================================================

install:
	@echo "$(YELLOW)ğŸ“¦ å®‰è£æ¸¬è©¦ä¾è³´...$(NC)"
	@pip install -r requirements.txt
	@echo "$(GREEN)âœ… æ¸¬è©¦ä¾è³´å®‰è£å®Œæˆ$(NC)"

setup: install
	@echo "$(YELLOW)ğŸ”§ è¨­ç½®æ¸¬è©¦ç’°å¢ƒ...$(NC)"
	@mkdir -p reports/test_results reports/coverage reports/performance
	@echo "$(GREEN)âœ… æ¸¬è©¦ç’°å¢ƒè¨­ç½®å®Œæˆ$(NC)"

check-env:
	@echo "$(YELLOW)ğŸ” æª¢æŸ¥æ¸¬è©¦ç’°å¢ƒ...$(NC)"
	@python3 -c "import pytest, httpx, aiohttp; print('âœ… åŸºæœ¬ä¾è³´æª¢æŸ¥é€šé')"
	@ls -la reports/ 2>/dev/null && echo "âœ… å ±å‘Šç›®éŒ„å­˜åœ¨" || echo "âŒ å ±å‘Šç›®éŒ„ä¸å­˜åœ¨"
	@echo "$(GREEN)ç’°å¢ƒæª¢æŸ¥å®Œæˆ$(NC)"

# ============================================================================
# å„ªå…ˆç´šæ¸¬è©¦åŸ·è¡Œ
# ============================================================================

# æŒ‰å„ªå…ˆç´šåŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ (æ¨è–¦)
test-priority: setup
	@echo "$(RED)ğŸ¯ æŒ‰å„ªå…ˆç´šåŸ·è¡Œæ¸¬è©¦ - é«˜å„ªå…ˆç´šæ¸¬è©¦å¿…é ˆ 100% é€šé$(NC)"
	@python3 priority_test_runner.py
	@echo "$(GREEN)âœ… å„ªå…ˆç´šæ¸¬è©¦åŸ·è¡Œå®Œæˆ$(NC)"

# é—œéµæ¸¬è©¦ (æœ€é«˜å„ªå…ˆç´š)
test-critical: setup
	@echo "$(RED)ğŸš¨ åŸ·è¡Œé—œéµæ¸¬è©¦...$(NC)"
	@python3 priority_test_runner.py --priority CRITICAL
	@echo "$(GREEN)âœ… é—œéµæ¸¬è©¦åŸ·è¡Œå®Œæˆ$(NC)"

# é«˜å„ªå…ˆç´šæ¸¬è©¦
test-high: setup
	@echo "$(YELLOW)âš¡ åŸ·è¡Œé«˜å„ªå…ˆç´šæ¸¬è©¦...$(NC)"
	@python3 priority_test_runner.py --priority HIGH
	@echo "$(GREEN)âœ… é«˜å„ªå…ˆç´šæ¸¬è©¦åŸ·è¡Œå®Œæˆ$(NC)"

# ä¸­å„ªå…ˆç´šæ¸¬è©¦
test-medium: setup
	@echo "$(BLUE)ğŸ”§ åŸ·è¡Œä¸­å„ªå…ˆç´šæ¸¬è©¦...$(NC)"
	@python3 priority_test_runner.py --priority MEDIUM
	@echo "$(GREEN)âœ… ä¸­å„ªå…ˆç´šæ¸¬è©¦åŸ·è¡Œå®Œæˆ$(NC)"

# ä½å„ªå…ˆç´šæ¸¬è©¦
test-low: setup
	@echo "$(CYAN)ğŸ” åŸ·è¡Œä½å„ªå…ˆç´šæ¸¬è©¦...$(NC)"
	@python3 priority_test_runner.py --priority LOW
	@echo "$(GREEN)âœ… ä½å„ªå…ˆç´šæ¸¬è©¦åŸ·è¡Œå®Œæˆ$(NC)"

# å¼·åˆ¶åŸ·è¡Œæ‰€æœ‰å„ªå…ˆç´š (å³ä½¿é«˜å„ªå…ˆç´šå¤±æ•—)
test-priority-all: setup
	@echo "$(YELLOW)ğŸ”„ å¼·åˆ¶åŸ·è¡Œæ‰€æœ‰å„ªå…ˆç´šæ¸¬è©¦...$(NC)"
	@python3 priority_test_runner.py --continue-on-failure
	@echo "$(GREEN)âœ… æ‰€æœ‰å„ªå…ˆç´šæ¸¬è©¦åŸ·è¡Œå®Œæˆ$(NC)"

# ============================================================================
# å‚³çµ±æ¸¬è©¦åŸ·è¡Œ
# ============================================================================

# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
test: setup
	@echo "$(YELLOW)ğŸš€ åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦...$(NC)"
	@python3 run_tests.py --type all --summary
	@echo "$(GREEN)âœ… æ‰€æœ‰æ¸¬è©¦åŸ·è¡Œå®Œæˆ$(NC)"

# ç…™éœ§æ¸¬è©¦
test-smoke: setup
	@echo "$(YELLOW)ğŸ’¨ åŸ·è¡Œç…™éœ§æ¸¬è©¦...$(NC)"
	@python3 run_tests.py --type smoke --summary
	@echo "$(GREEN)âœ… ç…™éœ§æ¸¬è©¦å®Œæˆ$(NC)"

# æ¸¬è©¦é¡å‹
test-unit: setup
	@echo "$(BLUE)ğŸ”§ åŸ·è¡Œå–®å…ƒæ¸¬è©¦...$(NC)"
	@python3 run_tests.py --type unit --summary

test-integration: setup
	@echo "$(BLUE)ğŸ”— åŸ·è¡Œæ•´åˆæ¸¬è©¦...$(NC)"
	@python3 run_tests.py --type integration --summary

test-e2e: setup
	@echo "$(BLUE)ğŸ­ åŸ·è¡Œç«¯åˆ°ç«¯æ¸¬è©¦...$(NC)"
	@python3 run_tests.py --type e2e --summary

test-api: setup
	@echo "$(BLUE)ğŸŒ åŸ·è¡Œ API æ¸¬è©¦...$(NC)"
	@python3 run_tests.py --type api --summary

test-performance: setup
	@echo "$(BLUE)âš¡ åŸ·è¡Œæ€§èƒ½æ¸¬è©¦...$(NC)"
	@python3 run_tests.py --type performance --summary

# æ¨¡çµ„æ¸¬è©¦
test-netstack: setup
	@echo "$(CYAN)ğŸ“¡ åŸ·è¡Œ NetStack æ¨¡çµ„æ¸¬è©¦...$(NC)"
	@python3 run_tests.py --type unit --module netstack --summary

test-simworld: setup
	@echo "$(CYAN)ğŸŒ åŸ·è¡Œ SimWorld æ¨¡çµ„æ¸¬è©¦...$(NC)"
	@python3 run_tests.py --type unit --module simworld --summary

test-deployment: setup
	@echo "$(CYAN)ğŸš€ åŸ·è¡Œéƒ¨ç½²æ¨¡çµ„æ¸¬è©¦...$(NC)"
	@python3 run_tests.py --type unit --module deployment --summary

# ============================================================================
# å ±å‘Šå’Œè¦†è“‹ç‡
# ============================================================================

coverage: setup
	@echo "$(YELLOW)ğŸ“Š åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š...$(NC)"
	@python3 run_tests.py --type all --coverage --html --summary
	@echo "$(GREEN)âœ… è¦†è“‹ç‡å ±å‘Šç”Ÿæˆå®Œæˆ$(NC)"
	@echo "$(BLUE)ğŸ“„ HTML å ±å‘Šä½ç½®: reports/test_results/$(NC)"
	@echo "$(BLUE)ğŸ“Š è¦†è“‹ç‡å ±å‘Šä½ç½®: reports/coverage/html/$(NC)"

report:
	@echo "$(YELLOW)ğŸ“‹ ç”Ÿæˆæ¸¬è©¦æ‘˜è¦å ±å‘Š...$(NC)"
	@python3 tools/test_summary.py
	@echo "$(GREEN)âœ… æ¸¬è©¦æ‘˜è¦å ±å‘Šç”Ÿæˆå®Œæˆ$(NC)"

# å„ªå…ˆç´šæ¸¬è©¦å ±å‘Š
report-priority:
	@echo "$(YELLOW)ğŸ“Š é¡¯ç¤ºå„ªå…ˆç´šæ¸¬è©¦çµæœ...$(NC)"
	@test -f reports/priority_test_results.json && \
		python3 -c "import json; print(json.dumps(json.load(open('reports/priority_test_results.json')), indent=2, ensure_ascii=False))" || \
		echo "$(RED)âŒ æœªæ‰¾åˆ°å„ªå…ˆç´šæ¸¬è©¦çµæœï¼Œè«‹å…ˆåŸ·è¡Œ make test-priority$(NC)"

# ============================================================================
# æ¸…ç†
# ============================================================================

clean:
	@echo "$(YELLOW)ğŸ§¹ æ¸…ç†æ¸¬è©¦ç·©å­˜...$(NC)"
	@rm -rf .pytest_cache/ __pycache__/ .coverage
	@find . -name "*.pyc" -delete
	@find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@rm -f temp_result.json
	@echo "$(GREEN)âœ… æ¸¬è©¦ç·©å­˜æ¸…ç†å®Œæˆ$(NC)"

clean-reports:
	@echo "$(YELLOW)ğŸ—‘ï¸ æ¸…ç†æ¸¬è©¦å ±å‘Š...$(NC)"
	@rm -rf reports/test_results/* reports/coverage/*
	@rm -f reports/priority_test_results.json
	@echo "$(GREEN)âœ… æ¸¬è©¦å ±å‘Šæ¸…ç†å®Œæˆ$(NC)"

clean-all: clean clean-reports
	@echo "$(YELLOW)ğŸ§½ æ¸…ç†æ‰€æœ‰æ¸¬è©¦ç”¢ç‰©...$(NC)"
	@rm -f *.log test_*.json uav_*.json
	@echo "$(GREEN)âœ… æ‰€æœ‰æ¸¬è©¦ç”¢ç‰©æ¸…ç†å®Œæˆ$(NC)"

# ============================================================================
# é€²éšç”¨æ³•
# ============================================================================

# ä¸¦è¡Œæ¸¬è©¦
test-parallel: setup
	@echo "$(YELLOW)âš¡ åŸ·è¡Œä¸¦è¡Œæ¸¬è©¦...$(NC)"
	@pytest -n auto unit/ integration/ e2e/ api/ --tb=short
	@echo "$(GREEN)âœ… ä¸¦è¡Œæ¸¬è©¦å®Œæˆ$(NC)"

# è©³ç´°æ¸¬è©¦
test-verbose: setup
	@echo "$(YELLOW)ğŸ“ åŸ·è¡Œè©³ç´°æ¸¬è©¦...$(NC)"
	@pytest -v -s unit/ integration/ e2e/ api/ --tb=long
	@echo "$(GREEN)âœ… è©³ç´°æ¸¬è©¦å®Œæˆ$(NC)"

# åªåŸ·è¡Œå¤±æ•—çš„æ¸¬è©¦
test-failed: setup
	@echo "$(YELLOW)ğŸ”„ é‡æ–°åŸ·è¡Œå¤±æ•—çš„æ¸¬è©¦...$(NC)"
	@pytest --lf unit/ integration/ e2e/ api/
	@echo "$(GREEN)âœ… å¤±æ•—æ¸¬è©¦é‡åŸ·è¡Œå®Œæˆ$(NC)"

# èª¿è©¦æ¨¡å¼
test-debug: setup
	@echo "$(YELLOW)ğŸ› åŸ·è¡Œèª¿è©¦æ¨¡å¼æ¸¬è©¦...$(NC)"
	@pytest --pdb unit/ integration/ e2e/ api/
	@echo "$(GREEN)âœ… èª¿è©¦æ¨¡å¼æ¸¬è©¦å®Œæˆ$(NC)"

# CI æ¨¡å¼ (é©åˆæŒçºŒæ•´åˆ)
test-ci: setup
	@echo "$(YELLOW)ğŸ¤– åŸ·è¡Œ CI æ¨¡å¼æ¸¬è©¦...$(NC)"
	@python3 priority_test_runner.py 2>&1 | tee test_output.log
	@echo "$(GREEN)âœ… CI æ¨¡å¼æ¸¬è©¦å®Œæˆ$(NC)" 