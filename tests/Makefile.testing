# éšæ®µå››æ¸¬è©¦å°ˆç”¨Makefile
# æä¾›å¤šç¨®æ¸¬è©¦åŸ·è¡Œæ–¹å¼

.PHONY: help setup-venv test-container test-venv test-docker-dedicated clean

# è®Šæ•¸å®šç¾©
VENV_DIR := venv
PYTHON := python3.11
PIP := $(VENV_DIR)/bin/pip
PYTHON_VENV := $(VENV_DIR)/bin/python
CONTAINER_NAME := simworld_backend
TEST_CONTAINER_NAME := ntn-stage4-testing

help: ## é¡¯ç¤ºæ¸¬è©¦å¹«åŠ©ä¿¡æ¯
	@echo "ğŸ§ª éšæ®µå››æ¸¬è©¦åŸ·è¡Œé¸é …ï¼š"
	@echo ""
	@echo "ğŸ“¦ å®¹å™¨å…§æ¸¬è©¦ï¼ˆæ¨è–¦ï¼‰ï¼š"
	@echo "  test-container       åœ¨SimWorldå®¹å™¨å…§åŸ·è¡Œæ¸¬è©¦"
	@echo "  test-docker-dedicated ä½¿ç”¨å°ˆç”¨æ¸¬è©¦å®¹å™¨"
	@echo ""
	@echo "ğŸ è™›æ“¬ç’°å¢ƒæ¸¬è©¦ï¼š"  
	@echo "  setup-venv          å‰µå»ºPythonè™›æ“¬ç’°å¢ƒ"
	@echo "  test-venv           åœ¨è™›æ“¬ç’°å¢ƒä¸­åŸ·è¡Œæ¸¬è©¦"
	@echo ""
	@echo "ğŸ§¹ æ¸…ç†ï¼š"
	@echo "  clean               æ¸…ç†æ¸¬è©¦ç’°å¢ƒ"

# ===========================================
# æ–¹æ¡ˆ1: åœ¨SimWorldå®¹å™¨å…§åŸ·è¡Œï¼ˆæ¨è–¦ï¼‰
# ===========================================

test-container: ## åœ¨SimWorldå®¹å™¨å…§åŸ·è¡Œæ¸¬è©¦
	@echo "ğŸ³ åœ¨SimWorldå®¹å™¨å…§åŸ·è¡Œéšæ®µå››æ¸¬è©¦..."
	@if ! docker ps | grep -q $(CONTAINER_NAME); then \
		echo "âŒ $(CONTAINER_NAME) å®¹å™¨æœªé‹è¡Œï¼Œè«‹å…ˆå•Ÿå‹•ï¼šmake simworld-start"; \
		exit 1; \
	fi
	@echo "âœ… å®¹å™¨å·²é‹è¡Œï¼Œé–‹å§‹æ¸¬è©¦..."
	$(PYTHON) docker_test_runner.py

# ===========================================
# æ–¹æ¡ˆ2: å°ˆç”¨æ¸¬è©¦å®¹å™¨
# ===========================================

build-test-container: ## æ§‹å»ºå°ˆç”¨æ¸¬è©¦å®¹å™¨
	@echo "ğŸ”¨ æ§‹å»ºéšæ®µå››å°ˆç”¨æ¸¬è©¦å®¹å™¨..."
	docker build -f Dockerfile.testing -t ntn-stage4-testing ..

test-docker-dedicated: build-test-container ## ä½¿ç”¨å°ˆç”¨æ¸¬è©¦å®¹å™¨åŸ·è¡Œæ¸¬è©¦
	@echo "ğŸš€ ä½¿ç”¨å°ˆç”¨æ¸¬è©¦å®¹å™¨åŸ·è¡Œæ¸¬è©¦..."
	docker-compose -f docker-compose.testing.yml up --build --abort-on-container-exit
	docker-compose -f docker-compose.testing.yml down

# ===========================================
# æ–¹æ¡ˆ3: Pythonè™›æ“¬ç’°å¢ƒ
# ===========================================

setup-venv: ## å‰µå»ºPythonè™›æ“¬ç’°å¢ƒ
	@echo "ğŸ å‰µå»ºPythonè™›æ“¬ç’°å¢ƒ..."
	@if [ ! -d "$(VENV_DIR)" ]; then \
		$(PYTHON) -m venv $(VENV_DIR); \
		echo "âœ… è™›æ“¬ç’°å¢ƒå·²å‰µå»º"; \
	else \
		echo "â„¹ï¸ è™›æ“¬ç’°å¢ƒå·²å­˜åœ¨"; \
	fi
	@echo "ğŸ“¦ å®‰è£ä¾è³´å¥—ä»¶..."
	$(PIP) install --upgrade pip
	$(PIP) install -r ../requirements.txt
	$(PIP) install -r ../simworld/backend/requirements.txt
	$(PIP) install aiohttp httpx pytest pytest-asyncio
	@echo "âœ… è™›æ“¬ç’°å¢ƒè¨­ç½®å®Œæˆ"

test-venv: setup-venv ## åœ¨è™›æ“¬ç’°å¢ƒä¸­åŸ·è¡Œæ¸¬è©¦
	@echo "ğŸ§ª åœ¨è™›æ“¬ç’°å¢ƒä¸­åŸ·è¡Œéšæ®µå››æ¸¬è©¦..."
	$(PYTHON_VENV) stage4_quick_test.py
	$(PYTHON_VENV) real_api_integration_test.py

# ===========================================
# æª¢æŸ¥å’Œè¨ºæ–·
# ===========================================

check-python-versions: ## æª¢æŸ¥å¯ç”¨çš„Pythonç‰ˆæœ¬
	@echo "ğŸ” æª¢æŸ¥Pythonç‰ˆæœ¬ï¼š"
	@echo "ä¸»æ©ŸPythonï¼š"
	@which python3 && python3 --version || echo "  python3 not found"
	@which python3.11 && python3.11 --version || echo "  python3.11 not found"
	@which python3.8 && python3.8 --version || echo "  python3.8 not found"
	@echo ""
	@echo "å®¹å™¨å…§Pythonï¼š"
	@docker exec $(CONTAINER_NAME) python --version 2>/dev/null || echo "  å®¹å™¨æœªé‹è¡Œæˆ–ç„¡æ³•è¨ªå•"

check-dependencies: ## æª¢æŸ¥ä¾è³´å¥—ä»¶ç‹€æ…‹
	@echo "ğŸ“¦ æª¢æŸ¥ä¾è³´å¥—ä»¶ï¼š"
	@echo "ä¸»æ©Ÿç’°å¢ƒï¼š"
	@python3 -c "import matplotlib; print('âœ… matplotlib')" 2>/dev/null || echo "âŒ matplotlib"
	@python3 -c "import pandas; print('âœ… pandas')" 2>/dev/null || echo "âŒ pandas"
	@python3 -c "import scipy; print('âœ… scipy')" 2>/dev/null || echo "âŒ scipy"
	@echo ""
	@echo "å®¹å™¨ç’°å¢ƒï¼š"
	@docker exec $(CONTAINER_NAME) python -c "import matplotlib; print('âœ… matplotlib')" 2>/dev/null || echo "âŒ matplotlib"
	@docker exec $(CONTAINER_NAME) python -c "import pandas; print('âœ… pandas')" 2>/dev/null || echo "âŒ pandas"
	@docker exec $(CONTAINER_NAME) python -c "import scipy; print('âœ… scipy')" 2>/dev/null || echo "âŒ scipy"

diagnose: check-python-versions check-dependencies ## å®Œæ•´ç’°å¢ƒè¨ºæ–·
	@echo ""
	@echo "ğŸ“Š å»ºè­°çš„æ¸¬è©¦åŸ·è¡Œæ–¹å¼ï¼š"
	@echo "1. ğŸ¥‡ æ¨è–¦ï¼šmake test-container    (ä½¿ç”¨å·²æœ‰çš„SimWorldå®¹å™¨)"
	@echo "2. ğŸ¥ˆ å‚™é¸ï¼šmake test-venv         (å‰µå»ºç¨ç«‹è™›æ“¬ç’°å¢ƒ)"  
	@echo "3. ğŸ¥‰ é€²éšï¼šmake test-docker-dedicated (å°ˆç”¨æ¸¬è©¦å®¹å™¨)"

# ===========================================
# æ¸…ç†
# ===========================================

clean: ## æ¸…ç†æ¸¬è©¦ç’°å¢ƒ
	@echo "ğŸ§¹ æ¸…ç†æ¸¬è©¦ç’°å¢ƒ..."
	@if [ -d "$(VENV_DIR)" ]; then \
		rm -rf $(VENV_DIR); \
		echo "âœ… è™›æ“¬ç’°å¢ƒå·²æ¸…ç†"; \
	fi
	@if docker images | grep -q ntn-stage4-testing; then \
		docker rmi ntn-stage4-testing; \
		echo "âœ… æ¸¬è©¦å®¹å™¨æ˜ åƒå·²æ¸…ç†"; \
	fi
	@if [ -d "results" ]; then \
		echo "â„¹ï¸ ä¿ç•™æ¸¬è©¦çµæœç›®éŒ„ï¼šresults/"; \
	fi