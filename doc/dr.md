# 測量事件 A4、D1、D2、T1 的圖表設計與實作方案

*Event-A4.jpg：事件 A4（鄰小區優於門檻）的示意圖。藍色曲線表示鄰小區 RSRP 隨時間變化，紅色虛線表示設定的 a4-Threshold 門檻。當藍色曲線上升並超過門檻（扣除遲滯 Hys 後）時觸發 Enter 條件，此時開始測量報告；隨後當曲線下降低於門檻（加上遲滯 Hys）時滿足離開條件，事件取消。圖中以文字和箭頭標註了觸發/取消條件、Offset、TimeToTrigger、reportAmount、reportInterval、reportOnLeave 等參數。動畫按鈕將使圖中的節點按時間在曲線上滑動，以動態演示事件觸發過程。*

## 1. 事件 A4 互動圖表的實作

**圖表繪製：** 我們將使用 **Chart.js** 圖表庫（結合 React.js，可能透過 *react-chartjs-2* 套件）繪製事件 A4 的互動圖表。X軸為時間（例如秒），Y軸為無線測量值「觸發量」（Trigger Quantity），在本例中為鄰小區 RSRP，單位為 dBm。我們會從提供的 `Line-Plot.csv` 數據中讀取鄰小區 RSRP 隨時間的曲線，精確繪製成藍色折線。圖中水平紅色虛線對應配置的門檻值 **a4-Threshold**（如圖 1 所示）。根據 3GPP TS 38.331 定義，事件 A4 的觸發條件是鄰小區測量值加上偏置後超過門檻（扣除遲滯 Hys）。因此，在圖上當 RSRP 曲線上穿過門檻線（考慮 Hys 後）即代表滿足 *Trigger Condition*。相反地，當曲線下穿門檻線（加上 Hys）則滿足 *Cancel Condition*。我們會在這兩個臨界點處以突出標記（如特定顏色的圓點）標示出事件進入和退出的時刻。

**文字標籤與箭頭：** 為了直觀展示事件邏輯，我們將利用 Chart.js 的註解插件（**chartjs-plugin-annotation**）在圖上添加文字標籤和箭頭指示各要素：

* **Trigger Condition：** 標記在事件觸發點附近，箭頭指向藍色曲線穿越門檻的那一刻。由於 TS 38.331 定義 *Entering condition* 為 `Mn + Ofn + Ocn – Hys > Thresh`，圖上實際觸發點會略低於門檻線一個遲滯值 Hys（門檻減去 Hys）。我們將以箭頭線標示門檻線與觸發點之間的距離並標註「Hys」，體現遲滯的作用。

* **Cancel Condition：** 同理，在事件取消處標註，箭頭指向藍色曲線下滑穿回門檻線的時刻。離開條件為 `Mn + ... + Hys < Thresh`，意味著曲線跌破門檻加上一個遲滯裕量才取消事件。因此箭頭將強調門檻線以上 Hys 的距離。

* **Offset：** 如果配置了測量偏置（例如鄰區/頻點偏置 Ofn、Ocn），它們會影響有效門檻。圖中可用一條垂直箭頭表示 Offset 對門檻的移動量，並在旁標示「Offset」。例如，若對鄰小區配置了 -3dB 的 offset，則實際觸發門檻相當於門檻提高3dB，我們會在圖上門檻線處標出此偏移量。

* **TimeToTrigger (TTT)：** 事件觸發前通常要求條件持續一段時間。圖中將以雙向箭頭線標註時間軸上從條件首次滿足到報告真正觸發間的持續時間（TTT）。例如，假設配置的 TimeToTrigger 為 320 ms，則當曲線超過門檻後需連續超過此線達0.32秒，才正式觸發事件。我們會在觸發點前後的時間軸上用括號線標示出這段持續時間並標記「TimeToTrigger」。

* **reportAmount 與 reportInterval：** 這兩個參數決定事件觸發後 UE 向網路匯報測量的次數和頻率（例如 reportAmount=3 表示最多回報3次測量結果；reportInterval 決定每次報告的間隔時間）。在圖上，我們將在事件觸發後的曲線上以黑色圓點表示每次匯報的時刻，並用水平箭頭標示相鄰兩次報告間的間隔，在旁註明「reportInterval」。一組連續的黑點數目則對應 reportAmount（例如圖 1 中在事件觸發後標出了若干個等間距的點代表多次上報）。

* **reportOnLeave：** 若配置了 *reportOnLeave*，則當事件取消（離開條件滿足）時 UE 會額外發送一次報告。圖中我們將在 Cancel Condition 對應時間點附近以箭頭或特別標記註明「reportOnLeave」，表示當藍色曲線跌破門檻線取消事件時觸發了一次最後的測量上報。

上述標註與箭頭將使用 Chart.js Annotation 插件來繪製。我們可以定義如 **label** 型註解（帶文字的矩形標籤）以及 **line** 型註解（可設置箭頭頭尾的直線）固定在指定的數據值位置。例如，Trigger Condition 箭頭線起點可配置在觸發點的座標，終點指向門檻線位置，並開啟箭頭樣式，旁邊附帶文本標籤說明。這些標籤文字將與問題所給相同（英語說明詞），以方便對照規範參數名稱。

**動畫效果：** 為增強互動性，圖表上將增加一個「播放/動畫」按鈕。點擊按鈕後，圖上的一個**移動節點**（可以用與曲線顏色相同的小圓點表示當前 UE 測量值）會按照時間軸移動，模擬 RSRP 隨時間變化的過程。這可透過 React 的 state 和 Chart.js 更新機制實現：例如使用 `requestAnimationFrame` 或 `setInterval` 逐步更新節點的位置（對應 CSV 數據的下一個時間點），並重新渲染圖表數據。移動節點在越過門檻時，我們可以觸發高亮效果（例如閃爍或顏色變化）來提示事件觸發或取消。另外，當事件進入觸發狀態時，可以在圖表區域上突出顯示「事件已觸發」狀態（例如改變門檻線顏色或在圖表上方顯示一個提示文字），直到事件結束。這種動畫呈現讓用戶直觀觀察到**Trigger Condition**維持 *TimeToTrigger* 後事件觸發、接著定期回報若干次、最後在**Cancel Condition**出現時結束的完整流程。

## 2. 事件 D1、D2、T1 的圖表設計概念

根據 TS 38.331 中對 D1、D2、T1 的定義，我們可以設計與 A4 類似的圖表來展現這些事件的觸發條件與時序。不過每種事件的測量量和條件不同，因此圖表的坐標軸及動態標示需做相應調整：

**(a) 事件 D1：** *「UE 與參考位置1的距離大於門檻1，且與參考位置2的距離小於門檻2」* 時觸發。這是一種基於位置距離的事件。我們將設計如下圖表元素：

* **坐標軸：** X軸仍表示時間，Y軸改為「距離」（單位例如公尺 m）。由於 D1 涉及兩個距離量（UE-參考位置1 與 UE-參考位置2），圖上將繪製兩條隨時間變化的距離曲線（可用不同顏色區分，例如綠色曲線表示距離1，橙色曲線表示距離2）。Y軸刻度以公尺為單位，確保能標示門檻值的大小。

* **門檻線：** 在圖上添加兩條水平線對應 *Thresh1* 和 *Thresh2* 閥值。一條（Thresh1）位於某距離值上方，另一條（Thresh2）位於某距離值下方，代表事件條件中“一個距離須高於門檻1，另一個須低於門檻2”的要求。例如，Thresh1 可能設定為 500 公尺，Thresh2 設為 100 公尺。那麼圖上一條虛線標示 y=500m（門檻1），另一條標示 y=100m（門檻2）。

* **進入/離開條件標示：** D1 事件的進入條件有兩部分，同時滿足才觸發：**條件 D1-1：** UE-位置1距離 > Thresh1（超過門檻1），**條件 D1-2：** UE-位置2距離 < Thresh2（低於門檻2）。離開條件則是任一反向條件滿足即可取消：**D1-3：** 距離1下降低於門檻1（甚至低於門檻1減去遲滯Hys），或 **D1-4：** 距離2上升超過門檻2（加上遲滯）。我們會在圖上標出這些條件的位置：當綠色距離1曲線上升穿過 Thresh1 線時（表示超過門檻1），和橙色距離2曲線下降穿過 Thresh2 線時（低於門檻2），這兩者時間點若重疊或重合，即為事件觸發的時刻。我們可以在該時間點畫一條垂直線標註「Trigger Condition met」，箭頭指向兩條曲線與各自門檻線的交點。同樣地，當任一離開條件發生（例如綠色曲線降回 Thresh1 之下，或橙色曲線升回 Thresh2 之上），我們在相應時間點標示「Cancel Condition」。由於遲滯 Hys 在D1中同樣適用，進入和離開時實際臨界值會較門檻略有偏移（如觸發需要距離1 > 閾值1 + Hys，取消需要距離1 < 閾值1 - Hys 等）。因此圖上也可類似 A4 標示出 Hys 對門檻線的影響，例如在 Thresh1 線上方繪製一小段表示 +Hys，在下方表示 -Hys，在關鍵交點處附註 Hys。

* **時間視窗與互動：** 我們會標示事件觸發的必要持續時間窗（TimeToTrigger）。也就是說，綠/橙兩條曲線同時滿足門檻條件的時間需持續超過配置的 TTT。例如，如果 TTT=1秒，則圖上需要高亮顯示距離曲線同時處於門檻條件內持續滿1秒的區間。我們可以用半透明的矩形區間或水平線雙箭頭來標注這段時間窗，提示只有維持足夠長時間才真正上報事件。互動方面，可以和A4類似，提供播放按鈕後讓時間游標移動，觀察距離曲線變化：當游標經過某段時間發現同時滿足條件時，可以改變圖表元素顏色提示“事件啟用中”。在事件啟用期間，同樣以黑點和箭頭表示 reportAmount 次數的回報以及 reportInterval 間隔，reportOnLeave 機制在事件結束剎那的回報也可一併展示（如在取消點再繪製一個黑點標記）。

**(b) 事件 D2：** *「UE 與服務小區的移動參考位置距離大於門檻1，且與另一移動參考位置距離小於門檻2」*。事件 D2 本質上與 D1 類似，也是雙門檻的距離事件，但參考位置一個隨服務小區移動（如衛星軌道參考點），另一個固定在配置的參考位置。D2 的圖表設計可參照 D1，差異在於對參考位置的描述上：

* **坐標與曲線：** X軸依然是時間，Y軸為距離（公尺）。繪製兩條距離曲線：**距離1 (Ml1)** 表示 UE 到服務小區「移動參考位置」的距離，**距離2 (Ml2)** 表示 UE 到配置參考位置的距離。因為參考點可能會移動（例如衛星軌道），距離曲線的形狀可能更複雜，但圖表處理方式與 D1 相同。

* **門檻與條件：** 同樣繪製水平線表示 Thresh1 和 Thresh2（單位公尺）。事件進入需同時滿足 **D2-1:** 距離1 > Thresh1，**D2-2:** 距離2 < Thresh2；離開條件為 **D2-3:** 距離1 < Thresh1 或 **D2-4:** 距離2 > Thresh2（均考慮 Hys 修正）。因此，我們在圖中和 D1 一樣標示出距離1曲線與 Thresh1 交會點、距離2曲線與 Thresh2 交會點，用箭頭標註「Trigger Condition」當兩條件同時成立時觸發。離開條件發生時則標註「Cancel Condition」。遲滯 Hys 在圖上以類似方式標明，提醒讀者存在進出判決的滯後區間。

* **時間窗與互動：** D2 事件也會設置 TimeToTrigger，因此我們需要標示距離1和距離2同時滿足條件的持續時間窗。如有需要，還可在圖上標示「移動參考位置」本身的移動——例如用虛線或附圖示意參考點隨時間的位置變化，但這可能超出圖表主要範圍。我們注重呈現 UE 與這些點的距離是否進出閾值範圍。因此互動動畫部分，游標移動時可以即時判斷 D2 條件是否滿足，類似地用圖形變化提示。報告行為（reportAmount/Interval/OnLeave）則與 A4/D1 一致，在事件觸發後據配置繪製多個報告點以及取消時的報告點。

**(c) 條件事件 T1：** *「UE 測得的時間處於距門檻一定時間長度以內」*。這是一種特殊的**基於時間**的條件事件，用於例如**條件切換**中（CondEvent）。它不是對無線測量量的比較，而是對UE本地計時器的判斷。圖表設計與前述事件有所不同：

* **坐標軸：** X軸可以表示 UE 經歷的實際時間（例如系統時間或某參考時刻開始的經過時間，單位毫秒ms），**Y軸可以用來表示事件狀態（觸發/未觸發）或計時進度**。由於 T1 的條件本質是在比較時間量，因此我們可以將圖表設計為一條隨時間發生跳變的狀態曲線：例如用 0/1 二值表示事件未觸發和已觸發狀態。另一種方式是直接以 X軸呈現門檻時間點的位置。

* **觸發條件呈現：** CondEvent T1 定義進入條件為 `Mt > Thresh1`，離開條件為 `Mt > Thresh1 + Duration`。直觀來說，當 UE 的計時器 Mt 超過某個閾值 Thresh1 時，事件開始；當 Mt 超過 (Thresh1 + Duration) 時，事件結束。換言之，事件有效期間是從 Mt=Thresh1 開始，持續一段設定的 Duration 長度。我們可以在圖上突出這一**時間窗口**：在 X軸上標出 **Thresh1** 對應的時間點，以及 **Thresh1 + Duration** 的時間點。這兩點之間的區間（例如用半透明陰影或顏色標記）代表事件 T1 “為真”的期間。Y軸可以簡單表示為狀態值，區間內 Y=1（事件啟用），區間外 Y=0（未啟用），形成一條矩形脈衝狀的曲線。這將清晰展示「Mt 介於 Thresh1 和 Thresh1+Duration 之間時事件成立」的概念。

* **互動性：** 由於 T1 與具體測量值無關，我們可以更多地採用**時間軸的互動**。例如，提供一個滑動條或動畫游標表示當前 UE 的時間 *Mt*，初始為0隨時間線性增長（可以假設 Mt 就是實際時間計數）。當游標滑過 Thresh1 時，可以觸發圖形變化（例如將狀態曲線從0切換到1，或高亮時間區間）以表示事件觸發。同樣，我們在 Mt 達到 Thresh1+Duration 時，再次改變狀態表示事件結束。由於 Mt 以毫秒計且通常單調增加，確認 Mt、Thresh1、Duration 都使用同樣單位（ms），因此圖上可以精確標出這些時間點的刻度。例如 Thresh1=5000ms，Duration=2000ms，則在X軸上5s和7s處各畫一條垂直參考線，並在區間5\~7s區段以另一種底色顯示。動畫播放時，在5s時我們顯示「Trigger Condition (T1-1) met」，在7s時顯示「Cancel Condition (T1-2) met」。由於 T1 常用於條件切換配置，reportAmount等參數通常不應用於此（T1更多作為條件判斷而非直接觸發測量報告）。但是如果需要展示，也可以假想在事件有效期間網路可能要求的動作。我們的重點是強調時間門檻和持續時間這兩個核心元素的圖形化呈現：例如在圖上方註明 *t1-Threshold* 值和 *Duration* 值，以及以雙箭頭標註這段持續時間窗口。

總之，D1、D2、T1 的圖表會繼承 A4 圖的互動風格：使用清晰的門檻線、曲線和動態標示來演示條件判斷，同時加上適當的用戶互動（滑動/播放）來觀察事件進入和離開。每個圖的關鍵是在**座標軸單位**（信號強度dBm vs 距離m vs 時間ms）和**條件區間**上做對應修改，以確保觀眾能直觀理解不同事件的物理意義和判斷邏輯。

## 3. 基於 A4 圖表程式的修改以繪製 D1、D2、T1

由於事件 A4、D1、D2、T1 在本質上都是 3GPP 定義的測量事件，我們可以重用 A4 圖表的實現框架，通過修改配置和擴充資料來支持新的事件圖表：

* **資料集與座標調整：** 在 A4 中，我們載入的是一組 RSRP 對時間的數據並繪製單一曲線。對於 **D1/D2**，需要擴充為**兩組距離資料**（距離1和距離2）對時間的曲線。因此在 Chart.js 配置的 `data.datasets` 中新增一個資料序列，包含距離2隨時間的值。需要確保 Y軸標度改為公尺且能同時涵蓋兩條距離曲線的範圍和門檻值。我們也要在 `options.scales` 中更新 Y 軸的 `title` 為「Distance (m)」以符合語意。對於 **T1**，數據可以簡化為一條**狀態曲線**。例如可以程式生成一個 0/1 隨時間的序列：時間軸從0到 Thresh1 時狀態為0，從 Thresh1 到 Thresh1+Duration 為1，之後回復0。這組序列作為資料集繪製即可（例如使用折線或階梯線呈現）。同時將 Y軸切換為無單位的狀態指示（或僅在圖例中標註 0/1 = off/on），X軸保留時間(ms)。

* **門檻線與遲滯：** 在 A4 程式中，我們透過 Chart.js 的**annotation**插件繪製了一條 a4-Threshold 門檻線以及 Hys 的箭頭標註。對 **D1**/**D2**，需要改為繪製兩條門檻線（Thresh1, Thresh2）。可以透過增加兩個 annotation 定義來實現：例如一個 `type: 'line'` 註解設定在 y=Thresh1，另一個在 y=Thresh2，各自標註文字。「Offset」在 D1/D2 中通常不適用（因為Offset偏置主要針對信號量測，距離事件中沒有Ofn/Ocn），因此可省略或根據需要移除相關標註程式碼。遲滯 Hys 在 D1/D2 屬性為 hysteresisLocation，我們可以沿用 A4 的處理方式：例如在觸發條件箭頭上標示 ±Hys 差值。同樣透過 annotation 畫出略高或略低於門檻的參考線段，並標記「Hys」。**T1** 事件有門檻時間和持續時間，我們不需要傳統意義上的水平門檻線，但需要在 X軸上標記垂直參考線：可利用 annotation 畫兩條垂直線（`scaleID: 'x-axis'` 類型的 line）分別位於 x=Thresh1 和 x=Thresh1+Duration，並在頂部標註文字例如「Thresh1 時刻」和「Thresh1+Duration 時刻」。也可以用另一種 annotation 標示兩線之間的區域（Chart.js註解插件支援 box 型區域標記），著上半透明顏色以表示 T1 的有效時間窗。

* **條件判斷與高亮：** A4 程式中可能透過檢查當前 RSRP 與門檻的比較來決定是否高亮觸發狀態。在 D1/D2，需要修改這段邏輯：觸發判定應為「距離1 > Thresh1 且 距離2 < Thresh2」同時為真。我們需要在動畫迴圈中，每當節點移動時同時讀取兩個距離值，檢查上述條件。如果為真且持續超過TTT，則設置圖表狀態為事件啟用。可以重用 A4 的 TTT計時機制，但觸發判斷從單一比較改為複合比較。同樣，離開條件檢查改為「距離1 < Thresh1 + Hys **或** 距離2 > Thresh2 - Hys」發生則視為事件結束。我們可以對應地調整程式中控制高亮/狀態的邏輯。對 **T1** 而言，觸發條件單一且簡單（Mt 超過門檻時間），程式上可以使用計時器或直接依據動畫時間進行判斷：當動畫當前時間變數 `t` 超過 Thresh1 時將事件狀態設為真，超過 Thresh1+Duration 時設為假。這可直接根據動畫進度實現，而無需讀取外部數據序列。

* **圖表註解更新：** 我們需要更新文字標籤內容以匹配不同事件。A4 的標籤包括「Trigger Condition」「Cancel Condition」等，可在 D1/D2 沿用。但我們或許需要增加區分，例如在圖上標出「Trigger Conditions D1-1 & D1-2」來強調需同時滿足兩個條件。可以在箭頭旁增加更多說明文字或者分兩個箭頭標註各自條件的達成。類似地，「Cancel Condition」可以標註為「D1-3 or D1-4」已滿足。這些文字可以從 TS 38.331 定義中摘取關鍵描述，以提醒使用者對照規範條款。例如註解文字寫成 “D1 Enter: Ml1 > Thresh1 且 Ml2 < Thresh2”。**T1** 事件則將標籤修改為「Trigger Condition (T1-1)」在 Thresh1 時刻、「Cancel Condition (T1-2)」在 Thresh1+Duration 時刻，以對應規範中的條件編號。由於 T1 沒有 Offset 和 Hys 等參數，我們可以隱藏或移除那些在 A4 圖中對應的註解元素（避免混淆）。

* **報告行為設定：** reportAmount、reportInterval、reportOnLeave 等在 A4 程式中可能是參數化的（例如從配置讀取）。在 D1/D2 圖表中，這些仍舊適用，因為D1/D2也是測量報告事件，可配置上報次數和頻率。我們無需更改這部分邏輯，只需確保在事件觸發後按照相同規則繪製報告點和間隔即可。如果希望強調不同事件的配置，我們可以調整 reportAmount 或 reportInterval 數值來演示不同情境（例如 D1 可能只上報一次，reportAmount=1；D2 上報多次等）。**對於 T1**，通常它是作為條件切換輔助事件，實際並不直接觸發 UE 向網路發送測量報告，因此可以選擇不顯示 reportAmount/Interval。在圖表實作上，可透過檢查事件類型來決定是否繪製這些元素：如果是 T1，則隱藏上報相關的標記和動畫；如果是 A4/D1/D2，則照常顯示。

* **重用與模組化：** 為了優雅地擴充程式，我們可以將共通部分（如繪製軸、曲線、門檻線、動畫控制）模組化。在 React 中，可建立一個通用的 Chart 元件，根據傳入的事件類型 prop（例如 `"A4"`, `"D1"`, `"D2"`, `"T1"`）來決定載入哪種資料集、設定哪種軸標題和門檻註解、以及套用哪套事件判斷邏輯。這樣增添新事件支持時，只需增加對應的資料與配置，而不需重寫大量程式碼。例如，可用一個配置對照表：`const eventConfigs = { A4: {...}, D1: {...}, ... }`，裡面定義各事件的門檻值、Hys、是否顯示Offset等，Chart元件根據選擇的事件讀取並應用設定，繪製出對應圖表。

透過上述修改，我們即可在現有 A4 互動圖表的基礎上，高效地繪製出 D1、D2、T1 事件的互動畫面。每個圖表都忠實反映 3GPP TS 38.331 中對應事件的進入/離開條件與相關參數。最終，用戶將能夠透過這組互動圖，直觀對比不同事件的判斷標準（信號強度 vs 距離 vs 時間）以及它們在測量報告機制上的異同，加深對 5G NR 測量事件的理解。