# LEO 衛星換手系統開發計劃 - NTPU 場景實現

## 專案概述

本計劃專注於建立 NTPU (國立臺北大學) 場景的 LEO 衛星換手系統，實現基於 3GPP 38.331 標準的 D2/A4/A5 事件檢測與決策。系統採用 Docker 容器化架構，在映像檔建構階段預處理衛星軌道資料，為即時換手決策提供高效能支援。

## 現階段重點

1. **單一場景優化**：深度優化 NTPU 場景的換手性能
2. **事件驅動架構**：實現 D2/A4/A5 標準事件檢測
3. **預計算策略**：Docker build 時完成軌道計算，運行時快速查詢
4. **規則式決策**：先以規則式實現，為未來 RL 預留介面

## 開發階段總覽

### [Phase 1: 資料預處理架構與流程](./phase1-data-preprocessing.md)
- 兩階段預處理：基礎軌道計算 + 分層門檻處理
- SGP4 軌道預測，120分鐘週期，30秒間隔（涵蓋 Starlink + OneWeb）
- Volume 掛載策略與儲存架構設計
- **現況**: 需更新為 120 分鐘週期並加入 D2/A4/A5 事件

### [Phase 2: D2/A4/A5 換手事件檢測實現](./phase2-handover-events.md)
- 基於分層門檻 (13.5°/11.25°/5.0°) 的事件檢測
- D2: 服務衛星即將不可見 (< 7.0°)
- A4: 鄰近衛星超過執行門檻
- A5: 服務變差且鄰近變好的複合條件
- **重點**: 在預處理階段生成事件資料

### [Phase 3: 基礎架構開發與 API 整合](./phase3-rl-integration.md)
- 規則式換手決策引擎
- FastAPI + WebSocket 即時事件串流
- 資料存取層與監控指標
- **特色**: 為未來 RL 預留標準介面

### [Phase 4: Docker 部署與系統整合](./phase4-api-implementation.md)
- 多階段 Dockerfile 優化
- Docker Compose 整合配置
- Volume 管理與備份策略
- **目標**: 建構時間 < 5分鐘，啟動時間 < 30秒

### [Phase 5: 未來擴展規劃](./phase5-deployment-optimization.md)
- 多場景擴展介面設計（預留）
- 強化學習模型整合準備（預留）
- 雲端部署與自動化更新
- **說明**: 非立即實施，為未來發展預留

## 系統架構

```
┌─────────────────────────────────────────────────────────┐
│                 SimWorld Frontend (React)                │
├─────────────────────────────────────────────────────────┤
│                    NetStack API (FastAPI)                │
├──────────────┬──────────────┬──────────────┬───────────┤
│ 換手決策引擎  │  事件檢測器   │  監控服務    │ 3D 資料服務│
├──────────────┴──────────────┴──────────────┴───────────┤
│              預計算資料層 (JSON + Redis)                 │
├─────────────────────────────────────────────────────────┤
│            Docker Volume (軌道資料 + 事件資料)           │
└─────────────────────────────────────────────────────────┘
```

## 資料處理流程

```
TLE 原始資料 (8000+ 衛星)
    ↓
[Docker Build 階段]
    ↓
SGP4 軌道計算 (120分鐘 x 30秒間隔)
    ↓
可見性篩選 (仰角 > 10°)
    ↓
分層門檻處理 (13.5°/11.25°/5.0°)
    ↓
D2/A4/A5 事件生成
    ↓
[運行時]
    ↓
事件驅動決策 → API 服務 → 前端視覺化
```

## 現有資料架構

### 預計算資料
- **軌道資料**: ~190MB，包含所有衛星 120 分鐘的位置（涵蓋完整軌道週期）
- **可見衛星**: 同時約 20-30 顆對 NTPU 可見
- **事件頻率**: 每小時約 10-15 次換手機會

### 儲存結構
```
/netstack/data/
├── phase0_precomputed_orbits.json    # 基礎軌道資料
├── phase0_data_summary.json          # 資料摘要
├── layered_phase0/                   # 分層分析結果
├── events/                           # D2/A4/A5 事件 (待實現)
│   └── ntpu_handover_events.json
└── scenes.csv                        # 場景參數表

```

## 技術決策

### 現階段技術選擇
- **資料格式**: JSON (簡單直接，適合 prototype)
- **預處理**: Docker build 時執行，避免運行時計算
- **決策邏輯**: 規則式 (基於事件類型和門檻)
- **快取層**: Redis (可選，用於加速查詢)

### 未來技術預留
- **資料格式**: Parquet (高壓縮率，適合大數據)
- **決策邏輯**: RL 模型 (自適應學習)
- **多場景**: 場景參數化架構
- **雲端部署**: Kubernetes 編排

## 關鍵實現細節

### 分層門檻系統
- **預備觸發**: 13.5° (開始評估換手選項)
- **執行門檻**: 11.25° (執行換手決策點)
- **臨界門檻**: 5.0° (緊急換手保障)

### 事件觸發邏輯
- **D2 事件**: elevation ≤ 7.0° (臨界 + 2°餘量)
- **A4 事件**: neighbor_elevation ≥ 11.25° AND rsrp > -110 dBm
- **A5 事件**: serving < 11.25° AND neighbor > 13.5°

## 實施優先順序

### 立即執行 (Phase 1-2)
1. 在 `build_with_phase0_data.py` 加入 D2/A4/A5 事件生成
2. 建立事件資料獨立儲存結構
3. 實現基本的事件 API 端點

### 短期目標 (Phase 3-4)
1. 完善規則式決策引擎
2. 建立 WebSocket 即時事件串流
3. 優化 Docker 建構流程

### 長期規劃 (Phase 5+)
1. 加入第二個場景驗證架構
2. 開始 RL 模型離線訓練
3. 評估雲端部署需求

## 預期成果

### 系統性能
- **事件檢測延遲**: < 50ms
- **D2 預警時間**: 90-120 秒
- **API 響應時間**: < 10ms (基於預計算)
- **Docker 建構時間**: < 5 分鐘

### 資料規模
- **衛星總數**: ~8,647 (Starlink + OneWeb)
- **可見衛星**: 20-30 顆/時刻
- **事件數量**: ~1,000 個/天
- **儲存需求**: < 250MB (含事件)

## 資料使用說明

### Phase 1 完成後
- ⏳ **3D 視覺化資料待更新**
  - 檔案：`/app/data/phase0_precomputed_orbits.json`
  - 內容：120 分鐘內所有衛星的位置數據
  - 用途：SimWorld 3D 衛星軌跡渲染
  - 狀態：需重新生成（原 96 分鐘版本已刪除）

### Phase 2 完成後
- ✅ **換手事件資料將就緒**
  - 檔案：`/app/data/events/ntpu_handover_events.json`
  - 內容：D2/A4/A5 事件時間序列
  - 用途：事件圖表顯示、決策觸發

所有資料皆為 JSON 格式，透過 Docker Volume 掛載，無需壓縮或切片處理。

---

最後更新: 2025-01-01
版本: 1.0.0