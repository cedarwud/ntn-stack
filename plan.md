## 映像檔建構階段的資料預處理整體流程

為了支援「場景導向自適應」的研究開發，在映像檔（container image）建構階段預先完成資料篩選與整理，並保留靈活切換座標的能力，建議採用以下多階段預處理架構與策略。

### 一、整體預處理流程概述

1. **資料匯入**  
   – 讀取多天的 Starlink、OneWeb TLE + JSON 歷史資料（SGP4 算得的時間序列軌跡＋RSRP 等電波指標）。  
2. **RAAN 覆蓋度與可見性計算**  
   – 基於 SGP4，每日或每小時批次計算衛星至地面所有待測座標的仰角、可見性、覆蓋時間窗口。  
3. **符合 3GPP HO 事件的篩選**  
   – 按 38.331 D2/A4/A5 事件定義，找出發生切換時序的時間戳。  
   – 為每一次切換事件，抓取對應的：  
     -  切換衛星 ID  
     -  事件前後 n 秒內的 RSRP/距離/仰角等特徵向量  
4. **多場景切換座標參數化**  
   – 建立「場景參數表」CSV，記錄每個場景代號與地理座標（lat, lon）。  
5. **資料輸出格式化**  
   – 以壓縮二進位檔或 Parquet 檔分別儲存：  
     1) 可見性時間窗口清單  
     2) 切換事件特徵向量序列  
     3) 場景參數表  
6. **映像檔打包**  
   – 映像檔內僅包含篩選後常用範圍資料；其餘歷史或大規模原始數據掛載外部 volume。

### 二、分階段詳述

階段 1：TLE→軌跡與可見性  
-  批次腳本（Python + Skyfield + SGP4）：  
  – 每日計算所有衛星到待分析格點的可見性片段（起迄時間、衛星ID）。  
  – 輸出「可見性索引」：`visibility_idx[scene_id][sat_id] = [(t0,t1), …]`。  
-  RAAN 覆蓋度可先離線完成，結果存 CSV。

階段 2：HO 事件篩選  
-  依照 38.331 D2/A4/A5 觸發條件（RSRP 閾值＋距離變化）  
  – 在可見性索引內搜尋符合條件的時間戳。  
  – 擷取上下游 T seconds 內的特徵：`[RSRP, distance, elevation]`。  
  – 輸出「切換事件資料集」：`handover_events.parquet`。

階段 3：場景參數化  
-  建立 `scenes.csv`：每行包含  
  `scene_id, scene_name, latitude, longitude`。  
-  於程式啟動時，讀取該檔決定後續篩選座標。

階段 4：映像檔內儲存策略  
-  內含：  
  1) `scenes.csv`  
  2) 對應常用場景（如預設四至五個）的可見性與切換事件子集。  
-  外掛：  
  – 全量歷史資料放置於 volume 或雲端 bucket，僅於需要時讀取。  
  – 避免映像檔體積過大。

### 三、座標切換與場景自適應

1. **場景選擇接口**  
   – 前端 React 選擇 `scene_id` → 傳送至後端。  
2. **後端動態載入**  
   – 讀取 `scenes.csv` 獲得 `latitude, longitude`。  
   – 根據該場景，從預處理輸出裡篩選「對應地點附近可見衛星」與「該場景切換事件」。  
3. **RL Agent 啟動**  
   – 載入對應場景的 `visibility_idx` 與 `handover_events`，交給 Agent 模組即時使用。  
4. **預留擴展**  
   – 採用參數化函式：`load_scene_data(scene_id)`，未來新增場景只需更新 CSV，不用改程式碼。

### 四、建議與注意事項

- **檔案大小與效率**  
  – 對於歷史多天資料，可考慮 Parquet + Snappy 壓縮；非核心場景直接外掛。  
  – 篩選後輸出常用場景子集，確保映像檔體積控制在百 MB 內。  
- **可擴展設計**  
  – 所有資料讀寫都透過統一的 DataLoader 介面，利於未來切換資料庫或雲端儲存。  
- **版本管理**  
  – 每次 TLE 更新後，只需重跑預處理腳本，不影響映像檔版本。  
- **日後 RL 訓練**  
  – 預處理階段無需針對 RL 訓練做標籤；只需確保切換事件特徵完整、時序一致。

如此分層、多階段的預處理流程，既能確保映像檔的精簡與可掛載性，又能靈活支援「場景導向自適應」所需的地理座標篩選與切換事件資料。此架構將為後續強化學習和 3D 動畫渲染打下堅實基礎，並最大程度降低未來維護與擴充的成本。