# Phase 3 ç”Ÿç”¢ç’°å¢ƒé…ç½®
# Blue-Green éƒ¨ç½²å’Œç›£æ§ç³»çµ±é…ç½®

# Blue-Green éƒ¨ç½²é…ç½®
deployment:
  strategy: "blue-green"
  environments:
    blue:
      namespace: "ntn-blue"
      label_selector: "environment=blue"
    green:
      namespace: "ntn-green" 
      label_selector: "environment=green"
  
  # æœå‹™é…ç½®
  services:
    netstack:
      image: "ntn-stack/netstack"
      tag: "latest"
      port: 8080
      replicas: 2
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
        limits:
          cpu: "2000m"
          memory: "4Gi"
      health_check:
        endpoint: "/api/v1/health"
        initial_delay: 30
        timeout: 10
        retries: 3
        interval: 10
      environment:
        CUDA_VISIBLE_DEVICES: "-1"
        PYTHONUNBUFFERED: "1"
        
    simworld:
      image: "ntn-stack/simworld"
      tag: "latest"
      port: 8000
      replicas: 1
      resources:
        requests:
          cpu: "1000m"
          memory: "2Gi"
        limits:
          cpu: "4000m"
          memory: "8Gi"
      health_check:
        endpoint: "/health"
        initial_delay: 45
        timeout: 15
        retries: 3
        interval: 15
      environment:
        CUDA_VISIBLE_DEVICES: "-1"
        PYOPENGL_PLATFORM: "egl"
        DATABASE_URL: "postgresql+asyncpg://user:password@postgis:5432/appdb"
        
    frontend:
      image: "ntn-stack/frontend"
      tag: "latest"
      port: 5173
      replicas: 2
      resources:
        requests:
          cpu: "200m"
          memory: "512Mi"
        limits:
          cpu: "1000m"
          memory: "2Gi"
      health_check:
        endpoint: "/"
        initial_delay: 20
        timeout: 5
        retries: 3
        interval: 10
      environment:
        VITE_GATEWAY_URL: "http://gateway:8080"
        VITE_API_BASE_URL: "http://simworld:8000"

  # è² è¼‰å‡è¡¡å™¨é…ç½®
  load_balancer:
    type: "nginx"
    initial_weights:
      blue: 100
      green: 0
    switch_strategy: "gradual" # gradual, immediate
    switch_stages:
      - blue: 90
        green: 10   # Stage 1
      - blue: 70
        green: 30   # Stage 2
      - blue: 50
        green: 50   # Stage 3
      - blue: 20
        green: 80   # Stage 4
      - blue: 0
        green: 100  # Stage 5
    stage_duration: 30 # seconds
    
  # éƒ¨ç½²æµç¨‹é…ç½®
  process:
    preparation_timeout: 300    # 5 minutes
    health_check_timeout: 600   # 10 minutes
    switch_timeout: 300         # 5 minutes
    stabilization_period: 600   # 10 minutes
    rollback_timeout: 180       # 3 minutes

# ç›£æ§é…ç½®
monitoring:
  # æ•¸æ“šæ”¶é›†
  collection:
    interval: 10               # æŒ‡æ¨™æ”¶é›†é–“éš” (ç§’)
    retention_days: 30         # æ•¸æ“šä¿ç•™å¤©æ•¸
    export_prometheus: true    # å°å‡º Prometheus æ ¼å¼
    
  # å‘Šè­¦è©•ä¼°
  alerting:
    evaluation_interval: 30    # å‘Šè­¦è©•ä¼°é–“éš” (ç§’)
    group_wait: 60            # å‘Šè­¦åˆ†çµ„ç­‰å¾…æ™‚é–“ (ç§’)
    group_interval: 300       # å‘Šè­¦åˆ†çµ„é–“éš” (ç§’)
    repeat_interval: 3600     # å‘Šè­¦é‡è¤‡é–“éš” (ç§’)
    
  # é€šçŸ¥é…ç½®
  notifications:
    email:
      enabled: true
      smtp_server: "smtp.example.com"
      smtp_port: 587
      username: "alerts@ntn-stack.com"
      password: "${SMTP_PASSWORD}"
      recipients:
        - "ops-team@ntn-stack.com"
        - "dev-team@ntn-stack.com"
      templates:
        alert: |
          ğŸš¨ NTN Stack ç”Ÿç”¢å‘Šè­¦
          
          ç’°å¢ƒ: {{ .environment }}
          æœå‹™: {{ .service }}
          åš´é‡ç¨‹åº¦: {{ .severity }}
          
          å‘Šè­¦è©³æƒ…:
          {{ .message }}
          
          é–‹å§‹æ™‚é–“: {{ .started_at }}
          
        resolution: |
          âœ… NTN Stack å‘Šè­¦å·²è§£æ±º
          
          ç’°å¢ƒ: {{ .environment }}
          æœå‹™: {{ .service }}
          
          è§£æ±ºæ™‚é–“: {{ .resolved_at }}
          æŒçºŒæ™‚é–“: {{ .duration }}
          
    webhook:
      enabled: true
      url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
      timeout: 10
      retries: 3
      
    pagerduty:
      enabled: false
      integration_key: "${PAGERDUTY_KEY}"
      
# SLA å’Œé–¾å€¼é…ç½®
sla:
  # Phase 3 ç”Ÿç”¢ç’°å¢ƒ SLA è¦æ±‚
  requirements:
    error_rate_threshold: 0.001        # éŒ¯èª¤ç‡ < 0.1%
    handover_success_rate: 0.995       # Handover æˆåŠŸç‡ > 99.5%
    handover_latency_ms: 50.0          # Handover å»¶é² < 50ms
    system_availability: 0.999         # ç³»çµ±å¯ç”¨æ€§ > 99.9%
    response_time_ms: 100.0            # API éŸ¿æ‡‰æ™‚é–“ < 100ms
    
  # ç›£æ§é–¾å€¼
  thresholds:
    # ç³»çµ±è³‡æº
    system:
      cpu_usage_warning: 0.7          # CPU ä½¿ç”¨ç‡è­¦å‘Šé–¾å€¼ 70%
      cpu_usage_critical: 0.8         # CPU ä½¿ç”¨ç‡åš´é‡é–¾å€¼ 80%
      memory_usage_warning: 0.7       # è¨˜æ†¶é«”ä½¿ç”¨ç‡è­¦å‘Šé–¾å€¼ 70%
      memory_usage_critical: 0.8      # è¨˜æ†¶é«”ä½¿ç”¨ç‡åš´é‡é–¾å€¼ 80%
      disk_usage_warning: 0.8         # ç£ç¢Ÿä½¿ç”¨ç‡è­¦å‘Šé–¾å€¼ 80%
      disk_usage_critical: 0.9        # ç£ç¢Ÿä½¿ç”¨ç‡åš´é‡é–¾å€¼ 90%
      
    # æ‡‰ç”¨æ€§èƒ½
    application:
      response_time_warning: 80.0      # éŸ¿æ‡‰æ™‚é–“è­¦å‘Šé–¾å€¼ 80ms
      response_time_critical: 100.0    # éŸ¿æ‡‰æ™‚é–“åš´é‡é–¾å€¼ 100ms
      error_rate_warning: 0.0005      # éŒ¯èª¤ç‡è­¦å‘Šé–¾å€¼ 0.05%
      error_rate_critical: 0.001      # éŒ¯èª¤ç‡åš´é‡é–¾å€¼ 0.1%
      throughput_min: 100             # æœ€å°ååé‡ 100 RPS
      
    # NTN ç‰¹å®šæŒ‡æ¨™
    ntn:
      handover_latency_warning: 40.0   # Handover å»¶é²è­¦å‘Šé–¾å€¼ 40ms
      handover_latency_critical: 50.0  # Handover å»¶é²åš´é‡é–¾å€¼ 50ms
      handover_success_warning: 0.996  # Handover æˆåŠŸç‡è­¦å‘Šé–¾å€¼ 99.6%
      handover_success_critical: 0.995 # Handover æˆåŠŸç‡åš´é‡é–¾å€¼ 99.5%
      active_ue_min: 5                # æœ€å°æ´»èº UE æ•¸é‡
      satellite_connectivity_min: 2    # æœ€å°è¡›æ˜Ÿé€£æ¥æ•¸
      
    # å¾®æœå‹™å¥åº·
    microservices:
      service_down_duration: 30        # æœå‹™ä¸‹ç·šå‘Šè­¦æ™‚é–“ 30s
      circuit_breaker_open_duration: 60 # æ–·è·¯å™¨é–‹å•Ÿå‘Šè­¦æ™‚é–“ 60s
      health_check_failure_count: 3    # å¥åº·æª¢æŸ¥å¤±æ•—æ¬¡æ•¸é–¾å€¼
      
# å‘Šè­¦è¦å‰‡é…ç½®
alert_rules:
  # ç³»çµ±ç´šå‘Šè­¦
  - name: "high_cpu_usage"
    metric: "system_cpu_usage"
    condition: ">"
    warning_threshold: 0.7
    critical_threshold: 0.8
    duration: 300  # 5 minutes
    description: "ç³»çµ± CPU ä½¿ç”¨ç‡éé«˜"
    runbook_url: "https://wiki.ntn-stack.com/runbooks/high-cpu"
    
  - name: "high_memory_usage"
    metric: "system_memory_usage" 
    condition: ">"
    warning_threshold: 0.7
    critical_threshold: 0.8
    duration: 300
    description: "ç³»çµ±è¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜"
    runbook_url: "https://wiki.ntn-stack.com/runbooks/high-memory"
    
  # æ‡‰ç”¨ç´šå‘Šè­¦
  - name: "high_error_rate"
    metric: "http_error_rate"
    condition: ">"
    warning_threshold: 0.0005
    critical_threshold: 0.001
    duration: 120  # 2 minutes
    description: "HTTP éŒ¯èª¤ç‡è¶…é SLA é–¾å€¼"
    runbook_url: "https://wiki.ntn-stack.com/runbooks/high-error-rate"
    
  - name: "high_response_time"
    metric: "http_request_duration_ms"
    condition: ">"
    warning_threshold: 80.0
    critical_threshold: 100.0
    duration: 180  # 3 minutes
    description: "API éŸ¿æ‡‰æ™‚é–“éæ…¢"
    runbook_url: "https://wiki.ntn-stack.com/runbooks/slow-response"
    
  # NTN ç‰¹å®šå‘Šè­¦
  - name: "handover_sla_violation"
    metric: "handover_latency_ms"
    condition: ">"
    warning_threshold: 40.0
    critical_threshold: 50.0
    duration: 60   # 1 minute
    description: "Handover å»¶é²è¶…é SLA è¦æ±‚"
    runbook_url: "https://wiki.ntn-stack.com/runbooks/handover-latency"
    
  - name: "low_handover_success_rate"
    metric: "handover_success_rate"
    condition: "<"
    warning_threshold: 0.996
    critical_threshold: 0.995
    duration: 60
    description: "Handover æˆåŠŸç‡ä½æ–¼ SLA è¦æ±‚"
    runbook_url: "https://wiki.ntn-stack.com/runbooks/handover-failures"
    
  - name: "satellite_connectivity_loss"
    metric: "active_satellites"
    condition: "<"
    warning_threshold: 3
    critical_threshold: 2
    duration: 30
    description: "è¡›æ˜Ÿé€£æ¥æ•¸é‡ä¸è¶³"
    runbook_url: "https://wiki.ntn-stack.com/runbooks/satellite-connectivity"
    
  # æœå‹™å¥åº·å‘Šè­¦
  - name: "service_down"
    metric: "service_up"
    condition: "=="
    warning_threshold: 0.5
    critical_threshold: 0
    duration: 30
    description: "å¾®æœå‹™ä¸å¯ç”¨"
    runbook_url: "https://wiki.ntn-stack.com/runbooks/service-down"
    
  - name: "circuit_breaker_open"
    metric: "circuit_breaker_open"
    condition: "=="
    critical_threshold: 1
    duration: 60
    description: "æ–·è·¯å™¨è™•æ–¼é–‹å•Ÿç‹€æ…‹"
    runbook_url: "https://wiki.ntn-stack.com/runbooks/circuit-breaker"

# æ¸¬è©¦å’Œé©—è­‰é…ç½®  
testing:
  # E2E æ¸¬è©¦å¥—ä»¶
  e2e_tests:
    - name: "ue_attachment_flow"
      description: "UE è¨»å†Šæµç¨‹æ¸¬è©¦"
      timeout: 120
      sla_requirement: true
      
    - name: "conditional_handover_e2e"
      description: "æ¢ä»¶åˆ‡æ›ç«¯åˆ°ç«¯æ¸¬è©¦"
      timeout: 60
      sla_requirement: true
      critical: true
      
    - name: "multi_satellite_coordination"
      description: "å¤šè¡›æ˜Ÿå”èª¿æ¸¬è©¦"
      timeout: 180
      sla_requirement: true
      
    - name: "failover_recovery"
      description: "æ•…éšœæ¢å¾©æ¸¬è©¦"
      timeout: 300
      sla_requirement: false
      
    - name: "performance_benchmark"
      description: "æ€§èƒ½åŸºæº–æ¸¬è©¦"
      timeout: 600
      sla_requirement: true
      
  # è² è¼‰æ¸¬è©¦
  load_testing:
    enabled: true
    duration: 300          # 5 minutes
    concurrent_users: 100
    ramp_up_time: 60      # 1 minute
    target_rps: 500
    
  # æ··æ²Œå·¥ç¨‹
  chaos_engineering:
    enabled: false         # ç”Ÿç”¢ç’°å¢ƒè¬¹æ…å•Ÿç”¨
    scenarios:
      - name: "pod_failure"
        frequency: "weekly"
        targets: ["netstack", "simworld"]
      - name: "network_latency"
        frequency: "monthly"
        duration: 300

# å®‰å…¨é…ç½®
security:
  # ç¶²è·¯æ”¿ç­–
  network_policies:
    enabled: true
    default_deny: true
    allowed_ingress:
      - from_namespaces: ["ingress-nginx"]
        to_ports: [80, 443]
      - from_services: ["monitoring"]
        to_ports: [8080, 8000, 5173]
        
  # æœå‹™ç¶²æ ¼ (å¦‚æœä½¿ç”¨ Istio)
  service_mesh:
    enabled: false
    mtls_mode: "STRICT"
    
  # å¯†é‘°ç®¡ç†
  secrets:
    rotation_days: 90
    encryption_at_rest: true
    
# å‚™ä»½å’Œç½é›£æ¢å¾©
backup:
  # æ•¸æ“šåº«å‚™ä»½
  database:
    enabled: true
    schedule: "0 2 * * *"    # æ¯æ—¥ 2:00 AM
    retention_days: 30
    encryption: true
    
  # é…ç½®å‚™ä»½
  configuration:
    enabled: true
    schedule: "0 1 * * 0"    # æ¯é€±æ—¥ 1:00 AM
    retention_weeks: 12
    
  # ç½é›£æ¢å¾©
  disaster_recovery:
    rto_minutes: 60          # Recovery Time Objective: 1 hour
    rpo_minutes: 15          # Recovery Point Objective: 15 minutes
    backup_regions: ["us-west-2", "eu-west-1"]

# æ—¥èªŒé…ç½®
logging:
  # æ—¥èªŒç­‰ç´š
  level: "INFO"
  
  # çµæ§‹åŒ–æ—¥èªŒ
  structured: true
  format: "json"
  
  # æ—¥èªŒèšåˆ
  aggregation:
    enabled: true
    backend: "elasticsearch"  # elasticsearch, splunk, datadog
    retention_days: 90
    
  # æ—¥èªŒè¦å‰‡
  rules:
    - pattern: "ERROR|CRITICAL"
      action: "alert"
      severity: "high"
    - pattern: "handover.*failed"
      action: "alert" 
      severity: "critical"
    - pattern: "sla.*violation"
      action: "alert"
      severity: "critical"

# è‡ªå‹•ç¸®æ”¾é…ç½®
autoscaling:
  # æ°´å¹³ Pod è‡ªå‹•ç¸®æ”¾
  hpa:
    enabled: true
    min_replicas: 2
    max_replicas: 10
    target_cpu_utilization: 70
    target_memory_utilization: 80
    
  # å‚ç›´ Pod è‡ªå‹•ç¸®æ”¾
  vpa:
    enabled: true
    update_mode: "Auto"
    
  # å¢é›†è‡ªå‹•ç¸®æ”¾
  cluster_autoscaler:
    enabled: true
    min_nodes: 3
    max_nodes: 20
    scale_down_delay: "10m"

# åˆè¦æ€§å’Œå¯©è¨ˆ
compliance:
  # å¯©è¨ˆæ—¥èªŒ
  audit_logging:
    enabled: true
    retention_days: 365
    
  # è³‡æ–™éš±ç§
  data_privacy:
    pii_scrubbing: true
    encryption_at_rest: true
    encryption_in_transit: true
    
  # æ³•è¦éµå¾ª
  regulations:
    - "GDPR"
    - "CCPA"
    - "SOC2"

# ç’°å¢ƒç‰¹å®šé…ç½®
environments:
  staging:
    replicas_multiplier: 0.5
    resources_multiplier: 0.5
    monitoring_interval: 30
    
  production:
    replicas_multiplier: 1.0
    resources_multiplier: 1.0
    monitoring_interval: 10
    high_availability: true
    
  development:
    replicas_multiplier: 0.2
    resources_multiplier: 0.2
    monitoring_interval: 60
    debug_mode: true