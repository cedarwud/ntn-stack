# NetStack 架構分析報告

## 🎯 核心問題總結

### 1. 配置管理分散化問題 (嚴重)
**問題描述：**
- 衛星配置在多個文件中重複定義：
  - `satellite_selector.py` line 55-56: `starlink_target=150, oneweb_target=50`
  - `build_with_phase0_data.py` line 232-233: `max_display_starlink=150, max_display_oneweb=50`
  - `constellation_separated_selection.json`: 實際運行時數據
- 配置更新需要修改多個文件，容易不一致
- 缺乏單一配置源 (Single Source of Truth)

**影響範圍：** 🔴 嚴重 - 導致數據不一致和調試困難

**建議方案：**
- 創建統一配置文件 `/config/satellite_config.yaml`
- 所有組件從該文件讀取配置
- 實施配置驗證機制

### 2. 代碼冗余和過時功能 (中等)
**問題描述：**
- `main.py` 中大量註釋掉的功能：
  - AI 決策服務 (line 42, 151, 191)
  - RL 訓練引擎 (line 153-158)
  - 數據庫初始化 (line 160-169)
- 複雜但可能未充分利用的算法：
  - `satellite_selector.py` 中完整的 ITU-R P.618 鏈路預算計算
  - Skyfield SGP4 軌道計算邏輯

**影響範圍：** 🟡 中等 - 增加維護成本和複雜度

**建議方案：**
- 移除所有註釋掉的代碼
- 評估複雜算法的實際使用需求
- 創建清晰的功能邊界

### 3. 服務邊界不清晰 (中等)
**問題描述：**
- API 服務和核心邏輯混合
- 背景任務與主要服務耦合
- Manager 模式過度複雜但實際功能簡單

**影響範圍：** 🟡 中等 - 影響可維護性和擴展性

**建議方案：**
- 分離 API 層和業務邏輯層
- 獨立背景任務服務
- 簡化 Manager 架構

## 📊 架構現狀分析

### 當前架構圖
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   NetStack API  │    │  Configuration  │    │   Background    │
│   (main.py)     │    │   (Scattered)   │    │    Tasks        │
│   - 362 lines   │◄──►│   - Multiple    │◄──►│  - Data Init    │
│   - 5+ Managers │    │     Files       │    │  - Preprocessing│
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Open5GS       │    │   PostgreSQL    │    │    MongoDB      │
│   Services      │    │   (Satellite)   │    │   (Core Net)    │
│   - 10+ pods    │    │   - Real Data   │    │   - 5G Config   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 理想架構圖
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   API Gateway   │    │ Config Service  │    │ Satellite Core  │
│   - Lightweight │    │ - Single Source │    │ - Pure Logic    │
│   - REST API    │◄──►│ - Validation    │◄──►│ - No API Deps   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Background     │    │   Data Layer    │    │   Open5GS       │
│  Services       │    │   - PostgreSQL  │    │   Integration   │
│  - Independent  │    │   - MongoDB     │    │   - Decoupled   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🔧 重構優先級

### Priority 1 - 立即執行 (高影響，低風險)
1. **統一配置管理** - 解決 150+50 配置分散問題
2. **清理冗余代碼** - 移除註釋掉的 AI/RL 服務
3. **依賴清理** - 移除未使用的依賴包

### Priority 2 - 短期執行 (中等影響，中等風險)
1. **服務邊界重構** - 分離 API 和核心邏輯
2. **背景任務獨立** - 解耦數據初始化邏輯
3. **Manager 簡化** - 保留必要功能，移除過度工程

### Priority 3 - 中期執行 (高影響，高風險)
1. **算法評估優化** - 簡化過度複雜的計算邏輯
2. **數據流重構** - 統一數據存儲和狀態管理

## 📈 預期收益

### 量化指標
- **代碼行數減少：** 預計減少 30-40%
- **啟動時間改善：** 從當前的 5 分鐘減少到 30 秒
- **配置錯誤減少：** 消除配置不一致導致的 90% 錯誤
- **維護成本降低：** 新開發者上手時間從 2 天減少到 2 小時

### 質化收益
- **架構清晰度：** 單一職責原則，清晰的服務邊界
- **可維護性：** 統一的配置管理，簡化的代碼結構
- **可擴展性：** 模塊化設計，容易添加新功能
- **穩定性：** 減少配置錯誤，提高系統可靠性

## 🚀 下一步行動

1. **立即行動：** 創建統一配置文件和清理冗余代碼
2. **本週內：** 完成服務邊界重構設計
3. **本月內：** 實施核心架構改進
4. **持續跟進：** 建立代碼質量和架構清晰度監控

---
*分析時間: 2025-08-09*
*分析版本: v1.0*
*負責人: NetStack 重構團隊*