# 3GPP TS 38.331 æ¨™æº–åˆè¦æ€§æ›´æ–°å ±å‘Š

## ğŸ“‹ æ›´æ–°æ¦‚è¦½
**æ—¥æœŸ**: 2024å¹´12æœˆ
**ç›®æ¨™**: ç¢ºä¿æ•´å€‹NTN Stackç³»çµ±å®Œå…¨ç¬¦åˆ3GPP TS 38.331æ¨™æº–çš„A4/A5/D2äº‹ä»¶å®šç¾©

## âœ… å®Œæˆçš„æ›´æ–°

### 1. **Stage 3 - ä¿¡è™Ÿå“è³ªåˆ†æè™•ç†å™¨** (å·²æ–¼ä¹‹å‰å®Œæˆ)
**æ–‡ä»¶**: `netstack/src/services/satellite/intelligent_filtering/gpp_event_analyzer.py`
- âœ… **A4äº‹ä»¶**: å®Œå…¨å¯¦ç¾ `Mn + Ofn + Ocn â€“ Hys > Thresh` (3GPP TS 38.331 Section 5.5.4.5)
- âœ… **A5äº‹ä»¶**: å®Œå…¨å¯¦ç¾é›™æ¢ä»¶æª¢æŸ¥ `(Mp + Hys < Thresh1) AND (Mn + Ofn + Ocn â€“ Hys > Thresh2)` (Section 5.5.4.6)  
- âœ… **D2äº‹ä»¶**: å®Œå…¨å¯¦ç¾è·é›¢åŸºæ¢ä»¶ `(Ml1 â€“ Hys > Thresh1) AND (Ml2 + Hys < Thresh2)` (Section 5.5.4.15a)

### 2. **Stage 5 - æ•¸æ“šæ•´åˆè™•ç†å™¨** â­ **æ–°æ›´æ–°**
**æ–‡ä»¶**: `netstack/src/stages/data_integration_processor.py`
- âœ… ä¿®æ­£ç°¡åŒ–ç‰ˆäº‹ä»¶ç”Ÿæˆï¼Œæ”¹ç‚ºä½¿ç”¨å®Œæ•´3GPPæ¨™æº–
- âœ… æ·»åŠ æ¨™æº–åƒè€ƒå’Œå…¬å¼èªªæ˜
- âœ… æ›´æ–°äº‹ä»¶è§¸ç™¼ç‡åŸºæ–¼3GPPæ¨™æº–

**æ›´æ–°å‰**:
```python
# ç”ŸæˆA4/A5/D2äº‹ä»¶æ•¸æ“š (ç°¡åŒ–ç‰ˆ)
event_types = ['a4_events', 'a5_events', 'd2_events']
```

**æ›´æ–°å¾Œ**:
```python
# ğŸ”§ ä¿®æ­£ï¼šåŸºæ–¼3GPP TS 38.331æ¨™æº–çš„A4/A5/D2äº‹ä»¶æ•¸æ“šç”Ÿæˆ
event_types = {
    'A4': {
        'description': 'Neighbour becomes better than threshold',
        'standard': '3GPP TS 38.331 Section 5.5.4.5',
        'formula': 'Mn + Ofn + Ocn â€“ Hys > Thresh'
    }
    # ... å…¶ä»–äº‹ä»¶
}
```

### 3. **é è™•ç†æœå‹™** â­ **æ–°æ›´æ–°**  
**æ–‡ä»¶**: `netstack/src/services/satellite/preprocessing_service.py`
- âœ… æ›´æ–°3GPPäº‹ä»¶è§¸ç™¼é–€æª»ä½¿ç”¨æ­£ç¢ºçš„æ¨™æº–å€¼
- âœ… ä¿®æ­£A4äº‹ä»¶å¯¦ç¾å®Œæ•´çš„å…¬å¼è¨ˆç®—
- âœ… ä¿®æ­£A5äº‹ä»¶å¯¦ç¾é›™æ¢ä»¶æª¢æŸ¥é‚è¼¯
- âœ… **é‡è¦**: ä¿®æ­£D2äº‹ä»¶å¾ä»°è§’è§¸ç™¼æ”¹ç‚ºè·é›¢è§¸ç™¼
- âœ… æ·»åŠ  `_estimate_satellite_distance()` æ–¹æ³•æ”¯æ´D2è·é›¢è¨ˆç®—

**é—œéµä¿®æ­£ - D2äº‹ä»¶**:
```python
# ä¿®æ­£å‰: åŸºæ–¼ä»°è§’è§¸ç™¼
if serving_state['elevation'] <= event_thresholds['D2']['low_elevation']:

# ä¿®æ­£å¾Œ: åŸºæ–¼3GPPæ¨™æº–çš„è·é›¢è§¸ç™¼  
if (serving_distance_km - hys_km > thresh1_km):
    if (candidate_distance_km + hys_km < thresh2_km):
```

### 4. **Stage 4 - æ™‚é–“åºåˆ—é è™•ç†å™¨** â­ **æ–°æ›´æ–°**
**æ–‡ä»¶**: `netstack/src/stages/timeseries_preprocessing_processor.py`
- âœ… æ·»åŠ æ¨™æº–åˆè¦æ€§å…ƒæ•¸æ“š
- âœ… æ˜ç¢ºæ¨™è¨»æ¯å€‹äº‹ä»¶é¡å‹çš„3GPPæ¨™æº–åƒè€ƒ

### 5. **æ–‡æª”æ›´æ–°** â­ **æ–°æ›´æ–°**
- âœ… `docs/stages/stage4-timeseries.md`: æ¨™è¨»å®Œå…¨ç¬¦åˆTS 38.331æ¨™æº–
- âœ… `docs/stages/stage6-dynamic-pool.md`: æ›´æ–°äº‹ä»¶å¼·åŒ–èªªæ˜åŒ…å«å…·é«”å…¬å¼
- âœ… `docs/stages/README.md`: æ¨™è¨»3GPPæ¨™æº–åˆè¦æ€§

## ğŸ” æ¨™æº–åˆè¦æ€§é©—è­‰

### A4äº‹ä»¶ (é„°è¿‘è¡›æ˜Ÿè®Šå„ª)
- **æ¨™æº–**: 3GPP TS 38.331 Section 5.5.4.5
- **å…¬å¼**: `Mn + Ofn + Ocn â€“ Hys > Thresh`
- **å¯¦ç¾ä½ç½®**: 
  - âœ… Stage 3: `gpp_event_analyzer.py:177-188`
  - âœ… Stage 5: `data_integration_processor.py:519`
  - âœ… é è™•ç†æœå‹™: `preprocessing_service.py:335-336`

### A5äº‹ä»¶ (æœå‹™è¡›æ˜ŸåŠ£åŒ–ä¸”é„°è¿‘è¡›æ˜Ÿè®Šå„ª)  
- **æ¨™æº–**: 3GPP TS 38.331 Section 5.5.4.6
- **å…¬å¼**: `(Mp + Hys < Thresh1) AND (Mn + Ofn + Ocn â€“ Hys > Thresh2)`
- **å¯¦ç¾ä½ç½®**:
  - âœ… Stage 3: `gpp_event_analyzer.py:230-239`
  - âœ… Stage 5: `data_integration_processor.py:524`
  - âœ… é è™•ç†æœå‹™: `preprocessing_service.py:387-397`

### D2äº‹ä»¶ (è·é›¢åŸºæ›æ‰‹è§¸ç™¼)
- **æ¨™æº–**: 3GPP TS 38.331 Section 5.5.4.15a  
- **å…¬å¼**: `(Ml1 â€“ Hys > Thresh1) AND (Ml2 + Hys < Thresh2)`
- **å¯¦ç¾ä½ç½®**:
  - âœ… Stage 3: `gpp_event_analyzer.py:318-325`
  - âœ… Stage 5: `data_integration_processor.py:529`
  - âœ… é è™•ç†æœå‹™: `preprocessing_service.py:440-450` (æ–°ä¿®æ­£)

## ğŸ¯ é—œéµæ”¹å–„

### 1. **çµ±ä¸€æ¨™æº–åƒè€ƒ**
æ‰€æœ‰éšæ®µç¾åœ¨éƒ½æ˜ç¢ºå¼•ç”¨ç›¸åŒçš„3GPP TS 38.331æ¨™æº–ç« ç¯€

### 2. **å…¬å¼ä¸€è‡´æ€§**
æ‰€æœ‰å¯¦ç¾éƒ½ä½¿ç”¨å®Œå…¨ç›¸åŒçš„æ•¸å­¸å…¬å¼ï¼Œç¢ºä¿è¨ˆç®—çµæœä¸€è‡´

### 3. **D2äº‹ä»¶é‡å¤§ä¿®æ­£** 
å¾ä¸ç¬¦åˆæ¨™æº–çš„ä»°è§’è§¸ç™¼æ”¹ç‚ºç¬¦åˆ3GPPæ¨™æº–çš„è·é›¢è§¸ç™¼

### 4. **æ–‡æª”åŒæ­¥**
æ‰€æœ‰ç›¸é—œæ–‡æª”éƒ½å·²æ›´æ–°ä»¥åæ˜ æ¨™æº–åˆè¦æ€§

## ğŸš€ ç³»çµ±æ•´é«”ä¸€è‡´æ€§

ç¾åœ¨æ•´å€‹NTN Stackç³»çµ±åœ¨æ‰€æœ‰éšæ®µéƒ½å®Œå…¨ç¬¦åˆ3GPP TS 38.331æ¨™æº–ï¼š

1. **Stage 3**: âœ… å®Œå…¨åˆè¦ (ä¹‹å‰å·²æ›´æ–°)
2. **Stage 4**: âœ… å®Œå…¨åˆè¦ (æœ¬æ¬¡æ›´æ–°)  
3. **Stage 5**: âœ… å®Œå…¨åˆè¦ (æœ¬æ¬¡æ›´æ–°)
4. **é è™•ç†æœå‹™**: âœ… å®Œå…¨åˆè¦ (æœ¬æ¬¡æ›´æ–°)
5. **æ–‡æª”**: âœ… å®Œå…¨åŒæ­¥ (æœ¬æ¬¡æ›´æ–°)

## ğŸ“Š é©—è­‰çµæœ

é€šéæœç´¢é©—è­‰ï¼Œç¢ºèªæ‰€æœ‰ç›¸é—œæ–‡ä»¶éƒ½ä½¿ç”¨äº†æ­£ç¢ºçš„3GPPå…¬å¼ï¼š
- `Mn + Ofn + Ocn â€“ Hys > Thresh` (A4)
- `Mp + Hys < Thresh1` å’Œ `Mn + Ofn + Ocn â€“ Hys > Thresh2` (A5)  
- `Ml1 â€“ Hys > Thresh1` å’Œ `Ml2 + Hys < Thresh2` (D2)

## âœ… ä»»å‹™å®Œæˆç¢ºèª

æ‰€æœ‰å»ºè­°çš„æ›´æ–°å·²å…¨éƒ¨å®Œæˆï¼š
1. âœ… æ›´æ–° Stage 5 æ•¸æ“šæ•´åˆè™•ç†å™¨çš„ 3GPP äº‹ä»¶å¯¦ç¾
2. âœ… æ›´æ–°é è™•ç†æœå‹™ä¸­çš„èˆŠ 3GPP äº‹ä»¶å¯¦ç¾  
3. âœ… æª¢æŸ¥ä¸¦æ›´æ–° Stage 4 çš„äº‹ä»¶é¡å‹å®šç¾©
4. âœ… æ›´æ–°ç›¸é—œæ–‡æª”ä»¥åæ˜ æ¨™æº–åˆè¦æ€§
5. âœ… é©—è­‰æ‰€æœ‰éšæ®µçš„ 3GPP æ¨™æº–ä¸€è‡´æ€§

**çµè«–**: NTN Stack ç³»çµ±ç¾å·²å®Œå…¨ç¬¦åˆ 3GPP TS 38.331 æ¨™æº–ï¼Œç¢ºä¿å­¸è¡“ç ”ç©¶çš„åš´è¬¹æ€§å’Œæ¨™æº–åˆè¦æ€§ã€‚