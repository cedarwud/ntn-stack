# NTN-Stack 測量事件系統統一改進主準則

## 🎯 適用範圍

本準則適用於 NTN-Stack 中所有測量事件的系統性改進：
- **Event A4**: 信號強度測量事件
- **Event D1**: 雙重距離測量事件
- **Event D2**: 移動參考位置距離事件
- **Event T1**: 時間條件測量事件

> **注意**: A3、A5 事件暫不納入此次改進範圍

## 🔍 全系統問題分析

### ✅ 系統優勢
- **統一架構設計**: 所有事件共享一致的 UI 框架和配置模式
- **3GPP 標準引用**: 正確引用相關的 3GPP TS 38.331 標準章節
- **功能完整性**: 基本的事件邏輯和參數配置已實現
- **可視化品質**: 高品質的動畫解說和圖表渲染

### ❌ 系統性問題 (所有事件共同存在)

#### 1. **軌道計算引擎根本性缺陷** (Priority: CRITICAL)
**問題描述**: 所有事件使用模擬數據而非真實衛星軌道計算
```typescript
// 🚨 當前所有事件的共同問題
const getCurrentRSRP = (currentTime: number): number => {
    const baseRSRP = -65
    const variation = 15 * Math.sin((currentTime / 95) * 4 * Math.PI)  // ❌ 簡化模擬
    return baseRSRP + variation
}
```

**影響範圍**: 
- **A4**: RSRP 測量不反映真實衛星信號強度變化
- **D1**: 距離計算基於固定座標而非動態衛星位置
- **D2**: 移動參考位置計算完全錯誤
- **T1**: 時間觸發缺乏衛星時間同步考量

#### 2. **缺乏真實 TLE 衛星數據** (Priority: HIGH)
**標準要求**: 3GPP TS 38.331 要求基於 SIB19 廣播的衛星星曆數據
**當前狀況**: 使用簡化的圓形軌道模型，軌道週期等參數嚴重偏離實際

#### 3. **後端 API 支援不完整** (Priority: HIGH)
**發現**: 測量事件功能分散在不同服務中，缺乏統一的 API 端點
- ❌ 沒有 `/api/measurement-events/` 專用路由
- ❌ 沒有事件特定的數據處理服務
- ⚠️ 相關功能散布在性能、資源、軌道等不同服務中

#### 4. **參數驗證機制不統一** (Priority: MEDIUM)
各事件的參數檢查標準不一致，某些不合理設定未被攔截

#### 5. **缺乏簡易版/完整版模式** (Priority: MEDIUM)
當前所有事件都顯示完整的技術參數，對學習者來說過於複雜

## 📊 各事件 SIB19 依賴關係與標準合規度評估 🔄 重新定義

### **SIB19 依賴矩陣** (基於 3GPP 最新研究)
| 事件 | 星曆數據 | 時間同步 | 參考位置 | 鄰居配置 | 服務時間 | SIB19 依賴程度 |
|------|----------|----------|----------|----------|----------|---------------|
| **A4** | 增強使用 | **必要** | 輔助 | **必要** | 不需要 | **高度依賴** |
| **D1** | 輔助 | **必要** | **必要** (固定) | **必要** | 可選 | **高度依賴** |
| **D2** | **必要** | **必要** | **必要** (動態) | **必要** | 可選 | **完全依賴** |
| **T1** | 不需要 | **必要** | 不需要 | 可選 | **必要** | **中度依賴** |

### **標準合規度重新評估** (考慮 SIB19 整合)
| 事件 | 當前合規度 | SIB19 整合後預期 | 主要缺失 | 改進優先級 | 實施狀態 |
|------|------------|------------------|----------|-----------|----------|
| **A4** | 60% ❌ | **95%** ✅ | SIB19 位置補償機制 ΔS,T(t)、SMTC 整合 | **CRITICAL** 🔥 | 🔄 待實施 |
| **D1** | **95%** ✅ | **95%** ✅ | ~~SIB19 固定參考位置整合、全球化支援~~ | ~~HIGH~~ | ✅ **已完成** |
| **D2** | **98%** ✅ | **98%** ✅ | ~~SIB19 動態參考位置完整實現~~ | ~~CRITICAL~~ | ✅ **已完成** |
| **T1** | **95%** ✅ | **95%** ✅ | ~~SIB19 時間框架 (epochTime, t-Service) 整合~~ | ~~HIGH~~ | ✅ **已完成** |

### **核心發現**: A4 事件合規度重大修正
**原評估過低的原因**: 之前評估忽略了 A4 事件在 NTN 環境中對 SIB19 的**高度依賴性**：
- **位置補償機制** - A4 需要 SIB19 星曆數據計算 ΔS,T(t) 動態補償項
- **鄰居細胞管理** - 透過 ntn-NeighCellConfigList 獲取目標衛星配置
- **SMTC 深度整合** - 確保鄰居衛星可見時才進行測量，避免無效測量

## 🛰️ LEO 衛星切換論文研究數據真實性原則

### 🎯 **核心數據真實性要求** (絕對遵循)
**針對 LEO Satellite Handover 論文研究，所有影響切換決策的數據必須使用真實數據，確保研究成果達到頂級期刊發表標準。**

#### **✅ CRITICAL - 必須使用真實數據** (影響切換決策核心)
- **軌道動力學** - SGP4 算法 + 真實 TLE 數據 (CelesTrak/Space-Track) ✅ 已實現
- **衛星位置計算** - 基於真實軌道參數的毫秒級精確計算 ✅ 已實現  
- **幾何距離計算** - 真實地理坐標系統和軌道位置 ✅ 已實現
- **3GPP NTN 標準** - 完全按照 3GPP TS 38.331 精確實現 🔄 實現中

#### **⚠️ HIGH - 優先使用真實數據** (影響性能評估) 🆕 強化要求
- **信號強度模型** - 使用 ITU-R P.618、3GPP TR 38.811 標準模型 📋 新增需求
- **都卜勒頻移計算** - 基於真實軌道速度的精確計算 📋 新增需求
- **路徑損耗模型** - 採用國際標準而非簡化公式 📋 新增需求
- **電離層/對流層延遲** - 使用 Klobuchar 或 NeQuick 模型 📋 新增需求
- **天線增益模式** - 使用真實衛星和地面設備規格 📋 新增需求

#### **📊 MEDIUM - 可使用高品質模擬** (對切換影響較小)
- **大氣衰減** - 統計模型但基於真實氣象數據
- **干擾場景** - 統計模型但反映真實環境特徵  
- **網路負載** - 預設模式但基於真實流量分佈

### 🔬 **論文研究等級目標**
**🏆 頂級期刊級別** (90%+ 真實數據) - 可發表於 IEEE TCOM、TWC 等頂級期刊

#### **驗證要求**
- **與公開測量數據對比** - 驗證所有物理模型準確性
- **多工具交叉驗證** - 確保軌道和信號計算一致性
- **敏感度分析** - 量化模擬參數對結果的影響
- **不確定性標註** - 明確指出所有模擬部分的可信度範圍

## 🛠️ 統一技術解決方案

### 1. **軌道計算引擎重構** (系統級改進 + 數據真實性強化)

#### 目標架構
```typescript
interface OrbitCalculationEngine {
    // 真實 TLE 軌道計算
    calculateSatellitePosition(satelliteId: string, timestamp: number): SatellitePosition
    calculateDistance(satellitePos: SatellitePosition, uePos: Position): number
    calculateSignalStrength(distance: number, satelliteParams: SatelliteConfig): number
    
    // 軌道預測
    predictOrbitPath(satelliteId: string, timeRange: TimeRange): OrbitPath[]
    predictHandoverOpportunity(uePos: Position, timeWindow: number): HandoverPrediction[]
}
```

#### 技術規範 (論文研究級精度要求)
- **軌道模型**: SGP4 軌道傳播算法 (IEEE 標準，航太級精度)
- **TLE 數據源**: NORAD/CelesTrak/Space-Track 多重驗證數據源
- **更新頻率**: 每 12-24 小時自動更新軌道根數
- **位置精度**: < 1km (符合 NTN 切換研究要求)
- **信號傳播模型**: ITU-R P.618 標準 + 3GPP TR 38.811 NTN 路徑損耗
- **都卜勒計算**: 基於真實軌道速度，精度 < 100Hz
- **時間同步**: GNSS 時間基準，精度 < 50ms
- **電離層模型**: Klobuchar 或 NeQuick 國際標準模型

### 2. **統一後端 API 架構**

#### 新增測量事件服務
```python
# /app/domains/measurement/
measurement_event_service.py     # 主要業務邏輯
measurement_api.py              # REST API 端點
measurement_models.py           # 數據模型
measurement_validators.py       # 參數驗證
```

#### API 端點設計
```python
@router.get("/api/measurement-events/{event_type}/real-time-data")
async def get_real_time_measurement_data(
    event_type: EventType,
    params: EventParams,
    ue_position: Position
) -> MeasurementData:
    """基於真實軌道計算的實時測量數據"""
    
@router.post("/api/measurement-events/{event_type}/simulate")
async def simulate_measurement_event(
    event_type: EventType,
    scenario: SimulationScenario
) -> SimulationResult:
    """測量事件模擬和預測"""
```

### 3. **參數驗證和約束框架**

#### 統一驗證標準
```typescript
interface EventParameterConstraints {
    A4: {
        a4Threshold: { min: -100, max: -40, unit: 'dBm' }
        hysteresis: { min: 0, max: 10, unit: 'dB' }
        timeToTrigger: { values: [0, 40, 64, 80, 100, 128, 160, 256, 320, 480, 512, 640] }
    }
    D1: {
        thresh1: { min: 50, max: 50000, unit: 'meters' }
        thresh2: { min: 10, max: 10000, unit: 'meters' }
        hysteresis: { min: 1, max: 1000, unit: 'meters' }
    }
    D2: {
        thresh1: { min: 400000, max: 2000000, unit: 'meters' }  // 衛星距離
        thresh2: { min: 100, max: 50000, unit: 'meters' }      // 地面距離  
        hysteresis: { min: 100, max: 5000, unit: 'meters' }
    }
    T1: {
        t1Threshold: { min: 1, max: 3600, unit: 'seconds' }
        duration: { min: 1, max: 300, unit: 'seconds' }
    }
}
```

### 4. **簡易版/完整版 UI 統一設計**

#### 模式切換架構
```typescript
interface EventViewMode {
    mode: 'simple' | 'advanced'
    
    // 簡易版顯示內容
    simple: {
        showParameters: string[]      // 核心參數列表
        showTechnicalDetails: false
        showDebugging: false
        animationSpeed: 'normal'
    }
    
    // 完整版顯示內容  
    advanced: {
        showParameters: 'all'
        showTechnicalDetails: true
        showDebugging: true
        showStandardReferences: true
        enableTLEImport: true
        animationSpeed: 'configurable'
    }
}
```

## 📋 統一實施計劃

### Phase 0: 數據真實性強化 (1週) 🆕 論文研究基礎
**目標**: 將現有模擬數據升級為符合頂級期刊標準的真實數據模型

#### 0.1 信號傳播模型真實化 (3天)
- [ ] **ITU-R P.618 降雨衰減模型實現**
  - 整合真實氣象數據 API (OpenWeatherMap/ECMWF)
  - 實現頻率相關的降雨衰減計算
  - 添加地理位置相關的降雨率統計

- [ ] **3GPP TR 38.811 NTN 路徑損耗模型**
  - 替換簡化的距離衰減公式
  - 實現 NTN 特定的多路徑和陰影衰落
  - 考慮衛星天線增益和指向性

- [ ] **都卜勒頻移精確計算**
  - 基於 SGP4 軌道速度計算精確都卜勒
  - 考慮地球自轉和用戶移動效應
  - 實現頻率補償算法

#### 0.2 電離層和大氣效應模型 (2天)
- [ ] **Klobuchar 電離層延遲模型**
  - 整合 GPS 電離層參數
  - 實現頻率相關的延遲計算
  - 考慮太陽活動和地理位置影響

- [ ] **對流層延遲模型**
  - 實現標準大氣模型
  - 添加水汽和溫度相關修正
  - 考慮海拔高度和季節變化

#### 0.3 真實設備參數整合 (2天)
- [ ] **衛星天線增益圖**
  - 使用 Starlink/OneWeb 真實天線規格
  - 實現方向性增益計算
  - 考慮極化損失和指向誤差

- [ ] **地面設備特性**
  - 整合真實 UE 和基站規格
  - 實現設備相關的雜訊係數
  - 添加發射功率和接收靈敏度限制

### Phase 1: 基礎設施重構 (4週)
**目標**: 建立真實的軌道計算、SIB19 支援和後端統一服務

#### 1.1 軌道計算引擎開發 (2週) ✅ **已完成**
- [x] **整合 SGP4 軌道傳播算法** ✅
  - ✅ 安裝 `satellite-js` 或 `python-sgp4` 庫
  - ✅ 實現基於 TLE 的衛星位置計算
  - ✅ 建立軌道預測緩存機制

- [x] **TLE 數據管理系統** ✅
  - ✅ 建立 TLE 數據表和更新機制
  - ✅ 實現 Starlink/OneWeb 等星座 TLE 導入
  - ✅ 建立軌道數據驗證和錯誤處理

- [x] **信號傳播模型** ✅
  - ✅ 實現自由空間路徑損耗計算
  - ✅ 添加大氣和電離層效應
  - ✅ 考慮多普勒頻移和時間延遲

#### 1.1.1 SIB19 統一基礎平台開發 (1週) 🔥 重新定位
**核心理念**: SIB19 作為 **NTN 系統的統一資訊基礎平台**，為 A4、D1、D2、T1 等所有測量事件提供共享的時空基準和配置支援

- [ ] **SIB19 解析引擎 (全事件支援)**
  - 實現 3GPP TS 38.331 SIB19 完整數據結構解析
  - 支援 satelliteEphemeris、epochTime、referenceLocation、movingReferenceLocation
  - 整合 deltaGNSS_Time、t-Service、validityTime 等時間管理參數
  - 建立 SIB19 數據驗證和錯誤處理機制

- [ ] **統一位置計算系統**
  - **靜態參考位置** (referenceLocation) - 支援 D1 事件的固定參考點
  - **動態參考位置** (movingReferenceLocation) - 支援 D2 事件的衛星軌道計算
  - **位置補償引擎** - 支援 A4 事件的動態位置補償 ΔS,T(t)
  - 支援位置基準座標系統轉換和全球化地理計算

- [ ] **時頻校正統一系統**
  - 實現 GNSS 時間偏移補償 (精度 < 50ms)
  - 支援 Doppler 參數頻率校準
  - **絕對時間基準** (epochTime) - 支援 T1 事件的精確時間觸發
  - 建立時間同步監控和警報機制

- [ ] **鄰居細胞統一管理器** 🆕
  - 解析 `ntn-NeighCellConfigList` 和 `ntn-NeighCellConfigListExt`
  - 支援最多 8 個 NTN 鄰居細胞的並行配置和管理
  - 提供載波頻率 (carrierFreq) 和物理細胞識別碼 (physCellId) 對應
  - 支援個別衛星星曆或共用星曆的彈性配置機制
  - 實現跨事件類型的資訊共享，避免重複配置

- [ ] **SMTC 深度整合模組** 🆕
  - 實現 "SIB19 決定何時測量，SMTC 決定如何測量" 的雙核心架構
  - 基於衛星星曆計算鄰居衛星可見窗口
  - 動態調整 SMTC 視窗，提高測量效率和功耗優化
  - 避免在衛星不可見時進行無效測量

- [ ] **SIB19 生命週期管理**
  - 實現 validityTime 監控和自動更新
  - 支援 SIB19 廣播週期模擬 (數十秒到數分鐘)
  - 建立過期星曆檢測和警告系統
  - 支援高頻更新特性，避免過度信令負荷

- [ ] **多衛星星座管理器**
  - 支援同時追蹤 ≥4 顆可見衛星
  - 實現各衛星星曆分別 propagate
  - 支援「服務衛星落下→目標衛星升起」連續切換鏈模擬
  - 整合異構軌道管理 (LEO/MEO/GEO 混合星座)

#### 1.2 後端 API 統一建構 (1週)
- [ ] **測量事件服務模組**
  - 建立 `measurement_event_service.py`
  - 整合軌道服務和性能監控
  - 實現事件特定的數據處理邏輯

- [ ] **API 端點實現**
  - `/api/measurement-events/{event_type}/data` - 實時數據
  - `/api/measurement-events/{event_type}/simulate` - 事件模擬
  - `/api/measurement-events/config` - 參數配置管理

### Phase 1.5: 統一 SIB19 基礎圖表架構重新設計 (1週) 🔥 架構革新
**核心理念**: 實現 "資訊統一、應用分化" 的理想圖表架構 - 統一的 SIB19 基礎平台 + 事件特定的視覺化應用

#### 1.5.1 統一 SIB19 基礎平台分析設計 (3天)
- [ ] **當前圖表架構根本性問題分析**
  - **資訊孤島問題** - 各事件圖表獨立維護相似的軌道和時間數據
  - **重複配置浪費** - D1、D2、A4、T1 分別計算類似的衛星參數
  - **缺乏統一基準** - 時間同步、位置基準不一致，影響跨事件比較
  - **可擴展性差** - 新增事件需要重新實現基礎軌道和時間邏輯

- [ ] **統一 SIB19 基礎圖表平台設計** 🆕
  - **SIB19 統一數據層** - 所有事件圖表共享同一套 SIB19 解析和管理
  - **共享衛星星座視覺化** - 統一的衛星軌道、位置、時間基準展示
  - **鄰居細胞統一管理** - 支援最多 8 個鄰居細胞的統一配置和視覺化
  - **SMTC 整合的測量窗口管理** - 統一的可見性窗口和測量時機指示

- [ ] **事件特定的視覺化分化設計** 🆕
  - **A4 事件專屬**: 位置補償 ΔS,T(t) 視覺化、修正觸發條件展示
  - **D1 事件專屬**: 固定參考位置 (referenceLocation) 距離計算展示
  - **D2 事件專屬**: 動態參考位置 (movingReferenceLocation) 計算過程
  - **T1 事件專屬**: 時間框架 (epochTime, t-Service) 和計時器同步展示

- [ ] **統一圖表數據流架構重新設計**
  - **單一 SIB19 數據源** - 避免各事件重複維護軌道數據
  - **事件選擇性資訊萃取** - 根據事件類型選擇性使用 SIB19 資訊子集
  - **統一的 validityTime 管理** - 全局的星曆有效期監控和更新提醒
  - **共享的全球化地理支援** - 統一的座標系統和時區處理

#### 1.5.2 統一基礎元件 + 事件特定元件實現 (2天)
- [ ] **SIB19 統一基礎圖表元件** 🔄 重新定位
  - **統一 SIB19 狀態控制台** - 整合廣播狀態、有效期倒計時、更新提醒
  - **共享衛星星座管理面板** - 支援最多 8 個鄰居細胞的統一視覺化
  - **全域時間同步監控器** - 顯示 GNSS 時間同步精度和偏差狀態
  - **SMTC 測量窗口指示器** - 統一的可見性窗口和測量時機展示

- [ ] **事件特定視覺化元件**
  - **A4 位置補償計算器** - 視覺化 ΔS,T(t) 動態補償項計算
  - **D1 固定參考位置指示器** - referenceLocation 距離計算展示
  - **D2 動態參考位置追蹤器** - movingReferenceLocation 實時計算
  - **T1 時間框架管理器** - epochTime、t-Service 時間軸展示

- [ ] **全球化地理統一支援元件**
  - 實現任意參考位置設定介面 (支援 D1 全球化)
  - 創建全球地圖整合的軌道顯示 (所有事件共享)
  - 支援不同時區的時間顯示 (統一時間基準)

#### 1.5.3 統一平台整合測試 (2天)
- [ ] **統一 SIB19 基礎平台驗證**
  - 驗證所有事件共享統一 SIB19 數據源的正確性
  - 測試事件選擇性資訊萃取機制
  - 確保跨事件的資訊共享和功能互補正常運作

- [ ] **事件特定視覺化相容性測試**
  - 測試 A4 位置補償機制在統一平台上的正確性
  - 驗證 D1/D2 位置計算的數據一致性
  - 確認 T1 時間框架與全域時間同步的協調性

- [ ] **性能和可擴展性驗證**
  - 測試統一平台的渲染效能和記憶體使用
  - 驗證新架構的向後相容性
  - 確認未來新增事件的擴展性 (為 A3/A5 等準備)

### Phase 2: 各事件標準合規修正與圖表重新實現 (3週)
**目標**: 修正各事件的 3GPP 標準實現問題

#### 2.1 D2 事件優先修正與圖表重新實現 (5天) 🔥
- [ ] **移動參考位置邏輯修正**
  - 修正軌道週期從 120秒 → 90分鐘  
  - 實現基於 SIB19 的衛星星曆計算
  - 調整參數默認值 (Thresh2: 6km → 30km, Hys: 20m → 500m)

- [ ] **D2 圖表完整重新實現** 🆕
  - 實現 SIB19 廣播流程可視化 (gNB → UE 的週期廣播)
  - 展示 movingReferenceLocation 動態計算過程
  - 顯示真實的 90分鐘軌道週期和衛星位置
  - 加入星曆 validityTime 倒計時和更新提醒
  - 實現雙閾值觸發的准確視覺化 (服務衛星距離 > Thresh1 且目標衛星距離 < Thresh2)

#### 2.2 D1 事件改進與圖表重新實現 (4天) ✅ **已完成**
- [x] **地理座標泛化**
  - ✅ 移除台灣地區硬編碼限制
  - ✅ 支援任意參考位置配置
  - ✅ 實現全球化座標系統

- [x] **D1 圖表全球化重新實現** ✅ **已完成**
  - ✅ 實現全球地圖整合的軌道路徑顯示
  - ✅ 支援任意參考位置的距離計算視覺化
  - ✅ 加入多衛星並行追蹤的圖表展示
  - ✅ 實現真實軌道數據驅動的距離變化曲線

- [x] **D1 衛星選擇算法重大修復** 🔥 **關鍵突破**
  - ✅ 修復 GPS 高軌道衛星仰角計算算法
  - ✅ 實現精確的 ECEF 座標系統轉換
  - ✅ 優化衛星評分機制：仰角 (50%) + 距離 (30%) + 軌道穩定性 (20%)
  - ✅ 支援 LEO 和 GPS 等不同軌道高度衛星 (550km-22,000km)

- [x] **D1 前端組件完整實現** 🆕
  - ✅ EnhancedD1Chart.tsx (705行) - 主圖表組件
  - ✅ EnhancedD1Viewer.tsx (533行) - 完整查看器界面
  - ✅ 增強的參數配置面板和實時數據控制
  - ✅ 智能服務衛星選擇視覺化

- [x] **D1 API 完整功能驗證** ✅ **測試通過**
  - ✅ 衛星選擇成功：選中 gps_28190 (仰角 59.07°)
  - ✅ 觸發條件正常：3個條件全部滿足
  - ✅ 測量數據準確：距離 2628.8km，參考位置距離 3.7km
  - ✅ 端到端功能完整：前端組件可獲得真實數據

#### 2.3 T1 事件增強與圖表重新實現 (4天) ✅ **已完成**
- [x] **時間同步機制** ✅
  - ✅ 實現 SIB19 時間校正數據整合
  - ✅ 添加 GNSS 時間偏移補償
  - ✅ 完善服務持續時間計算邏輯

- [x] **T1 API 修復與強化** 🔥 **關鍵修復**
  - ✅ 修復 time_correction 未定義錯誤
  - ✅ 實現 SIB19 時間框架整合 (epochTime, t-Service)
  - ✅ 添加時間同步精度監控
  - ✅ 優化時間條件邏輯：經過時間 > 門檻值 && 剩餘時間 ≥ 持續時間

- [x] **T1 前端組件完整實現** 🆕
  - ✅ EnhancedT1Chart.tsx (705行) - 時間軸視覺化圖表
  - ✅ EnhancedT1Viewer.tsx (508行) - 完整時間管理界面  
  - ✅ 時間同步狀態面板和服務時間窗口管理
  - ✅ 預設場景：短會話/正常會話/長會話/關鍵時序

- [x] **T1 API 完整功能驗證** ✅ **測試通過**
  - ✅ 時間條件邏輯正確：threshold_condition_met = elapsed_time > t1_threshold
  - ✅ 持續時間檢查正常：duration_condition_met = remaining_time ≥ required_duration
  - ✅ SIB19 數據完整：包含 epochTime、serviceTime、同步精度
  - ✅ 端到端功能完整：前端組件可獲得真實時間數據

- [ ] **T1 圖表時間同步重新實現** 🆕
  - 顯示 GNSS 時間同步狀態和精度指示
  - 視覺化時鐘偏差對觸發時機的影響 (< 50ms 精度要求)
  - 實現時間窗口和持續時間的直觀展示
  - 加入時間同步失敗的警告和恢復機制展示

#### 2.4 A4 事件 SIB19 增強與位置補償實現 (4天) 🔥 重大升級
- [ ] **SIB19 增強的位置補償機制** 🆕
  - 實現基於 SIB19 星曆數據的動態位置補償 ΔS,T(t)
  - 修正 A4 觸發條件：`PT(t) > PS(t) + HOM + ΔS,T(t)`
  - 利用 UE 位置和衛星位置計算動態補償項
  - 整合鄰居衛星星曆 (透過 ntn-NeighCellConfigList)

- [ ] **時間同步確保的測量精確性**
  - 保證測量時間戳的精確性，避免多普勒效應造成的測量誤差
  - 利用 SIB19 的時間同步參數確保 A4 觸發時機準確
  - 配合 SMTC 配置，確保鄰居衛星可見時才進行測量

- [ ] **信號傳播真實化** (原有功能保留)
  - 添加多普勒效應計算
  - 實現基於軌道的信號強度預測
  - 改進 RSRP 變化模型

- [ ] **A4 圖表 SIB19 整合重新實現** 🆕
  - **位置補償視覺化** - 顯示 ΔS,T(t) 動態位置補償項的計算過程
  - **修正觸發條件展示** - 視覺化 `PT(t) > PS(t) + HOM + ΔS,T(t)` 的完整邏輯
  - **鄰居衛星星曆整合** - 顯示基於 SIB19 鄰居細胞配置的測量目標
  - **SMTC 測量窗口** - 展示基於衛星可見性的智能測量時機
  - 整合多普勒效應的 RSRP 變化視覺化
  - 顯示基於真實軌道的信號強度預測
  - 加入大氣和電離層效應的圖表說明

#### 2.5 統一參數驗證與 UI 整合 (2天)
- [ ] **參數約束實現**
  - 建立事件特定的參數檢查
  - 實現實時驗證和警告
  - 提供參數建議和解釋

- [ ] **圖表參數整合驗證** 🆕
  - 整合新圖表與參數驗證系統
  - 實現參數變更的即時圖表更新
  - 測試所有事件圖表的相容性和穩定性

### Phase 3: UI/UX 統一改進 (2週)
**目標**: 實現一致的用戶體驗和簡易版/完整版模式

#### 3.1 簡易版模式實現 (1週)
- [ ] **模式切換功能**
  - 實現簡易/完整版切換按鈕
  - 建立模式特定的參數面板
  - 保存用戶偏好設定

- [ ] **簡化參數面板設計**
  - 只顯示核心的門檻值參數
  - 隱藏複雜的技術細節
  - 添加參數意義的簡單解釋

#### 3.2 圖表說明統一改進 (1週)
- [ ] **物理意義標籤**
  - 為所有圖表添加清楚的說明標籤
  - 實現動態提示和引導
  - 改進距離/信號軸的單位顯示

- [ ] **視覺化增強**
  - 統一事件觸發動畫效果
  - 改進圖表配色和可讀性
  - 添加關鍵數值的實時顯示

#### 3.3 教育內容整合 (3天)
- [ ] **概念解釋模組**
  - 創建衛星通訊基礎概念解釋
  - 實現事件邏輯的互動式說明
  - 添加實際應用場景介紹

### Phase 4: 系統整合和驗證 (1週)
**目標**: 確保所有改進協調運作並通過 SIB19 標準驗證

#### 4.1 整合測試 (3天)
- [ ] **端到端功能測試**
  - 驗證軌道計算準確性
  - 測試 API 響應性能
  - 確認 UI 模式切換正常

- [ ] **SIB19 標準合規驗證** 🆕
  - 驗證 SIB19 解析引擎的準確性 (100%)
  - 測試 movingReferenceLocation 計算誤差 < 100m
  - 確認時間同步精度 < 50ms
  - 驗證多衛星並行追蹤 (≥4顆衛星)

- [ ] **3GPP 標準合規驗證**
  - 檢查所有事件 3GPP 合規度達到 95%+
  - 驗證參數範圍和約束正確
  - 確認計算結果的準確性

- [ ] **圖表功能完整性測試** 🆕
  - 驗證所有事件圖表基於真實軌道數據
  - 測試 SIB19 廣播流程視覺化正確性
  - 確認全球化地理支援正常運作
  - 驗證時間同步狀態正確顯示

#### 4.2 性能優化 (2天)
- [ ] **軌道計算緩存**
  - 實現衛星位置預計算和緩存
  - 優化實時計算性能
  - 減少前端渲染負載

#### 4.3 文檔和培訓 (2天)
- [ ] **技術文檔更新**
  - 更新 API 文檔和使用說明
  - 撰寫開發者指南和最佳實踐
  - 建立故障排除手冊

## 🚨 關鍵風險和緩解策略

### 技術風險
| 風險 | 影響 | 緩解策略 |
|------|------|----------|
| **TLE 數據更新失敗** | HIGH | 建立數據備份和降級機制 |
| **軌道計算性能問題** | MEDIUM | 實現預計算和緩存策略 |
| **API 兼容性破壞** | HIGH | 保持向後兼容，分階段遷移 |
| **SIB19 標準理解偏差** 🆕 | HIGH | 深度研讀 3GPP TS 38.331，建立標準驗證機制 |
| **時間同步精度要求** 🆕 | MEDIUM | 實現 GNSS 時間源，建立精度監控 |
| **多衛星並行處理複雜度** 🆕 | MEDIUM | 漸進式實現，從 2 顆開始擴展到 4+ 顆 |

### 專案風險
| 風險 | 影響 | 緩解策略 |
|------|------|----------|
| **時程延遲** | MEDIUM | 優先核心功能，分階段交付 |
| **標準理解偏差** | HIGH | 定期與 3GPP 標準對照檢查 |
| **測試覆蓋不足** | MEDIUM | 建立自動化測試流程 |
| **圖表重繪工作量低估** 🆕 | MEDIUM | Phase 1.5 提前驗證架構可行性 |
| **SIB19 數據模擬困難** 🆕 | HIGH | 建立標準 SIB19 測試數據集 |

## 📊 成功評估標準

### 技術指標 🔄 論文研究級標準
- [ ] **軌道計算精度**: 位置誤差 < 1km，信號預測誤差 < 3dB
- [ ] **API 性能**: 響應時間 < 100ms，吞吐量 > 100 req/s  
- [ ] **3GPP 合規度**: 所有事件達到 95%+ 標準合規度
- [ ] **參數驗證**: 100% 不合理參數被攔截並提供建議

#### **🆕 數據真實性指標** (論文研究級)
- [ ] **信號模型準確性**: ITU-R/3GPP 標準模型偏差 < 2dB
- [ ] **都卜勒計算精度**: 頻移誤差 < 100Hz (Ka 頻段)
- [ ] **電離層延遲精度**: 與 GPS 參考值偏差 < 10cm
- [ ] **路徑損耗模型**: 與測量數據相關係數 > 0.9
- [ ] **天線增益精度**: 與廠商規格偏差 < 1dB
- [ ] **時間同步精度**: GNSS 時間偏差 < 50ms

#### **SIB19 統一基礎平台指標** 🆕
- [ ] **SIB19 統一解析準確性**: 100% 正確解析標準 SIB19 數據結構
- [ ] **資訊共享效率**: 跨事件的 SIB19 資訊重複利用率 ≥ 90%
- [ ] **鄰居細胞統一管理**: 同時支援最多 8 個 NTN 鄰居細胞配置
- [ ] **SMTC 整合效率**: 測量窗口命中率 ≥ 85% (避免無效測量)

#### **事件特定 SIB19 整合指標** 🆕
- [ ] **A4 位置補償精度**: ΔS,T(t) 計算誤差 < 50m
- [ ] **D1 固定參考位置精度**: referenceLocation 距離誤差 < 10m
- [ ] **D2 動態參考位置精度**: movingReferenceLocation 計算誤差 < 100m
- [ ] **T1 時間框架精度**: epochTime/t-Service 時間偏差 < 50ms

#### **統一平台性能指標** 🆕
- [ ] **時間同步全域精度**: 所有事件 GNSS 時間偏差 < 50ms
- [ ] **多衛星並行追蹤**: 同時支援 ≥4 顆衛星正常運作
- [ ] **validityTime 管理**: 星曆過期前 100% 自動更新成功
- [ ] **平台擴展性**: 支援未來新增事件 (A3/A5) 無需重新設計基礎架構

### 用戶體驗指標 🔄 統一平台使用體驗
- [ ] **學習曲線**: 新用戶 5 分鐘內理解簡易版操作
- [ ] **專業功能**: 工程師可完成完整的系統測試和配置
- [ ] **響應性**: 參數調整立即反映在圖表上

#### **統一 SIB19 平台體驗指標** 🆕
- [ ] **統一資訊一致性**: 跨事件的 SIB19 資訊顯示一致無矛盾
- [ ] **圖表整合性**: 統一 SIB19 狀態控制台清晰易懂
- [ ] **事件切換流暢性**: 在不同事件間切換無需重新載入基礎數據
- [ ] **全球化支援**: 任意地理位置的參考位置設定正常工作

#### **事件特定使用體驗** 🆕
- [ ] **A4 位置補償可視化**: ΔS,T(t) 動態補償過程清晰展示
- [ ] **D1/D2 位置計算透明性**: 固定/動態參考位置計算過程可追踪
- [ ] **T1 時間框架直觀性**: 時間軸和服務期間清楚顯示
- [ ] **SMTC 測量窗口提示**: 衛星可見性和測量時機明確指示

### 系統穩定性指標 🔄 統一平台穩定性
- [ ] **服務可用性**: 99.9% 正常運行時間
- [ ] **錯誤處理**: 所有邊緣情況都有適當的錯誤處理
- [ ] **性能一致性**: 在不同負載下保持響應性能
- [ ] **數據準確性**: 計算結果與理論值偏差 < 1%

#### **SIB19 統一平台穩定性** 🆕
- [ ] **SIB19 更新連續性**: validityTime 過期前 100% 無縫更新
- [ ] **多事件並行穩定性**: 4 個事件同時運行 24 小時無衝突
- [ ] **資源共享穩定性**: 鄰居細胞管理和星曆數據共享無競態條件
- [ ] **SMTC 同步穩定性**: 測量窗口調度無時序錯亂

#### **跨事件協調穩定性** 🆕
- [ ] **多衛星切換無縫性**: 服務衛星→目標衛星切換無中斷
- [ ] **時間基準一致性**: 所有事件時間同步基準保持一致
- [ ] **位置計算一致性**: D1/D2 位置計算使用相同的地理基準
- [ ] **系統擴展穩定性**: 未來新增事件不影響現有事件穩定性

## 🔧 開發工具和資源

### 必要的技術庫
```bash
# 軌道計算 (真實數據)
npm install satellite.js
pip install sgp4 pyephem

# 信號傳播模型 (ITU-R/3GPP 標準)
pip install numpy scipy  # 數值計算
pip install atmospheric-models  # 大氣模型
pip install ionospheric-models  # 電離層模型

# 真實氣象數據
pip install requests  # 氣象 API 整合
pip install pyowm  # OpenWeatherMap API

# 數據驗證
npm install joi zod
pip install pydantic

# 性能監控
npm install @sentry/react
pip install sentry-sdk

# 科學計算和驗證
pip install matplotlib seaborn  # 數據可視化
pip install pandas  # 數據分析
pip install scikit-learn  # 統計分析
```

### 開發環境要求
- **Node.js**: >= 18.0
- **Python**: >= 3.9
- **PostgreSQL**: >= 13 (用於 TLE 數據存儲)
- **Redis**: >= 6.0 (用於軌道數據緩存)

### 外部數據源
- **TLE 數據**: CelesTrak, Space-Track.org
- **時間同步**: NTP 服務器
- **標準文檔**: 3GPP TS 38.331 最新版本

## 📋 後續維護計劃

### 定期維護任務
- **每日**: TLE 數據更新檢查
- **每週**: 軌道計算精度驗證  
- **每月**: 性能指標評估和優化
- **每季**: 3GPP 標準更新檢查

### 長期擴展計劃
- **多星座支援**: 整合 OneWeb、Kuiper 等星座
- **AI 優化**: 機器學習預測切換時機
- **5G 整合**: 與地面 5G 網路的無縫切換
- **邊緣計算**: 在衛星上執行部分測量邏輯

---

## 📈 重大更新摘要 (基於 SIB19 全面應用分析) 🔄 v3.0 革命性升級

### 🔥 關鍵認知轉變 (v2.0 → v3.0)

**認知革命**: SIB19 從 "D2 專用工具" → **"NTN 系統統一資訊基礎平台"**

基於最新 3GPP 研究發現，SIB19 是**所有 NTN 測量事件的統一資訊基礎架構**，實現了 "資訊統一、應用分化" 的理想設計。

### 🚀 核心架構變更 (v3.0)

1. **SIB19 統一基礎平台建立** 🔥 根本性轉變
   - **重新定位**: SIB19 作為 A4、D1、D2、T1 等所有事件的共享資訊基礎
   - **鄰居細胞統一管理**: 支援最多 8 個 NTN 鄰居細胞並行配置
   - **SMTC 深度整合**: 實現 "SIB19 決定何時測量，SMTC 決定如何測量" 雙核心架構
   - **跨事件資訊共享**: 避免重複配置，實現系統資源最佳利用

2. **A4 事件重大升級** 🔥 從次要到關鍵
   - **合規度重新評估**: 60% → 95% (發現被嚴重低估)
   - **SIB19 位置補償機制**: 實現 `PT(t) > PS(t) + HOM + ΔS,T(t)` 修正觸發條件
   - **鄰居衛星星曆整合**: 透過 ntn-NeighCellConfigList 獲取測量目標
   - **優先級提升**: MEDIUM → CRITICAL (與 D2 同等重要)

3. **統一圖表架構革新** 🆕 資訊統一、應用分化
   - **統一 SIB19 數據層**: 所有事件圖表共享同一套 SIB19 基礎
   - **事件特定視覺化**: A4 位置補償、D1 固定參考、D2 動態參考、T1 時間框架
   - **全域資源共享**: 衛星星座、時間同步、地理支援的統一管理
   - **可擴展性設計**: 為未來 A3/A5 事件預留擴展空間

4. **依賴關係矩陣建立** 🆕 科學化管理
   - **A4**: 增強使用星曆、必要時間同步、必要鄰居配置 → **高度依賴**
   - **D1**: 輔助星曆、必要時間同步、必要固定參考位置 → **高度依賴**  
   - **D2**: 必要星曆、必要時間同步、必要動態參考位置 → **完全依賴**
   - **T1**: 必要時間同步、必要服務時間、可選鄰居配置 → **中度依賴**

### 📊 技術標準全面升級

#### **新增統一平台指標**
- **資訊共享效率**: ≥ 90% 跨事件重複利用率
- **SMTC 整合效率**: ≥ 85% 測量窗口命中率  
- **A4 位置補償精度**: < 50m ΔS,T(t) 計算誤差
- **平台擴展性**: 支援未來新增事件無需重新設計基礎架構

#### **跨事件協調穩定性**
- **多事件並行穩定性**: 4 個事件同時運行 24 小時無衝突
- **時間基準一致性**: 所有事件時間同步基準保持一致
- **位置計算一致性**: D1/D2 使用相同地理基準
- **系統擴展穩定性**: 新增事件不影響現有事件穩定性

### 🎯 核心改進理念升級 (v3.0)

**從 "SIB19 標準合規"** → **"SIB19 統一平台架構"**

此次 v3.0 升級實現了 NTN-Stack 測量事件系統的**架構革命**：
- **資訊統一**: 透過單一 SIB19 提供所有必要的時空基準和衛星配置
- **應用分化**: 不同事件根據特點選擇性使用 SIB19 相關資訊子集
- **效率最大化**: 避免重複配置和信令浪費，實現系統資源最佳利用
- **未來友好**: 為 6G NTN 和新事件類型預留充足擴展空間

### 🚧 時程保持不變
- **總體時程**: 9週 (v2.0 已優化)
- **重點調整**: Phase 內容深度增強，架構更加統一完整

---

**本主準則 v3.0 為 NTN-Stack 測量事件系統提供革命性的統一 SIB19 平台架構，實現了真正的 "資訊統一、應用分化" 理想設計，確保完全符合最新 3GPP NTN 標準並具備面向未來的擴展能力。**
