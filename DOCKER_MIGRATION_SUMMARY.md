# NTN Stack Docker åŒ–é·ç§»ç¸½çµ

## ğŸ¯ é·ç§»ç›®æ¨™

å°‡ NTN Stack å¾ Python è™›æ“¬ç’°å¢ƒåŸ·è¡Œæ¨¡å¼å®Œå…¨é·ç§»åˆ° Docker å®¹å™¨åŒ–åŸ·è¡Œæ¨¡å¼ï¼Œå¯¦ç¾ï¼š

-   çµ±ä¸€çš„å®¹å™¨åŒ–éƒ¨ç½²
-   ä¸€éµæ¸¬è©¦å’Œç®¡ç†
-   æ•´åˆåŸæœ‰æ¸¬è©¦ç¨‹å¼
-   æ¶ˆé™¤é‡è¤‡æ¸¬è©¦ä»£ç¢¼

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. æ¸¬è©¦ç’°å¢ƒ Docker åŒ–

#### å‰µå»ºçš„æ–‡ä»¶ï¼š

-   `docker-compose.test.yml` - æ¸¬è©¦å°ˆç”¨çš„ Docker Compose é…ç½®
-   `tests/Dockerfile` - æ¸¬è©¦å®¹å™¨çš„æ§‹å»ºæ–‡ä»¶
-   `tests/pytest.ini` - Pytest é…ç½®
-   `tests/conftest.py` - æ¸¬è©¦é…ç½®å’Œå…±ç”¨å›ºä»¶
-   `tests/nginx.conf` - æ¸¬è©¦å ±å‘Šçš„ Nginx é…ç½®

#### æ¸¬è©¦æœå‹™æ¶æ§‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ntn-stack-testerâ”‚    â”‚  netstack-api   â”‚    â”‚ simworld-backendâ”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ pytest æ¡†æ¶   â”‚â—„â”€â”€â–ºâ”‚ â€¢ NetStack æœå‹™ â”‚â—„â”€â”€â–ºâ”‚ â€¢ SimWorld æœå‹™ â”‚
â”‚ â€¢ æ¸¬è©¦å ±å‘Šç”Ÿæˆ  â”‚    â”‚ â€¢ Redis/MongoDB â”‚    â”‚ â€¢ PostgreSQL    â”‚
â”‚ â€¢ æ•´åˆæ¸¬è©¦      â”‚    â”‚ â€¢ API ç«¯é»      â”‚    â”‚ â€¢ è»Œé“è¨ˆç®—      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  test-reporter  â”‚
â”‚                 â”‚
â”‚ â€¢ Nginx æœå‹™å™¨  â”‚
â”‚ â€¢ æ¸¬è©¦å ±å‘Šå±•ç¤º  â”‚
â”‚ â€¢ HTTP è¨ªå•     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ¸¬è©¦ç¨‹å¼æ•´åˆ

#### åŸæœ‰æ¸¬è©¦ç¨‹å¼æ•´åˆï¼š

-   **NetStack æ¸¬è©¦** (`netstack/test_satellite_api.py`) â†’ `tests/test_netstack_api.py`
-   **SimWorld æ¸¬è©¦** (`simworld/backend/test_*.py`) â†’ `tests/test_simworld_api.py`
-   **æ•´åˆæ¸¬è©¦** (`test_ntn_stack.py`) â†’ `tests/test_integration.py`

#### æ–°å¢æ¸¬è©¦åŠŸèƒ½ï¼š

-   ç¾ä»£ pytest æ¡†æ¶
-   ç•°æ­¥æ¸¬è©¦æ”¯æ´
-   è‡ªå‹•åŒ–æ¸¬è©¦å ±å‘Š
-   æ¸¬è©¦æ¨™è¨˜å’Œåˆ†é¡
-   æ€§èƒ½åŸºæº–æ¸¬è©¦

### 3. Makefile æ›´æ–°

#### æ–°å¢çš„ Docker åŒ–å‘½ä»¤ï¼š

```bash
# å®Œæ•´æ¸¬è©¦
make test               # åŸ·è¡Œå®Œæ•´ Docker åŒ–æ¸¬è©¦å¥—ä»¶
make test-integration   # åŸ·è¡Œæ•´åˆæ¸¬è©¦
make test-unit          # åŸ·è¡Œå–®å…ƒæ¸¬è©¦

# åŠŸèƒ½æ¸¬è©¦
make test-netstack      # æ¸¬è©¦ NetStack API
make test-simworld      # æ¸¬è©¦ SimWorld API
make test-satellite-mapping  # æ¸¬è©¦è¡›æ˜Ÿæ˜ å°„
make test-oneweb        # æ¸¬è©¦ OneWeb æ˜Ÿåº§

# æ¸¬è©¦ç®¡ç†
make test-reports       # å•Ÿå‹•æ¸¬è©¦å ±å‘Šæœå‹™å™¨
make test-clean         # æ¸…ç†æ¸¬è©¦ç’°å¢ƒ
make test-legacy        # åŸ·è¡ŒåŸæœ‰æ¸¬è©¦ç¨‹å¼
```

### 4. ä¾è³´ç®¡ç†

#### æ›´æ–°çš„ `requirements.txt`ï¼š

```
# HTTP å®¢æˆ¶ç«¯å’Œç•°æ­¥æ”¯æ´
aiohttp>=3.9.0
requests>=2.31.0

# æ¸¬è©¦æ¡†æ¶
pytest>=7.4.0
pytest-asyncio>=0.21.0
pytest-html>=3.2.0
pytest-cov>=4.1.0

# æ¸¬è©¦å ±å‘Šå’Œåˆ†æ
pytest-json-report>=1.5.0
pytest-benchmark>=4.0.0
```

### 5. æ–‡æª”æ›´æ–°

#### æ›´æ–°çš„ `README.md`ï¼š

-   Docker åŒ–çš„å¿«é€Ÿé–‹å§‹æŒ‡å—
-   å®Œæ•´çš„ API ç«¯é»æ–‡æª”
-   æ¸¬è©¦å ±å‘ŠæŸ¥çœ‹èªªæ˜
-   æ•…éšœæ’é™¤æŒ‡å—
-   é–‹ç™¼å·¥ä½œæµç¨‹

## ğŸ—ï¸ æ–°æ¶æ§‹å„ªå‹¢

### 1. çµ±ä¸€å®¹å™¨åŒ–

-   æ‰€æœ‰æœå‹™éƒ½åœ¨ Docker å®¹å™¨ä¸­é‹è¡Œ
-   æ¶ˆé™¤ç’°å¢ƒå·®ç•°å•é¡Œ
-   ç°¡åŒ–éƒ¨ç½²å’Œç¶­è­·

### 2. ä¸€éµæ“ä½œ

```bash
# å•Ÿå‹•æ‰€æœ‰æœå‹™
make start

# åŸ·è¡Œå®Œæ•´æ¸¬è©¦
make test

# æŸ¥çœ‹æ¸¬è©¦å ±å‘Š
make test-reports
```

### 3. æ¸¬è©¦æ•´åˆ

-   æ¶ˆé™¤é‡è¤‡çš„æ¸¬è©¦ä»£ç¢¼
-   çµ±ä¸€çš„æ¸¬è©¦æ¡†æ¶ (pytest)
-   è‡ªå‹•åŒ–æ¸¬è©¦å ±å‘Šç”Ÿæˆ
-   æ”¯æ´ CI/CD æ•´åˆ

### 4. é–‹ç™¼å‹å¥½

-   ç†±é‡è¼‰æ”¯æ´
-   è©³ç´°çš„æ—¥èªŒè¼¸å‡º
-   æ€§èƒ½ç›£æ§
-   API æ–‡æª”è‡ªå‹•ç”Ÿæˆ

## ğŸ“Š æ¸¬è©¦è¦†è“‹ç¯„åœ

### NetStack API æ¸¬è©¦

-   âœ… å¥åº·æª¢æŸ¥
-   âœ… è¡›æ˜Ÿ gNodeB æ˜ å°„ (å–®å€‹/æ‰¹é‡)
-   âœ… è¡›æ˜Ÿè¿½è¹¤åŠŸèƒ½
-   âœ… UERANSIM é…ç½®ç”Ÿæˆ
-   âœ… OneWeb æ˜Ÿåº§ç®¡ç†
-   âœ… åˆ‡ç‰‡é¡å‹å’Œæ¨¡æ¿
-   âœ… ç›£æ§æŒ‡æ¨™

### SimWorld API æ¸¬è©¦

-   âœ… å¥åº·æª¢æŸ¥
-   âœ… å ´æ™¯å¥åº·åº¦æª¢æŸ¥
-   âœ… è¡›æ˜Ÿä½ç½® API
-   âœ… è»Œé“æœå‹™
-   âœ… TLE æ•¸æ“š API
-   âœ… åº§æ¨™è½‰æ›
-   âœ… API æ–‡æª”å¯ç”¨æ€§

### æ•´åˆæ¸¬è©¦

-   âœ… æœå‹™å¥åº·ç‹€æ…‹
-   âœ… è¡›æ˜Ÿåˆ° gNodeB å®Œæ•´æµç¨‹
-   âœ… OneWeb æ˜Ÿåº§å·¥ä½œæµç¨‹
-   âœ… UERANSIM é…ç½®ç”Ÿæˆ
-   âœ… API ç«¯é»å¯ç”¨æ€§
-   âœ… è·¨æœå‹™é€šä¿¡
-   âœ… æ€§èƒ½åŸºæº–æ¸¬è©¦

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å‰ç½®éœ€æ±‚

-   Docker >= 20.10
-   Docker Compose >= 2.0
-   Make (å¯é¸)

### å¿«é€Ÿé–‹å§‹

```bash
# 1. å•Ÿå‹•æ‰€æœ‰æœå‹™
make start

# 2. åŸ·è¡Œæ¸¬è©¦
make test

# 3. æŸ¥çœ‹æ¸¬è©¦å ±å‘Š
make test-reports
# è¨ªå• http://localhost:8090

# 4. æ¸…ç†ç’°å¢ƒ
make clean
```

### æ¸¬è©¦å ±å‘Š

æ¸¬è©¦å®Œæˆå¾Œæœƒç”Ÿæˆå¤šç¨®æ ¼å¼çš„å ±å‘Šï¼š

-   **HTML å ±å‘Š**: è©³ç´°çš„æ¸¬è©¦çµæœå’Œçµ±è¨ˆ
-   **JUnit XML**: é©ç”¨æ–¼ CI/CD ç³»çµ±
-   **JSON å ±å‘Š**: çµæ§‹åŒ–æ•¸æ“šï¼Œä¾¿æ–¼ç¨‹å¼è™•ç†
-   **è¦†è“‹ç‡å ±å‘Š**: ä»£ç¢¼è¦†è“‹ç‡åˆ†æ

### é–‹ç™¼å·¥ä½œæµç¨‹

```bash
# é–‹ç™¼ç’°å¢ƒè¨­ç½®
make dev-setup

# å•Ÿå‹•é–‹ç™¼æœå‹™
make dev-start

# åŸ·è¡Œç‰¹å®šæ¸¬è©¦
make test-netstack

# æŸ¥çœ‹æ—¥èªŒ
make logs

# æ¸…ç†å’Œé‡å»º
make clean && make build && make start
```

## ğŸ”§ é…ç½®èªªæ˜

### ç’°å¢ƒè®Šæ•¸

```bash
# æœå‹™ URL
NETSTACK_URL=http://localhost:8080
SIMWORLD_URL=http://localhost:8000

# æ¸¬è©¦é…ç½®
TEST_TIMEOUT=60
PYTEST_ARGS=--verbose --tb=short

# Docker é…ç½®
COMPOSE_PROJECT_NAME=ntn-stack
```

### ç«¯å£é…ç½®

| æœå‹™         | ç«¯å£  | èªªæ˜            |
| ------------ | ----- | --------------- |
| NetStack API | 8080  | ä¸»è¦ API æœå‹™   |
| SimWorld API | 8000  | æ¨¡æ“¬æœå‹™        |
| æ¸¬è©¦å ±å‘Š     | 8090  | æ¸¬è©¦çµæœæŸ¥çœ‹    |
| Redis        | 6379  | ç·©å­˜æœå‹™        |
| MongoDB      | 27017 | æ•¸æ“šåº«          |
| PostgreSQL   | 5432  | SimWorld æ•¸æ“šåº« |

## ğŸ‰ é·ç§»æˆæœ

### æ¶ˆé™¤çš„å•é¡Œ

-   âŒ Python è™›æ“¬ç’°å¢ƒä¾è³´å•é¡Œ
-   âŒ é‡è¤‡çš„æ¸¬è©¦ä»£ç¢¼
-   âŒ æ‰‹å‹•æ¸¬è©¦æµç¨‹
-   âŒ ç’°å¢ƒé…ç½®è¤‡é›œæ€§

### æ–°å¢çš„å„ªå‹¢

-   âœ… å®Œå…¨å®¹å™¨åŒ–çš„åŸ·è¡Œç’°å¢ƒ
-   âœ… ä¸€éµæ¸¬è©¦å’Œéƒ¨ç½²
-   âœ… çµ±ä¸€çš„æ¸¬è©¦æ¡†æ¶
-   âœ… è‡ªå‹•åŒ–æ¸¬è©¦å ±å‘Š
-   âœ… CI/CD å‹å¥½çš„æ¶æ§‹
-   âœ… è©³ç´°çš„æ–‡æª”å’ŒæŒ‡å—

## ğŸ“ å¾ŒçºŒå»ºè­°

### 1. CI/CD æ•´åˆ

```yaml
# .github/workflows/test.yml ç¯„ä¾‹
name: NTN Stack Tests
on: [push, pull_request]
jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Run tests
              run: make test
            - name: Upload test reports
              uses: actions/upload-artifact@v3
              with:
                  name: test-reports
                  path: test-reports/
```

### 2. ç›£æ§æ•´åˆ

-   æ·»åŠ  Prometheus ç›£æ§
-   é›†æˆ Grafana å„€è¡¨æ¿
-   è¨­ç½®å‘Šè­¦è¦å‰‡

### 3. å®‰å…¨åŠ å›º

-   æ·»åŠ å®¹å™¨å®‰å…¨æƒæ
-   å¯¦æ–½æœ€å°æ¬Šé™åŸå‰‡
-   åŠ å¯†æ•æ„Ÿé…ç½®

### 4. æ€§èƒ½å„ªåŒ–

-   å¯¦æ–½æ¸¬è©¦ä¸¦è¡ŒåŒ–
-   å„ªåŒ–å®¹å™¨æ§‹å»ºæ™‚é–“
-   æ·»åŠ ç·©å­˜ç­–ç•¥

---

**ç¸½çµ**: NTN Stack å·²æˆåŠŸé·ç§»åˆ°å®Œå…¨ Docker åŒ–çš„æ¶æ§‹ï¼Œæä¾›äº†çµ±ä¸€ã€å¯é ã€æ˜“æ–¼ç¶­è­·çš„æ¸¬è©¦å’Œéƒ¨ç½²ç’°å¢ƒã€‚æ‰€æœ‰åŸæœ‰åŠŸèƒ½éƒ½å¾—åˆ°ä¿ç•™ä¸¦å¢å¼·ï¼ŒåŒæ™‚æ¶ˆé™¤äº†ç’°å¢ƒä¾è³´å•é¡Œå’Œé‡è¤‡ä»£ç¢¼ã€‚
