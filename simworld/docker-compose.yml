# docker-compose.yml
# GPU/CPU æ¨¡å¼æ›æ‰‹æŒ‡å—:
# 1. ä½¿ç”¨ CPU æ¨¡å¼: è¨­å®š CUDA_VISIBLE_DEVICES="-1" ä¸”è¨»é‡‹æ‰ deploy éƒ¨åˆ†
# 2. ä½¿ç”¨ GPU æ¨¡å¼: è¨­å®š CUDA_VISIBLE_DEVICES="" æˆ–æŒ‡å®š GPU IDï¼Œä¸¦å•Ÿç”¨ deploy éƒ¨åˆ†
# 3. å¯é¸æ¸²æŸ“å¾Œç«¯: PYOPENGL_PLATFORM=egl (é»˜èª) æˆ– PYOPENGL_PLATFORM=osmesa æˆ– PYOPENGL_PLATFORM=glfw

services:
    # PostgreSQL å·²ç§»é™¤ - æ”¹ç”¨ NetStack MongoDB

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: simworld_backend # çµ¦å®¹å™¨ä¸€å€‹æ˜ç¢ºçš„åç¨±
        ports:
            - '8888:8000'
        volumes:
            - ./backend:/app
            - ../netstack/tle_data:/app/netstack/tle_data:ro  # Mount NetStack TLE data as read-only
            # ğŸ¯ F3/A1æ°¸ä¹…æ•¸æ“šï¼šBind Mountåˆ°é …ç›®ç›®éŒ„ (åªè®€)
            - /home/sat/ntn-stack/data/leo_outputs:/app/data:ro
        env_file:
            - ./backend/.env # å¾ backend ç›®éŒ„çš„ .env è®€å–é…ç½®
        environment:
            # === æ¸²æŸ“å’Œè¨ˆç®—æ¨¡å¼è¨­å®š ===
            # CPU æ¨¡å¼ï¼šè¨­å®šç‚º "-1" å¼·åˆ¶ä½¿ç”¨ CPU
            # GPU æ¨¡å¼ï¼šè¨­å®šç‚º "" æˆ–ç‰¹å®š GPU IDï¼Œå¦‚ "0" æˆ– "0,1"
            CUDA_VISIBLE_DEVICES: '-1'

            # === æ¸²æŸ“å¾Œç«¯è¨­å®š ===
            # æ”¯æŒä¸‰ç¨®æ¨¡å¼ï¼šegl (é»˜èª), osmesa (ç´”è»Ÿé«”), glfw (éœ€è¦é¡¯ç¤ºå™¨æˆ–è™›æ“¬é¡¯ç¤ºå™¨)
            PYOPENGL_PLATFORM: 'egl'
            # å¯é¸è¨­å®š pyrender çš„å¾Œç«¯
            PYRENDER_BACKEND: 'pyglet'

            # å…¶ä»–é€šç”¨è¨­å®š
            PYTHONUNBUFFERED: '1'
            # å¤–éƒ¨ IP åœ°å€è¨­å®š (ç”¨æ–¼ CORS)
            EXTERNAL_IP: ${EXTERNAL_IP:-127.0.0.1}
            # PostgreSQL é€£æ¥é…ç½® (å·²ç§»é™¤ RL PostgreSQL)
            # DATABASE_URL: postgresql+asyncpg://localhost:5432/default_db
            # Redis é€£æ¥ URL (é€£æ¥åˆ° NetStack çš„ Redis via network IP)
            REDIS_URL: redis://172.20.0.50:6379/0

        # === GPU æ”¯æŒ (ä½¿ç”¨ GPU æ¨¡å¼æ™‚å–æ¶ˆè¨»é‡‹) ===
        # deploy:
        #   resources:
        #     reservations:
        #       devices:
        #         - driver: nvidia
        #           count: all
        #           capabilities: [gpu]
        
        # === ç¶²è·¯é…ç½® ===
        networks:
            - sionna-net
            - netstack-core  # é€£æ¥åˆ° NetStack ç¶²è·¯ä»¥è¨ªå• MongoDB
        
        # ç§»é™¤ PostgreSQL ä¾è³´ - MongoDB åœ¨ NetStack ä¸­ç®¡ç†
        # command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload # é–‹ç™¼æ™‚å¯å–æ¶ˆè¨»é‡‹
        healthcheck: # <--- æ–°å¢ FastAPI çš„ healthcheck
            # å˜—è©¦é€£æ¥ FastAPI çš„æ ¹è·¯å¾‘ "/"ã€‚éœ€è¦ curlã€‚
            # test: ["CMD", "curl", "-f", "http://localhost:8000/"]
            # æˆ–è€…ï¼Œå¦‚æœä¸æƒ³å®‰è£ curlï¼Œå¯ä»¥å˜—è©¦ç”¨ python ç°¡æ˜“æª¢æŸ¥ç«¯å£ (éœ€è¦ python åœ¨åŸºç¤é¡åƒä¸­)
            test:
                [
                    'CMD-SHELL',
                    'python -c ''import socket; s = socket.create_connection(("localhost", 8000), timeout=5)'' || exit 1',
                ]
            interval: 10s # æ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡
            timeout: 5s # æ¯æ¬¡æª¢æŸ¥è¶…æ™‚ 5 ç§’
            retries: 5 # é‡è©¦ 5 æ¬¡å¤±æ•—å¾Œæ¨™è¨˜ç‚ºä¸å¥åº·
            start_period: 30s # å•Ÿå‹•å¾Œç­‰å¾… 30 ç§’å†é–‹å§‹å¥åº·æª¢æŸ¥ (çµ¦ FastAPI è¶³å¤ çš„å•Ÿå‹•æ™‚é–“)

    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
        container_name: simworld_frontend # çµ¦å®¹å™¨ä¸€å€‹æ˜ç¢ºçš„åç¨±
        ports:
            - '5173:5173'
        volumes:
            # ğŸ¯ F3/A1æ°¸ä¹…æ•¸æ“šï¼šBind Mountåˆ°é …ç›®ç›®éŒ„ (åªè®€)  
            - /home/sat/ntn-stack/data/leo_outputs:/app/public/data:ro
            - ./frontend:/app
            - node_modules:/app/node_modules
        environment:
            # Docker ç’°å¢ƒæ¨™è­˜
            VITE_ENV_MODE: docker
            # API é…ç½® - åœ¨ Docker ä¸­ä½¿ç”¨ä»£ç†è·¯å¾‘
            VITE_NETSTACK_URL: /netstack
            VITE_SIMWORLD_URL: /api
            # Vite ä»£ç†ç›®æ¨™é…ç½®
            VITE_NETSTACK_PROXY_TARGET: http://netstack-api:8080
            VITE_SIMWORLD_PROXY_TARGET: http://simworld_backend:8000
            # é–‹ç™¼é…ç½®
            VITE_PORT: 5173
            VITE_DEBUG: true
        networks:
            - sionna-net
            - netstack-core
        depends_on: # React é€šå¸¸ä¾è³´ FastAPI
            backend: # <--- ä¿®æ”¹ä¾è³´æ¢ä»¶
                condition: service_healthy # ç­‰å¾… backend å¥åº·æª¢æŸ¥é€šé

networks:
    sionna-net:
        driver: bridge
    netstack-core:
        external: true
        name: compose_netstack-core

volumes: # <-- Volume å®šç¾©
    # ğŸ¯ ç§»é™¤satellite_precomputed_data Docker volumeï¼Œæ”¹ç”¨Bind Mount
    node_modules:  # ä¿ç•™ node_modules volume
