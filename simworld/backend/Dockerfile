# backend/Dockerfile

# 1. ä½¿ç”¨å®˜æ–¹ Python é¡åƒ (èˆ‡æ‚¨çš„ç’°å¢ƒåŒ¹é…, e.g., 3.11)
FROM python:3.11-slim

# 2. è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /app

# 3. è¨­å®šç’°å¢ƒè®Šé‡
# ENV CUDA_VISIBLE_DEVICES="-1" å¼·åˆ¶ä½¿ç”¨ CPU (æ ¹æ“šæ‚¨çš„æƒ…æ³èª¿æ•´æˆ–ç§»é™¤)
# é˜²æ­¢ Python å¯«å…¥ .pyc æ–‡ä»¶
ENV PYTHONDONTWRITEBYTECODE=1
# å¼·åˆ¶ stdout/stderr ä¸ç·©å­˜ï¼Œæ–¹ä¾¿çœ‹æ—¥èªŒ
ENV PYTHONUNBUFFERED=1
# ç§»é™¤ TensorFlow é…ç½® - ä¸å†éœ€è¦
# è®“ Dr.Jit èƒ½æ‰¾åˆ° LLVM shared lib
ENV DRJIT_LIBLLVM_PATH=/usr/lib/x86_64-linux-gnu/libLLVM-19.so
# è¨­å®š PyOpenGL é»˜èªä½¿ç”¨ EGL (å¯é€šéç’°å¢ƒè®Šæ•¸è¦†è“‹)
ENV PYOPENGL_PLATFORM=egl

# 4. å®‰è£ç³»çµ±ä¾è³´
#    - æ¸²æŸ“ç›¸é—œï¼šæ›´å®Œæ•´çš„ OpenGL/EGL/OSMesa æ”¯æŒ
#    - ç§»é™¤ PostgreSQL ä¾è³´ (ä½¿ç”¨ NetStack çš„ PostgreSQL)
RUN apt update && apt install -y --no-install-recommends \
    libgl1 \
    libegl1 \
    libegl-mesa0 \
    libosmesa6 \
    libopengl0 \
    libglfw3 \
    xvfb \
    llvm-dev \
    libllvm19 \
    build-essential \
    curl \
    && apt clean && rm -rf /var/lib/apt/lists/*


# 5. è¤‡è£½ä¾è³´æ–‡ä»¶ä¸¦å®‰è£ Python ä¾è³´
# å…ˆè¤‡è£½ requirements.txt å¯ä»¥åˆ©ç”¨ Docker çš„å±¤ç·©å­˜
COPY requirements.txt .

# å‡ç´š pip ä¸¦é…ç½®è¶…æ™‚è¨­å®š
RUN pip install --no-cache-dir --upgrade pip && \
    pip config set global.timeout 600 && \
    pip config set global.retries 5

# å®‰è£ Python ä¾è³´ï¼Œä½¿ç”¨æ›´é•·çš„è¶…æ™‚æ™‚é–“
RUN pip install --no-cache-dir --default-timeout=600 -r requirements.txt

# ğŸš€ VOLUME-BASED DEVELOPMENT: ä»£ç¢¼é€šéVolumeæ›è¼‰ï¼Œç„¡éœ€è¤‡è£½åˆ°æ˜ åƒæª”
# COPY . .  # å·²ç§»é™¤ - æ‰€æœ‰æ‡‰ç”¨ä»£ç¢¼ä½¿ç”¨Volumeæ›è¼‰

# 7. æ··åˆæ¨¡å¼ v2.0ï¼šæ•¸æ“šé è™•ç†å·²ç§»è‡³ NetStackï¼ŒSimWorld åƒ…è² è²¬ API æœå‹™
# ä¸å†åœ¨å»ºç½®éšæ®µåŸ·è¡Œé è™•ç†ï¼Œæ”¹ç”¨é‹è¡Œæ™‚å¾ NetStack ç²å–é è™•ç†æ•¸æ“š

# 8. å‰µå»ºæ•¸æ“šç›®éŒ„ä¸¦è¨­ç½®æ¬Šé™
RUN mkdir -p /app/data /app/netstack/tle_data && \
    chmod 755 /app/data /app/netstack/tle_data

# 9. æš´éœ² Uvicorn é‹è¡Œçš„ç«¯å£
EXPOSE 8000

# 10. å®¹å™¨å•Ÿå‹•æ™‚é‹è¡Œçš„å‘½ä»¤
# æ³¨æ„ï¼šé€™è£¡ä¸åŠ  --reloadï¼Œå› ç‚ºé–‹ç™¼æ™‚æœƒç”¨ volume æ›è¼‰ + compose æ§åˆ¶
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]