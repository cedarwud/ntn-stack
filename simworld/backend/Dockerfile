# backend/Dockerfile

# 1. ä½¿ç”¨å®˜æ–¹ Python é¡åƒ (èˆ‡æ‚¨çš„ç’°å¢ƒåŒ¹é…, e.g., 3.11)
FROM python:3.11-slim

# 2. è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /app

# 3. è¨­å®šç’°å¢ƒè®Šé‡
# ENV CUDA_VISIBLE_DEVICES="-1" å¼·åˆ¶ä½¿ç”¨ CPU (æ ¹æ“šæ‚¨çš„æƒ…æ³èª¿æ•´æˆ–ç§»é™¤)
# é˜²æ­¢ Python å¯«å…¥ .pyc æ–‡ä»¶
ENV PYTHONDONTWRITEBYTECODE=1
# å¼·åˆ¶ stdout/stderr ä¸ç·©å­˜ï¼Œæ–¹ä¾¿çœ‹æ—¥èªŒ
ENV PYTHONUNBUFFERED=1
# æ¸›å°‘ TensorFlow æ—¥èªŒ
ENV TF_CPP_MIN_LOG_LEVEL="3"
# è®“ Dr.Jit èƒ½æ‰¾åˆ° LLVM shared lib
ENV DRJIT_LIBLLVM_PATH=/usr/lib/x86_64-linux-gnu/libLLVM-14.so.1
# è¨­å®š PyOpenGL é»˜èªä½¿ç”¨ EGL (å¯é€šéç’°å¢ƒè®Šæ•¸è¦†è“‹)
ENV PYOPENGL_PLATFORM=egl

# 4. å®‰è£ç³»çµ±ä¾è³´
#    - æ¸²æŸ“ç›¸é—œï¼šæ›´å®Œæ•´çš„ OpenGL/EGL/OSMesa æ”¯æŒ
#    - è³‡æ–™åº«ç›¸é—œï¼šPostgreSQL, GDAL, PostGIS
RUN apt update && apt install -y --no-install-recommends \
    libgl1-mesa-glx \
    libegl1-mesa \
    libosmesa6 \
    libopengl0 \
    libglfw3 \
    xvfb \
    llvm-dev \
    libllvm14 \
    build-essential \
    libpq-dev \
    gdal-bin \
    libgdal-dev \
    postgresql-client \
    curl \
    && apt clean && rm -rf /var/lib/apt/lists/*


# 5. è¤‡è£½ä¾è³´æ–‡ä»¶ä¸¦å®‰è£ Python ä¾è³´
# å…ˆè¤‡è£½ requirements.txt å¯ä»¥åˆ©ç”¨ Docker çš„å±¤ç·©å­˜
COPY requirements.txt .

# å‡ç´š pip ä¸¦é…ç½®è¶…æ™‚è¨­å®š
RUN pip install --no-cache-dir --upgrade pip && \
    pip config set global.timeout 600 && \
    pip config set global.retries 5

# å®‰è£ Python ä¾è³´ï¼Œä½¿ç”¨æ›´é•·çš„è¶…æ™‚æ™‚é–“
RUN pip install --no-cache-dir --default-timeout=600 -r requirements.txt

# 6. è¤‡è£½æ‡‰ç”¨ç¨‹å¼ç¢¼åˆ°å·¥ä½œç›®éŒ„
COPY . .

# 7. Docker å»ºç½®éšæ®µï¼šåŸ·è¡Œ 120 åˆ†é˜æ•¸æ“šé è™•ç†
RUN echo "ğŸš€ åŸ·è¡Œ 120 åˆ†é˜æ•¸æ“šé è™•ç†..." && \
    python preprocess_120min_timeseries.py || echo "âš ï¸ é è™•ç†æœªèƒ½å®Œæˆï¼Œå°‡ä½¿ç”¨é‹è¡Œæ™‚å‹•æ…‹è¼‰å…¥"

# 8. å‰µå»ºæ•¸æ“šç›®éŒ„ä¸¦è¨­ç½®æ¬Šé™
RUN mkdir -p /app/data /app/netstack/tle_data && \
    chmod 755 /app/data /app/netstack/tle_data

# 9. æš´éœ² Uvicorn é‹è¡Œçš„ç«¯å£
EXPOSE 8000

# 10. å®¹å™¨å•Ÿå‹•æ™‚é‹è¡Œçš„å‘½ä»¤
# æ³¨æ„ï¼šé€™è£¡ä¸åŠ  --reloadï¼Œå› ç‚ºé–‹ç™¼æ™‚æœƒç”¨ volume æ›è¼‰ + compose æ§åˆ¶
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]