/**
 * Pure D1 Chart Component  
 * Âü∫Êñº 3GPP TS 38.331 Section 5.5.4.15 ÂØ¶Áèæ
 * Event D1: Ë∑ùÈõ¢ÈõôÈñÄÊ™ª‰∫ã‰ª∂
 * ÈÄ≤ÂÖ•Ê¢ù‰ª∂: Ml1 ‚Äì Hys > Thresh1 AND Ml2 + Hys < Thresh2
 * Èõ¢ÈñãÊ¢ù‰ª∂: Ml1 + Hys < Thresh1 OR Ml2 ‚Äì Hys > Thresh2
 */

import React, { useEffect, useRef, useMemo } from 'react'
import { Chart } from 'chart.js/auto'

// Ê®°Êì¨Ë∑ùÈõ¢Êï∏ÊìöÔºöUE Âà∞ÂÖ©ÂÄãÂèÉËÄÉ‰ΩçÁΩÆÁöÑË∑ùÈõ¢Èö®ÊôÇÈñìËÆäÂåñ
// Ë∑ùÈõ¢1: UE Âà∞ referenceLocation1 ÁöÑË∑ùÈõ¢ (ÂÖ¨Â∞∫)
const distance1Points = [
    { x: 0, y: 800 },
    { x: 5, y: 750 },
    { x: 10, y: 700 },
    { x: 15, y: 650 },
    { x: 20, y: 600 },
    { x: 25, y: 550 },
    { x: 30, y: 500 },
    { x: 35, y: 450 },
    { x: 40, y: 400 },
    { x: 45, y: 350 },
    { x: 50, y: 320 },
    { x: 55, y: 300 },
    { x: 60, y: 290 },
    { x: 65, y: 300 },
    { x: 70, y: 320 },
    { x: 75, y: 350 },
    { x: 80, y: 400 },
    { x: 85, y: 450 },
    { x: 90, y: 500 },
    { x: 95, y: 550 },
]

// Ë∑ùÈõ¢2: UE Âà∞ referenceLocation2 ÁöÑË∑ùÈõ¢ (ÂÖ¨Â∞∫)  
const distance2Points = [
    { x: 0, y: 100 },
    { x: 5, y: 120 },
    { x: 10, y: 140 },
    { x: 15, y: 160 },
    { x: 20, y: 180 },
    { x: 25, y: 200 },
    { x: 30, y: 220 },
    { x: 35, y: 240 },
    { x: 40, y: 260 },
    { x: 45, y: 280 },
    { x: 50, y: 300 },
    { x: 55, y: 320 },
    { x: 60, y: 300 },
    { x: 65, y: 280 },
    { x: 70, y: 260 },
    { x: 75, y: 240 },
    { x: 80, y: 220 },
    { x: 85, y: 200 },
    { x: 90, y: 180 },
    { x: 95, y: 160 },
]

interface PureD1ChartProps {
    width?: number
    height?: number
    thresh1?: number // distanceThreshFromReference1 (meters)
    thresh2?: number // distanceThreshFromReference2 (meters) 
    hysteresis?: number // hysteresisLocation (meters)
    showThresholdLines?: boolean
    isDarkTheme?: boolean
    onThemeToggle?: () => void
}

export const PureD1Chart: React.FC<PureD1ChartProps> = React.memo(
    ({
        width: _width = 800,
        height: _height = 400,
        thresh1 = 400, // Thresh1: 400m
        thresh2 = 250, // Thresh2: 250m
        hysteresis = 20, // 20m hysteresis
        showThresholdLines = true,
        isDarkTheme = true,
        onThemeToggle,
    }) => {
        const canvasRef = useRef<HTMLCanvasElement>(null)
        const chartRef = useRef<Chart | null>(null)
        const isInitialized = useRef(false)

        // ‰ΩøÁî® useMemo Á©©ÂÆö‰∏ªÈ°åÈÖçËâ≤ÊñπÊ°à
        const colors = useMemo(
            () => ({
                dark: {
                    distance1Line: '#28A745', // Á∂†Ëâ≤ÔºöË∑ùÈõ¢1
                    distance2Line: '#FD7E14', // Ê©ôËâ≤ÔºöË∑ùÈõ¢2  
                    thresh1Line: '#DC3545', // Á¥ÖËâ≤ÔºöÈñÄÊ™ª1
                    thresh2Line: '#007BFF', // ËóçËâ≤ÔºöÈñÄÊ™ª2
                    hysteresisLine: 'rgba(108, 117, 125, 0.6)', // ÁÅ∞Ëâ≤ÔºöÈÅ≤ÊªØÁ∑ö
                    title: '#E74C3C',
                    text: 'white',
                    grid: 'rgba(255, 255, 255, 0.1)',
                    background: 'transparent',
                },
                light: {
                    distance1Line: '#198754',
                    distance2Line: '#FD6C00',
                    thresh1Line: '#DC3545',
                    thresh2Line: '#0D6EFD',
                    hysteresisLine: 'rgba(108, 117, 125, 0.8)',
                    title: '#D32F2F',
                    text: '#333333',
                    grid: 'rgba(0, 0, 0, 0.1)',
                    background: 'white',
                },
            }),
            []
        )

        const currentTheme = useMemo(
            () => (isDarkTheme ? colors.dark : colors.light),
            [isDarkTheme, colors]
        )

        // ÂàùÂßãÂåñÂúñË°® - Âè™Âü∑Ë°å‰∏ÄÊ¨°
        useEffect(() => {
            if (!canvasRef.current || isInitialized.current) return
            const ctx = canvasRef.current.getContext('2d')
            if (!ctx) return

            console.log('üéØ [PureD1Chart] ÂàùÂßãÂåñ useEffect Ëß∏Áôº')

            // Ê∫ñÂÇôÂàùÂßãÊï∏ÊìöÈõÜ
            const datasets: any[] = [
                {
                    label: 'Distance 1 (UE ‚Üî Ref1)',
                    data: distance1Points,
                    borderColor: '#28A745', // È†êË®≠Á∂†Ëâ≤
                    backgroundColor: 'transparent',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    borderWidth: 3,
                },
                {
                    label: 'Distance 2 (UE ‚Üî Ref2)',
                    data: distance2Points,
                    borderColor: '#FD7E14', // È†êË®≠Ê©ôËâ≤
                    backgroundColor: 'transparent',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    borderWidth: 3,
                },
            ]

            // Â¶ÇÊûúÈúÄË¶ÅÈ°ØÁ§∫ÈñÄÊ™ªÁ∑öÔºåÊ∑ªÂä†ÈñÄÊ™ªÁ∑öÊï∏ÊìöÈõÜ
            if (showThresholdLines) {
                const timePoints = distance1Points.map(point => point.x)
                
                // Thresh1 ÈñÄÊ™ªÁ∑öÊï∏Êìö
                const thresh1Data = timePoints.map((time) => ({
                    x: time,
                    y: thresh1,
                }))
                
                // Thresh2 ÈñÄÊ™ªÁ∑öÊï∏Êìö
                const thresh2Data = timePoints.map((time) => ({
                    x: time,
                    y: thresh2,
                }))

                // Thresh1 ÈÅ≤ÊªØÁ∑ö
                const thresh1HysUpperData = timePoints.map((time) => ({
                    x: time,
                    y: thresh1 + hysteresis,
                }))
                const thresh1HysLowerData = timePoints.map((time) => ({
                    x: time,
                    y: thresh1 - hysteresis,
                }))

                // Thresh2 ÈÅ≤ÊªØÁ∑ö
                const thresh2HysUpperData = timePoints.map((time) => ({
                    x: time,
                    y: thresh2 + hysteresis,
                }))
                const thresh2HysLowerData = timePoints.map((time) => ({
                    x: time,
                    y: thresh2 - hysteresis,
                }))

                datasets.push(
                    {
                        label: 'Thresh1 (Ref1 Threshold)',
                        data: thresh1Data,
                        borderColor: '#DC3545', // Á¥ÖËâ≤
                        backgroundColor: 'transparent',
                        borderDash: [10, 5],
                        borderWidth: 2,
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                    },
                    {
                        label: 'Thresh2 (Ref2 Threshold)',
                        data: thresh2Data,
                        borderColor: '#007BFF', // ËóçËâ≤
                        backgroundColor: 'transparent',
                        borderDash: [10, 5],
                        borderWidth: 2,
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                    },
                    {
                        label: 'Thresh1 + Hys',
                        data: thresh1HysUpperData,
                        borderColor: 'rgba(220, 53, 69, 0.4)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 3],
                        borderWidth: 1,
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                    },
                    {
                        label: 'Thresh1 - Hys',
                        data: thresh1HysLowerData,
                        borderColor: 'rgba(220, 53, 69, 0.4)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 3],
                        borderWidth: 1,
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                    },
                    {
                        label: 'Thresh2 + Hys',
                        data: thresh2HysUpperData,
                        borderColor: 'rgba(0, 123, 255, 0.4)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 3],
                        borderWidth: 1,
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                    },
                    {
                        label: 'Thresh2 - Hys',
                        data: thresh2HysLowerData,
                        borderColor: 'rgba(0, 123, 255, 0.4)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 3],
                        borderWidth: 1,
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                    }
                )
            }

            try {
                console.log('üîß [PureD1Chart] ÈñãÂßãÂâµÂª∫ÂúñË°®')
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: showThresholdLines,
                                position: 'bottom',
                                labels: {
                                    color: 'white', // È†êË®≠È°èËâ≤
                                    font: { size: 12 },
                                    filter: function(legendItem, chartData) {
                                        // Èö±ËóèÈÅ≤ÊªØÁ∑öÂúñ‰æãÔºåÈÅøÂÖçÈÅéÊñºË§áÈõú
                                        const label = legendItem.text || '';
                                        return !label.includes('Hys');
                                    }
                                },
                            },
                            title: { 
                                display: true,
                                text: 'Event D1: Ë∑ùÈõ¢ÈõôÈñÄÊ™ª‰∫ã‰ª∂',
                                color: 'white',
                                font: { size: 16 }
                            },
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Time (s)',
                                    color: 'white', // È†êË®≠È°èËâ≤
                                    font: { size: 14 },
                                },
                                ticks: { color: 'white' }, // È†êË®≠È°èËâ≤
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }, // È†êË®≠È°èËâ≤
                                min: 0,
                                max: 100,
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Distance (m)',
                                    color: 'white', // È†êË®≠È°èËâ≤
                                    font: { size: 14 },
                                },
                                ticks: { color: 'white' }, // È†êË®≠È°èËâ≤
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }, // È†êË®≠È°èËâ≤
                                min: 0,
                                max: 900,
                            },
                        },
                    },
                })

                isInitialized.current = true
                console.log('‚úÖ [PureD1Chart] ÂúñË°®ÂâµÂª∫ÊàêÂäü')
            } catch (error) {
                console.error('‚ùå [PureD1Chart] ÂúñË°®ÂâµÂª∫Â§±Êïó:', error)
            }

            // Ê∏ÖÁêÜÂáΩÊï∏
            return () => {
                console.log('üóëÔ∏è [PureD1Chart] Ê∏ÖÁêÜÂáΩÊï∏Âü∑Ë°å')
                if (chartRef.current) {
                    chartRef.current.destroy()
                    chartRef.current = null
                    isInitialized.current = false
                    console.log('üóëÔ∏è [PureD1Chart] ÂúñË°®Â∑≤Èä∑ÊØÄ')
                }
            }
        }, []) // Âè™Âú®ÊéõËºâÊôÇÂü∑Ë°å

        // Êõ¥Êñ∞ÂèÉÊï∏Âíå‰∏ªÈ°å - ‰∏çÈáçÊñ∞ÂâµÂª∫ÂúñË°®
        useEffect(() => {
            if (!chartRef.current || !isInitialized.current) {
                return
            }
            const chart = chartRef.current

            console.log('üîÑ [PureD1Chart] Êõ¥Êñ∞ÂúñË°®ÂèÉÊï∏')

            // ËôïÁêÜ showThresholdLines ËÆäÂåñÂíåÂèÉÊï∏Êõ¥Êñ∞
            if (showThresholdLines) {
                const timePoints = distance1Points.map(point => point.x)
                
                // ÈáçÊñ∞Ë®àÁÆóÈñÄÊ™ªÁ∑öÊï∏Êìö
                const thresh1Data = timePoints.map((time) => ({ x: time, y: thresh1 }))
                const thresh2Data = timePoints.map((time) => ({ x: time, y: thresh2 }))
                const thresh1HysUpperData = timePoints.map((time) => ({ x: time, y: thresh1 + hysteresis }))
                const thresh1HysLowerData = timePoints.map((time) => ({ x: time, y: thresh1 - hysteresis }))
                const thresh2HysUpperData = timePoints.map((time) => ({ x: time, y: thresh2 + hysteresis }))
                const thresh2HysLowerData = timePoints.map((time) => ({ x: time, y: thresh2 - hysteresis }))

                // Á¢∫‰øùÊúâË∂≥Â§†ÁöÑÊï∏ÊìöÈõÜ
                if (chart.data.datasets.length === 2) {
                    // Ê∑ªÂä†ÈñÄÊ™ªÁ∑öÊï∏ÊìöÈõÜ
                    chart.data.datasets.push(
                        { label: 'Thresh1 (Ref1 Threshold)', data: thresh1Data, borderColor: currentTheme.thresh1Line, backgroundColor: 'transparent', borderDash: [10, 5], borderWidth: 2, fill: false, tension: 0, pointRadius: 0 } as any,
                        { label: 'Thresh2 (Ref2 Threshold)', data: thresh2Data, borderColor: currentTheme.thresh2Line, backgroundColor: 'transparent', borderDash: [10, 5], borderWidth: 2, fill: false, tension: 0, pointRadius: 0 } as any,
                        { label: 'Thresh1 + Hys', data: thresh1HysUpperData, borderColor: currentTheme.hysteresisLine, backgroundColor: 'transparent', borderDash: [5, 3], borderWidth: 1, fill: false, tension: 0, pointRadius: 0 } as any,
                        { label: 'Thresh1 - Hys', data: thresh1HysLowerData, borderColor: currentTheme.hysteresisLine, backgroundColor: 'transparent', borderDash: [5, 3], borderWidth: 1, fill: false, tension: 0, pointRadius: 0 } as any,
                        { label: 'Thresh2 + Hys', data: thresh2HysUpperData, borderColor: currentTheme.hysteresisLine, backgroundColor: 'transparent', borderDash: [5, 3], borderWidth: 1, fill: false, tension: 0, pointRadius: 0 } as any,
                        { label: 'Thresh2 - Hys', data: thresh2HysLowerData, borderColor: currentTheme.hysteresisLine, backgroundColor: 'transparent', borderDash: [5, 3], borderWidth: 1, fill: false, tension: 0, pointRadius: 0 } as any
                    )
                } else {
                    // Êõ¥Êñ∞ÁèæÊúâÈñÄÊ™ªÁ∑öÊï∏Êìö
                    if (chart.data.datasets[2]) chart.data.datasets[2].data = thresh1Data
                    if (chart.data.datasets[3]) chart.data.datasets[3].data = thresh2Data
                    if (chart.data.datasets[4]) chart.data.datasets[4].data = thresh1HysUpperData
                    if (chart.data.datasets[5]) chart.data.datasets[5].data = thresh1HysLowerData
                    if (chart.data.datasets[6]) chart.data.datasets[6].data = thresh2HysUpperData
                    if (chart.data.datasets[7]) chart.data.datasets[7].data = thresh2HysLowerData
                }
            } else {
                // Èö±ËóèÈñÄÊ™ªÁ∑öÔºåÂè™‰øùÁïôË∑ùÈõ¢Êõ≤Á∑ö
                if (chart.data.datasets.length > 2) {
                    chart.data.datasets = chart.data.datasets.slice(0, 2)
                }
            }

            // Êõ¥Êñ∞È°èËâ≤‰∏ªÈ°å
            chart.data.datasets[0].borderColor = currentTheme.distance1Line
            chart.data.datasets[1].borderColor = currentTheme.distance2Line
            if (chart.data.datasets[2]) chart.data.datasets[2].borderColor = currentTheme.thresh1Line
            if (chart.data.datasets[3]) chart.data.datasets[3].borderColor = currentTheme.thresh2Line
            if (chart.data.datasets[4]) chart.data.datasets[4].borderColor = currentTheme.hysteresisLine
            if (chart.data.datasets[5]) chart.data.datasets[5].borderColor = currentTheme.hysteresisLine
            if (chart.data.datasets[6]) chart.data.datasets[6].borderColor = currentTheme.hysteresisLine
            if (chart.data.datasets[7]) chart.data.datasets[7].borderColor = currentTheme.hysteresisLine

            // Êõ¥Êñ∞ÂúñË°®ÈÅ∏È†ÖÁöÑÈ°èËâ≤
            if (chart.options.plugins?.legend?.labels) {
                chart.options.plugins.legend.labels.color = currentTheme.text
            }
            if (chart.options.plugins?.legend) {
                chart.options.plugins.legend.display = showThresholdLines
            }
            if (chart.options.plugins?.title) {
                chart.options.plugins.title.color = currentTheme.title
            }
            if ((chart.options.scales?.x as any)?.title) {
                ;(chart.options.scales.x as any).title.color = currentTheme.text
            }
            if ((chart.options.scales?.x as any)?.ticks) {
                ;(chart.options.scales.x as any).ticks.color = currentTheme.text
            }
            if ((chart.options.scales?.x as any)?.grid) {
                ;(chart.options.scales.x as any).grid.color = currentTheme.grid
            }
            if ((chart.options.scales?.y as any)?.title) {
                ;(chart.options.scales.y as any).title.color = currentTheme.text
            }
            if ((chart.options.scales?.y as any)?.ticks) {
                ;(chart.options.scales.y as any).ticks.color = currentTheme.text
            }
            if ((chart.options.scales?.y as any)?.grid) {
                ;(chart.options.scales.y as any).grid.color = currentTheme.grid
            }

            // Êõ¥Êñ∞ÂúñË°® - ‰ΩøÁî® 'none' ÈÅøÂÖçÂãïÁï´
            chart.update('none')
            console.log('‚úÖ [PureD1Chart] ÂúñË°®Êõ¥Êñ∞ÂÆåÊàê')
        }, [thresh1, thresh2, hysteresis, currentTheme, showThresholdLines])

        return (
            <div
                style={{
                    width: '100%',
                    height: '100%',
                    minHeight: '400px',
                    maxHeight: '80vh',
                    position: 'relative',
                    backgroundColor: currentTheme.background,
                    borderRadius: '8px',
                }}
            >
                <canvas
                    ref={canvasRef}
                    style={{ width: '100%', height: '100%' }}
                />
            </div>
        )
    }
)

PureD1Chart.displayName = 'PureD1Chart'

export default PureD1Chart