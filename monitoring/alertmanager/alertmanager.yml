# AlertManager é…ç½®æ–‡ä»¶
# éšæ®µ8ï¼šNTN Stack å‘Šè­¦ç®¡ç†é…ç½®

global:
  # SMTP é…ç½® (æ ¹æ“šå¯¦éš›ç’°å¢ƒé…ç½®)
  smtp_smarthost: 'localhost:587'
  smtp_from: 'ntn-alerts@example.com'
  smtp_auth_username: 'ntn-alerts@example.com'
  smtp_auth_password: 'your-email-password'
  
  # Slack å…¨å±€é…ç½®
  slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

# æŠ‘åˆ¶é‡è¤‡å‘Šè­¦çš„è¦å‰‡
inhibit_rules:
  # å¦‚æœæœ‰ critical å‘Šè­¦ï¼ŒæŠ‘åˆ¶ç›¸åŒæœå‹™çš„ warning å‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'component']

  # å¦‚æœç³»çµ±æ•´é«”æ•…éšœï¼ŒæŠ‘åˆ¶å€‹åˆ¥çµ„ä»¶å‘Šè­¦
  - source_match:
      alertname: 'SystemDown'
    target_match_re:
      alertname: '.*(Down|Unavailable|Failed).*'
    equal: ['instance']

# å‘Šè­¦è·¯ç”±è¦å‰‡
route:
  group_by: ['alertname', 'service', 'severity']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default-team'
  
  routes:
    # AIæ±ºç­–å¼•æ“ç›¸é—œå‘Šè­¦ - æœ€é«˜å„ªå…ˆç´š
    - match:
        service: 'ai-decision-integration'
      receiver: 'ai-team-critical'
      group_wait: 5s
      group_interval: 30s
      repeat_interval: 15m
      routes:
        - match:
            severity: 'critical'
          receiver: 'ai-team-emergency'
          group_wait: 0s
          repeat_interval: 5m

    # RLè¨“ç·´ç›¸é—œå‘Šè­¦
    - match:
        service: 'rl-training'
      receiver: 'ml-team'
      group_wait: 30s
      repeat_interval: 2h

    # åŸºç¤è¨­æ–½å‘Šè­¦
    - match_re:
        service: '(redis|postgres|prometheus|grafana)'
      receiver: 'infrastructure-team'
      group_wait: 1m
      repeat_interval: 4h

    # ç³»çµ±è³‡æºå‘Šè­¦
    - match_re:
        alertname: '.*(CPU|Memory|Disk|Network).*'
      receiver: 'ops-team'
      group_wait: 2m
      repeat_interval: 6h

    # ä½å„ªå…ˆç´šå‘Šè­¦
    - match:
        severity: 'info'
      receiver: 'monitoring-team'
      group_wait: 5m
      repeat_interval: 24h

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜èªåœ˜éšŠ
  - name: 'default-team'
    email_configs:
      - to: 'dev-team@example.com'
        subject: 'ã€NTN Stackã€‘{{ .GroupLabels.alertname }} - {{ .GroupLabels.severity }}'
        body: |
          {{ range .Alerts }}
          **å‘Šè­¦**: {{ .Annotations.summary }}
          **è©³æƒ…**: {{ .Annotations.description }}
          **æœå‹™**: {{ .Labels.service }}
          **åš´é‡æ€§**: {{ .Labels.severity }}
          **æ™‚é–“**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # AIæ±ºç­–å¼•æ“åœ˜éšŠ - é—œéµå‘Šè­¦
  - name: 'ai-team-critical'
    email_configs:
      - to: 'ai-team@example.com'
        subject: 'ğŸš¨ã€ç·Šæ€¥ã€‘AIæ±ºç­–å¼•æ“å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          ğŸš¨ **AIæ±ºç­–å¼•æ“é—œéµå‘Šè­¦**
          
          {{ range .Alerts }}
          **å‘Šè­¦åç¨±**: {{ .Annotations.summary }}
          **è©³ç´°æè¿°**: {{ .Annotations.description }}
          **å½±éŸ¿ç¯„åœ**: {{ .Labels.component }}
          **åš´é‡ç¨‹åº¦**: {{ .Labels.severity }}
          **é–‹å§‹æ™‚é–“**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          **Grafana**: http://localhost:3000/d/ai-decision-overview
          **Prometheus**: http://localhost:9090/alerts
          {{ end }}
    slack_configs:
      - channel: '#ai-alerts-critical'
        color: 'danger'
        title: 'ğŸš¨ AIæ±ºç­–å¼•æ“é—œéµå‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦*: {{ .Annotations.summary }}
          *æœå‹™*: {{ .Labels.service }}
          *çµ„ä»¶*: {{ .Labels.component }}
          *æ™‚é–“*: {{ .StartsAt.Format "15:04:05" }}
          {{ end }}

  # AIæ±ºç­–å¼•æ“åœ˜éšŠ - ç·Šæ€¥å‘Šè­¦
  - name: 'ai-team-emergency'
    email_configs:
      - to: 'ai-team@example.com,cto@example.com'
        subject: 'ğŸ”¥ã€ç·Šæ€¥æ•…éšœã€‘AIæ±ºç­–å¼•æ“ç³»çµ±æ•…éšœ - {{ .GroupLabels.alertname }}'
        body: |
          ğŸ”¥ **ç³»çµ±ç·Šæ€¥æ•…éšœé€šçŸ¥**
          
          AIæ±ºç­–å¼•æ“å‡ºç¾åš´é‡æ•…éšœï¼Œéœ€è¦ç«‹å³è™•ç†ï¼
          
          {{ range .Alerts }}
          **æ•…éšœæè¿°**: {{ .Annotations.summary }}
          **æŠ€è¡“è©³æƒ…**: {{ .Annotations.description }}
          **å½±éŸ¿çµ„ä»¶**: {{ .Labels.component }}
          **æ•…éšœé–‹å§‹**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          **é è¨ˆå½±éŸ¿**: è¡›æ˜Ÿæ›æ‰‹æ±ºç­–å¯èƒ½å—å½±éŸ¿
          
          **ç«‹å³è¡Œå‹•**:
          1. æª¢æŸ¥æœå‹™ç‹€æ…‹: `make status`
          2. æŸ¥çœ‹æ—¥èªŒ: `make logs`
          3. ç›£æ§å„€è¡¨æ¿: http://localhost:3000/d/ai-decision-overview
          {{ end }}
    slack_configs:
      - channel: '#incident-response'
        color: 'danger'
        title: 'ğŸ”¥ AIæ±ºç­–å¼•æ“ç·Šæ€¥æ•…éšœ'
        text: '@channel AIæ±ºç­–å¼•æ“å‡ºç¾åš´é‡æ•…éšœï¼Œéœ€è¦ç«‹å³éŸ¿æ‡‰ï¼'

  # æ©Ÿå™¨å­¸ç¿’åœ˜éšŠ
  - name: 'ml-team'
    email_configs:
      - to: 'ml-team@example.com'
        subject: 'ã€ML Alertã€‘RLè¨“ç·´å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          **RLè¨“ç·´ç³»çµ±å‘Šè­¦**
          
          {{ range .Alerts }}
          **å‘Šè­¦**: {{ .Annotations.summary }}
          **ç®—æ³•**: {{ .Labels.algorithm }}
          **æŒ‡æ¨™**: {{ .Labels.metric }}
          **æ™‚é–“**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # åŸºç¤è¨­æ–½åœ˜éšŠ
  - name: 'infrastructure-team'
    email_configs:
      - to: 'ops@example.com'
        subject: 'ã€åŸºç¤è¨­æ–½ã€‘{{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}'

  # é‹ç¶­åœ˜éšŠ
  - name: 'ops-team'
    email_configs:
      - to: 'ops@example.com'
        subject: 'ã€ç³»çµ±è³‡æºã€‘{{ .GroupLabels.alertname }}'

  # ç›£æ§åœ˜éšŠ
  - name: 'monitoring-team'
    email_configs:
      - to: 'monitoring@example.com'
        subject: 'ã€ç›£æ§ä¿¡æ¯ã€‘{{ .GroupLabels.alertname }}'

# å‘Šè­¦æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'