# ç³»çµ±è³‡æºå‘Šè­¦è¦å‰‡
# éšæ®µ8ï¼šåŸºç¤è¨­æ–½å’Œç³»çµ±è³‡æºç›£æ§

groups:
  - name: system_resources
    interval: 30s
    rules:
      # ğŸš¨ CPUä½¿ç”¨ç‡éé«˜
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          component: system-resources
        annotations:
          summary: "CPUä½¿ç”¨ç‡éé«˜"
          description: "å¯¦ä¾‹ {{ $labels.instance }} CPUä½¿ç”¨ç‡é”åˆ° {{ printf "%.1f%%" $value }}"

      # ğŸ”¥ CPUä½¿ç”¨ç‡æ¥µé«˜
      - alert: CriticalCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
          component: system-resources
        annotations:
          summary: "CPUä½¿ç”¨ç‡æ¥µé«˜"
          description: "å¯¦ä¾‹ {{ $labels.instance }} CPUä½¿ç”¨ç‡é”åˆ° {{ printf "%.1f%%" $value }}ï¼Œç³»çµ±éŸ¿æ‡‰å¯èƒ½å—å½±éŸ¿"

      # ğŸš¨ è¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          component: system-resources
        annotations:
          summary: "è¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜"
          description: "å¯¦ä¾‹ {{ $labels.instance }} è¨˜æ†¶é«”ä½¿ç”¨ç‡é”åˆ° {{ printf "%.1f%%" $value }}"

      # ğŸ”¥ è¨˜æ†¶é«”ä½¿ç”¨ç‡æ¥µé«˜
      - alert: CriticalMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 95
        for: 2m
        labels:
          severity: critical
          component: system-resources
        annotations:
          summary: "è¨˜æ†¶é«”ä½¿ç”¨ç‡æ¥µé«˜"
          description: "å¯¦ä¾‹ {{ $labels.instance }} è¨˜æ†¶é«”ä½¿ç”¨ç‡é”åˆ° {{ printf "%.1f%%" $value }}ï¼Œå¯èƒ½å°è‡´ç³»çµ±ä¸ç©©å®š"

      # ğŸš¨ ç£ç¢Ÿç©ºé–“ä¸è¶³
      - alert: DiskSpaceLow
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 85
        for: 5m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "ç£ç¢Ÿç©ºé–“ä¸è¶³"
          description: "å¯¦ä¾‹ {{ $labels.instance }} ç£ç¢Ÿ {{ $labels.mountpoint }} ä½¿ç”¨ç‡é”åˆ° {{ printf "%.1f%%" $value }}"

      # ğŸ”¥ ç£ç¢Ÿç©ºé–“åš´é‡ä¸è¶³
      - alert: DiskSpaceCritical
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 95
        for: 2m
        labels:
          severity: critical
          component: storage
        annotations:
          summary: "ç£ç¢Ÿç©ºé–“åš´é‡ä¸è¶³"
          description: "å¯¦ä¾‹ {{ $labels.instance }} ç£ç¢Ÿ {{ $labels.mountpoint }} ä½¿ç”¨ç‡é”åˆ° {{ printf "%.1f%%" $value }}ï¼Œéœ€è¦ç«‹å³æ¸…ç†"

  - name: container_resources
    interval: 30s
    rules:
      # ğŸš¨ å®¹å™¨è¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜
      - alert: ContainerHighMemoryUsage
        expr: (container_memory_usage_bytes{name!=""} / container_spec_memory_limit_bytes{name!=""}) * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: containers
        annotations:
          summary: "å®¹å™¨è¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜"
          description: "å®¹å™¨ {{ $labels.name }} è¨˜æ†¶é«”ä½¿ç”¨ç‡é”åˆ° {{ printf "%.1f%%" $value }}"

      # ğŸš¨ å®¹å™¨CPUä½¿ç”¨ç‡éé«˜
      - alert: ContainerHighCPUUsage
        expr: rate(container_cpu_usage_seconds_total{name!=""}[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: containers
        annotations:
          summary: "å®¹å™¨CPUä½¿ç”¨ç‡éé«˜"
          description: "å®¹å™¨ {{ $labels.name }} CPUä½¿ç”¨ç‡é”åˆ° {{ printf "%.1f%%" $value }}"

      # ğŸ”¥ å®¹å™¨é‡å•Ÿéæ–¼é »ç¹
      - alert: ContainerRestartingFrequently
        expr: rate(container_restarts_total{name!=""}[1h]) > 0.1  # 1å°æ™‚å…§é‡å•Ÿè¶…é0.1æ¬¡
        for: 15m
        labels:
          severity: critical
          component: containers
        annotations:
          summary: "å®¹å™¨é‡å•Ÿé »ç¹"
          description: "å®¹å™¨ {{ $labels.name }} æœ€è¿‘1å°æ™‚é‡å•Ÿ {{ $value }} æ¬¡ï¼Œå¯èƒ½å­˜åœ¨å•é¡Œ"

  - name: network_monitoring
    interval: 60s
    rules:
      # ğŸŸ¡ ç¶²è·¯æµé‡ç•°å¸¸
      - alert: HighNetworkTraffic
        expr: rate(node_network_receive_bytes_total[5m]) > 100 * 1024 * 1024  # 100MB/s
        for: 10m
        labels:
          severity: info
          component: network
        annotations:
          summary: "ç¶²è·¯æ¥æ”¶æµé‡éé«˜"
          description: "å¯¦ä¾‹ {{ $labels.instance }} ä»‹é¢ {{ $labels.device }} æ¥æ”¶æµé‡é”åˆ° {{ printf "%.2f" $value }}/s"

      # ğŸš¨ ç¶²è·¯éŒ¯èª¤ç‡éé«˜
      - alert: HighNetworkErrors
        expr: rate(node_network_receive_errs_total[5m]) + rate(node_network_transmit_errs_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "ç¶²è·¯éŒ¯èª¤ç‡éé«˜"
          description: "å¯¦ä¾‹ {{ $labels.instance }} ä»‹é¢ {{ $labels.device }} ç¶²è·¯éŒ¯èª¤ç‡é”åˆ° {{ $value }} éŒ¯èª¤/ç§’"

  - name: database_monitoring
    interval: 30s
    rules:
      # ğŸš¨ Redisé€£æ¥æ•¸éé«˜
      - alert: RedisHighConnections
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: warning
          service: redis
          component: connections
        annotations:
          summary: "Redisé€£æ¥æ•¸éé«˜"
          description: "Rediså¯¦ä¾‹ {{ $labels.instance }} é€£æ¥æ•¸é”åˆ° {{ $value }}ï¼Œè¶…é100å€‹é€£æ¥"

      # ğŸš¨ Redisè¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜
      - alert: RedisHighMemoryUsage
        expr: (redis_memory_used_bytes / redis_memory_max_bytes) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: redis
          component: memory
        annotations:
          summary: "Redisè¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜"
          description: "Rediså¯¦ä¾‹ {{ $labels.instance }} è¨˜æ†¶é«”ä½¿ç”¨ç‡é”åˆ° {{ printf "%.1f%%" $value }}"

      # ğŸš¨ PostgreSQLé€£æ¥æ•¸éé«˜
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends > 80
        for: 5m
        labels:
          severity: warning
          service: postgresql
          component: connections
        annotations:
          summary: "PostgreSQLé€£æ¥æ•¸éé«˜"
          description: "PostgreSQLæ•¸æ“šåº« {{ $labels.datname }} é€£æ¥æ•¸é”åˆ° {{ $value }}"

      # ğŸš¨ PostgreSQLæ…¢æŸ¥è©¢éå¤š
      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_database_slow_queries[5m]) > 5
        for: 3m
        labels:
          severity: warning
          service: postgresql
          component: performance
        annotations:
          summary: "PostgreSQLæ…¢æŸ¥è©¢éå¤š"
          description: "PostgreSQLæ•¸æ“šåº« {{ $labels.datname }} æ…¢æŸ¥è©¢ç‡é”åˆ° {{ $value }} æ¬¡/ç§’"

  - name: service_health
    interval: 30s
    rules:
      # ğŸ”¥ æœå‹™å®Œå…¨ä¸å¯ç”¨
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          component: service-health
        annotations:
          summary: "æœå‹™ä¸å¯ç”¨"
          description: "æœå‹™ {{ $labels.job }} å¯¦ä¾‹ {{ $labels.instance }} ä¸å¯ç”¨"
          action_required: "ç«‹å³æª¢æŸ¥æœå‹™ç‹€æ…‹"

      # ğŸš¨ HTTPéŒ¯èª¤ç‡éé«˜
      - alert: HighHTTPErrorRate
        expr: |
          (
            rate(http_requests_total{status=~"4..|5.."}[5m]) /
            rate(http_requests_total[5m])
          ) * 100 > 10
        for: 5m
        labels:
          severity: warning
          component: http-errors
        annotations:
          summary: "HTTPéŒ¯èª¤ç‡éé«˜"
          description: "æœå‹™ {{ $labels.service }} HTTPéŒ¯èª¤ç‡é”åˆ° {{ printf "%.1f%%" $value }}"

      # ğŸŸ¡ HTTPéŸ¿æ‡‰æ™‚é–“éé•·
      - alert: HighHTTPLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 10m
        labels:
          severity: info
          component: http-latency
        annotations:
          summary: "HTTPéŸ¿æ‡‰æ™‚é–“éé•·"
          description: "æœå‹™ {{ $labels.service }} 95%ä½éŸ¿æ‡‰æ™‚é–“é”åˆ° {{ printf "%.2fs" $value }}"