# è¡›æ˜Ÿè™•ç†ç³»çµ± - æ¸¬è©¦å°ˆç”¨ Makefile
# ğŸ§ª TDDé‡æ§‹æ¸¬è©¦è‡ªå‹•åŒ–å‘½ä»¤

.PHONY: help test-runner test-sgp4 test-fast test-coverage check lint performance dev-check test-status clean-test

# é è¨­ç›®æ¨™
.DEFAULT_GOAL := help

# é¡è‰²å®šç¾©
BLUE = \033[0;34m
GREEN = \033[0;32m
YELLOW = \033[1;33m
NC = \033[0m

help: ## é¡¯ç¤ºæ‰€æœ‰å¯ç”¨æ¸¬è©¦å‘½ä»¤
	@echo "$(BLUE)ğŸ§ª è¡›æ˜Ÿè™•ç†ç³»çµ± - æ¸¬è©¦å‘½ä»¤$(NC)"
	@echo "================================================================"
	@echo "$(YELLOW)test-runner$(NC)      åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶ (æ¨è–¦)"
	@echo "$(YELLOW)test-sgp4$(NC)        åƒ…åŸ·è¡ŒSGP4è»Œé“å¼•æ“æ¸¬è©¦"
	@echo "$(YELLOW)test-fast$(NC)        å¿«é€Ÿæ¸¬è©¦ (åƒ…é—œéµæ¸¬è©¦)"
	@echo "$(YELLOW)test-coverage$(NC)    ç”Ÿæˆæ¸¬è©¦è¦†è“‹ç‡å ±å‘Š"
	@echo "$(YELLOW)check$(NC)            åŸ·è¡Œé æäº¤æª¢æŸ¥"
	@echo "$(YELLOW)performance$(NC)      åŸ·è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦"
	@echo "$(YELLOW)dev-check$(NC)        é–‹ç™¼æª¢æŸ¥ (é æäº¤ + æ ¸å¿ƒæ¸¬è©¦)"
	@echo "$(YELLOW)test-status$(NC)      é¡¯ç¤ºæ¸¬è©¦ç’°å¢ƒç‹€æ…‹"
	@echo ""

# æ¸¬è©¦ç›¸é—œå‘½ä»¤
test-runner: ## åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
	@echo "$(BLUE)ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶$(NC)"
	@./scripts/test-runner.sh

test-sgp4: ## SGP4æ¸¬è©¦
	@echo "$(BLUE)ğŸ›°ï¸ åŸ·è¡ŒSGP4æ¸¬è©¦$(NC)"
	python -m pytest tests/unit/algorithms/test_sgp4_orbital_engine.py -v

test-fast: ## å¿«é€Ÿæ¸¬è©¦
	@echo "$(BLUE)âš¡ å¿«é€Ÿæ¸¬è©¦$(NC)"
	python -m pytest tests/unit/algorithms/test_sgp4_orbital_engine.py::TestSGP4OrbitalEngine::test_tle_epoch_time_usage_mandatory -v

test-coverage: ## è¦†è“‹ç‡æ¸¬è©¦
	@echo "$(BLUE)ğŸ“Š ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š$(NC)"
	python -m pytest tests/unit/ --cov=src --cov-report=html:tests/reports/coverage_html --cov-report=term-missing
	@echo "$(GREEN)ğŸ“ˆ è¦†è“‹ç‡å ±å‘Š: tests/reports/coverage_html/index.html$(NC)"

check: ## é æäº¤æª¢æŸ¥
	@echo "$(BLUE)ğŸ›¡ï¸ åŸ·è¡Œé æäº¤æª¢æŸ¥$(NC)"
	@./scripts/pre-commit-check.sh

performance: ## æ€§èƒ½æ¸¬è©¦
	@echo "$(BLUE)âš¡ æ€§èƒ½åŸºæº–æ¸¬è©¦$(NC)"
	python -m pytest tests/unit/algorithms/test_sgp4_orbital_engine.py::TestSGP4OrbitalEngine::test_sgp4_calculation_performance -v

dev-check: check test-sgp4 ## é–‹ç™¼æª¢æŸ¥
	@echo "$(GREEN)ğŸ‰ é–‹ç™¼æª¢æŸ¥å®Œæˆï¼$(NC)"

test-status: ## æ¸¬è©¦ç‹€æ…‹
	@echo "$(BLUE)ğŸ“Š æ¸¬è©¦ç’°å¢ƒç‹€æ…‹$(NC)"
	@echo "================================================================"
	@echo "Pythonç‰ˆæœ¬: $$(python --version)"
	@echo "pytestç‰ˆæœ¬: $$(python -m pytest --version 2>/dev/null || echo 'æœªå®‰è£')"
	@echo "TLEæ•¸æ“šæ–‡ä»¶: $$(ls data/tle_data/starlink/tle/*.tle 2>/dev/null | wc -l) å€‹"
	@echo "Git hooks: $$([ -x ../.git/hooks/pre-commit ] && echo 'å·²é…ç½®' || echo 'æœªé…ç½®')"
	@echo "================================================================"

clean-test: ## æ¸…ç†æ¸¬è©¦æ–‡ä»¶
	@echo "$(BLUE)ğŸ§¹ æ¸…ç†æ¸¬è©¦æ–‡ä»¶$(NC)"
	rm -rf tests/reports/ .pytest_cache/ __pycache__/ src/__pycache__/ tests/__pycache__/ .coverage
	find . -name "*.pyc" -delete 2>/dev/null || true
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(NC)"
