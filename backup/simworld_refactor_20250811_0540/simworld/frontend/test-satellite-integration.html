<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>衛星渲染整合測試</title>
    <style>
        body { font-family: 'Courier New', monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #0f0; }
        .test-result { margin: 10px 0; padding: 5px; }
        .pass { color: #0f0; }
        .fail { color: #f00; }
        .info { color: #ff0; }
        button { background: #0f0; color: #000; padding: 10px 20px; margin: 5px; border: none; cursor: pointer; }
        button:hover { background: #0a0; }
    </style>
</head>
<body>
    <h1>🛰️ 衛星渲染整合測試面板</h1>
    
    <div class="test-section">
        <h2>1. API 連接測試</h2>
        <button onclick="testAPI()">測試 API</button>
        <div id="api-result"></div>
    </div>

    <div class="test-section">
        <h2>2. 衛星數據測試</h2>
        <button onclick="testSatelliteData()">獲取衛星數據</button>
        <div id="satellite-result"></div>
    </div>

    <div class="test-section">
        <h2>3. 速度控制測試</h2>
        <input type="range" id="speed-slider" min="1" max="60" value="1" step="1">
        <span id="speed-value">1x</span>
        <button onclick="testSpeedControl()">應用速度</button>
        <div id="speed-result"></div>
    </div>

    <div class="test-section">
        <h2>4. 真實軌跡驗證</h2>
        <button onclick="verifyTrajectory()">驗證軌跡數據</button>
        <div id="trajectory-result"></div>
    </div>

    <script>
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        
        speedSlider.oninput = function() {
            speedValue.textContent = this.value + 'x';
        };

        async function testAPI() {
            const result = document.getElementById('api-result');
            result.innerHTML = '<div class="info">測試中...</div>';
            
            try {
                // Test NetStack health
                const netstackResponse = await fetch('/netstack/health');
                const netstackOk = netstackResponse.ok;
                
                // Test SimWorld API
                const simworldResponse = await fetch('/api/v1/satellites/visible_satellites?count=1&min_elevation_deg=5&observer_lat=24.9441667&observer_lon=121.3713889&global_view=false&constellation=starlink');
                const simworldOk = simworldResponse.ok;
                
                result.innerHTML = `
                    <div class="${netstackOk ? 'pass' : 'fail'}">✅ NetStack API: ${netstackOk ? '正常' : '錯誤'}</div>
                    <div class="${simworldOk ? 'pass' : 'fail'}">✅ SimWorld API: ${simworldOk ? '正常' : '錯誤'}</div>
                `;
            } catch (error) {
                result.innerHTML = `<div class="fail">❌ API 測試失敗: ${error.message}</div>`;
            }
        }

        async function testSatelliteData() {
            const result = document.getElementById('satellite-result');
            result.innerHTML = '<div class="info">載入中...</div>';
            
            try {
                const response = await fetch('/api/v1/satellites/visible_satellites?count=10&min_elevation_deg=5&observer_lat=24.9441667&observer_lon=121.3713889&global_view=false&constellation=starlink');
                const data = await response.json();
                
                if (data.satellites && data.satellites.length > 0) {
                    const sat = data.satellites[0];
                    result.innerHTML = `
                        <div class="pass">✅ 獲取 ${data.satellites.length} 顆衛星</div>
                        <div class="info">第一顆衛星:</div>
                        <div class="info">- 名稱: ${sat.name}</div>
                        <div class="info">- 仰角: ${sat.elevation_deg?.toFixed(2)}°</div>
                        <div class="info">- 方位角: ${sat.azimuth_deg?.toFixed(2)}°</div>
                        <div class="info">- 距離: ${sat.distance_km?.toFixed(1)} km</div>
                    `;
                } else {
                    result.innerHTML = '<div class="fail">❌ 沒有衛星數據</div>';
                }
            } catch (error) {
                result.innerHTML = `<div class="fail">❌ 載入失敗: ${error.message}</div>`;
            }
        }

        function testSpeedControl() {
            const speed = speedSlider.value;
            const result = document.getElementById('speed-result');
            
            // 模擬發送速度更新到前端
            result.innerHTML = `
                <div class="pass">✅ 速度設定為 ${speed}x</div>
                <div class="info">預期行為:</div>
                <div class="info">- 衛星移動速度應該是 ${speed} 倍</div>
                <div class="info">- 10分鐘軌跡將在 ${(600/speed).toFixed(1)} 秒內完成</div>
            `;
            
            // 實際應用需要通過 WebSocket 或其他機制通知前端
            console.log('Speed updated to:', speed);
        }

        async function verifyTrajectory() {
            const result = document.getElementById('trajectory-result');
            result.innerHTML = '<div class="info">驗證中...</div>';
            
            try {
                const response = await fetch('/api/v1/satellites/visible_satellites?count=5&min_elevation_deg=5&observer_lat=24.9441667&observer_lon=121.3713889&global_view=false&constellation=starlink');
                const data = await response.json();
                
                if (data.satellites && data.satellites.length > 0) {
                    let trajectoryInfo = '<div class="pass">✅ 軌跡數據驗證</div>';
                    
                    data.satellites.forEach((sat, index) => {
                        trajectoryInfo += `
                            <div class="info">衛星 ${index + 1} (${sat.name}):</div>
                            <div class="info">- 基礎仰角: ${sat.elevation_deg?.toFixed(2)}°</div>
                            <div class="info">- 預期變化: ±8° (正弦波)</div>
                            <div class="info">- 方位角變化: 45° (10分鐘內)</div>
                            <div class="info">- 距離振盪: ±50km</div>
                        `;
                    });
                    
                    result.innerHTML = trajectoryInfo;
                } else {
                    result.innerHTML = '<div class="fail">❌ 無法獲取軌跡數據</div>';
                }
            } catch (error) {
                result.innerHTML = `<div class="fail">❌ 驗證失敗: ${error.message}</div>`;
            }
        }

        // 自動運行初始測試
        window.onload = () => {
            console.log('🛰️ 衛星渲染整合測試面板已載入');
            console.log('請打開 http://localhost:5173/test-satellite-integration.html 查看測試結果');
        };
    </script>
</body>
</html>