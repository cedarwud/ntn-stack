# é›™æ˜Ÿåº§åˆ‡æ›å¯¦æ–½æ–¹æ¡ˆ

## ğŸ¯ é›™æ˜Ÿåº§åˆ‡æ›æ•´åˆç›®æ¨™

å¯¦ç¾ Starlink èˆ‡ OneWeb æ˜Ÿåº§ä¹‹é–“çš„ç„¡ç¸«åˆ‡æ›åŠŸèƒ½ï¼Œç‚º D2 äº‹ä»¶åˆ†ææä¾›å¤šæ˜Ÿåº§å°æ¯”èƒ½åŠ›ï¼Œæ”¯æ´ä¸åŒè»Œé“ç‰¹æ€§çš„æ›æ‰‹è¡Œç‚ºç ”ç©¶ã€‚

### æ ¸å¿ƒéœ€æ±‚
- **å³æ™‚æ˜Ÿåº§åˆ‡æ›**: ç”¨æˆ¶å¯åœ¨ Starlink å’Œ OneWeb ä¹‹é–“å³æ™‚åˆ‡æ›
- **æ•¸æ“šä¸€è‡´æ€§**: ç¢ºä¿åˆ‡æ›æ™‚ D2 æ¸¬é‡æ•¸æ“šçš„é€£çºŒæ€§å’Œæº–ç¢ºæ€§
- **3DåŒæ­¥é¡¯ç¤º**: æ˜Ÿåº§åˆ‡æ›æ™‚ 3D ç«‹é«”åœ–åŒæ­¥æ›´æ–°è¡›æ˜Ÿè»Œé“
- **æ€§èƒ½å„ªåŒ–**: åˆ‡æ›éŸ¿æ‡‰æ™‚é–“ <2ç§’ï¼Œç„¡æ˜é¡¯å»¶é²

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹è¨­è¨ˆ

### é›™æ˜Ÿåº§æ•¸æ“šç®¡ç†æ¶æ§‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ çµ±ä¸€æ˜Ÿåº§ç®¡ç†å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                              â”‚
â”‚  ConstellationManager                        â”‚
â”‚  â”œâ”€â”€ activeConstellation: 'starlink'|'oneweb'â”‚
â”‚  â”œâ”€â”€ dataCache: Map<constellation, data>     â”‚
â”‚  â””â”€â”€ switchController: SwitchController      â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Starlink æ•¸æ“š  â”‚  â”‚ OneWeb æ•¸æ“š  â”‚
      â”‚ - 40é¡†ç²¾é¸è¡›æ˜Ÿ â”‚  â”‚ - 30é¡†ç²¾é¸è¡›æ˜Ÿâ”‚
      â”‚ - 550kmè»Œé“   â”‚  â”‚ - 1200kmè»Œé“ â”‚
      â”‚ - 53Â°å‚¾è§’     â”‚  â”‚ - 87Â°å‚¾è§’    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚             â”‚
               â–¼             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚     çµ±ä¸€ D2 äº‹ä»¶è™•ç†å¼•æ“         â”‚
      â”‚ - SGP4 ç²¾ç¢ºè»Œé“è¨ˆç®—             â”‚
      â”‚ - 120åˆ†é˜æ™‚é–“åºåˆ—               â”‚
      â”‚ - çµ±ä¸€æ•¸æ“šæ ¼å¼                  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ˜Ÿåº§ç‰¹æ€§å°æ¯”åˆ†æ

| ç‰¹æ€§æŒ‡æ¨™ | Starlink | OneWeb | å°æ¯”åˆ†æ |
|----------|----------|---------|----------|
| **è»Œé“é«˜åº¦** | 550km | 1200km | OneWeb æ›´é«˜ï¼Œä¿¡è™Ÿå»¶é²ç•¥å¢ |
| **è»Œé“å‚¾è§’** | 53Â° | 87Â° | OneWeb è¿‘æ¥µåœ°ï¼Œè¦†è“‹ç¯„åœæ›´å»£ |
| **è¡›æ˜Ÿå¯†åº¦** | 7,992é¡† | 651é¡† | Starlink é«˜å¯†åº¦ï¼Œæ›æ‰‹é »ç¹ |
| **æ›æ‰‹ç‰¹æ€§** | å¿«é€Ÿæ›æ‰‹ | ç©©å®šé€£æ¥ | ä¸åŒçš„æ›æ‰‹è¡Œç‚ºæ¨¡å¼ |
| **å°ç£è¦†è“‹** | è‰¯å¥½ | å„ªç§€ | OneWeb æ¥µåœ°è»Œé“å„ªå‹¢æ˜é¡¯ |
| **ç ”ç©¶åƒ¹å€¼** | é«˜å¯†åº¦åˆ†æ | ç©©å®šæ€§ç ”ç©¶ | äº’è£œçš„ç ”ç©¶å ´æ™¯ |

## ğŸ”§ å‰ç«¯å¯¦æ–½æ–¹æ¡ˆ

### æ˜Ÿåº§åˆ‡æ›æ§åˆ¶çµ„ä»¶
```typescript
// æ–°å»º: ConstellationSwitcher.tsx
interface ConstellationSwitcherProps {
    currentConstellation: 'starlink' | 'oneweb'
    onSwitch: (constellation: string) => Promise<void>
    isLoading: boolean
    availableData: {
        starlink: { satellites: number, lastUpdate: string }
        oneweb: { satellites: number, lastUpdate: string }
    }
}

export const ConstellationSwitcher: React.FC<ConstellationSwitcherProps> = ({
    currentConstellation,
    onSwitch,
    isLoading,
    availableData
}) => {
    return (
        <div className="constellation-switcher-panel">
            <h4>ğŸ›°ï¸ æ˜Ÿåº§é¸æ“‡</h4>
            
            <div className="constellation-options">
                <div className="constellation-option starlink">
                    <input 
                        type="radio"
                        id="starlink"
                        name="constellation"
                        value="starlink"
                        checked={currentConstellation === 'starlink'}
                        onChange={() => onSwitch('starlink')}
                        disabled={isLoading}
                    />
                    <label htmlFor="starlink">
                        <div className="constellation-header">
                            <span className="constellation-name">Starlink</span>
                            <span className="constellation-badge starlink-badge">LEO</span>
                        </div>
                        <div className="constellation-details">
                            <p>ğŸŒ è»Œé“é«˜åº¦: 550km</p>
                            <p>ğŸ“ è»Œé“å‚¾è§’: 53Â°</p>
                            <p>ğŸ›°ï¸ å¯ç”¨è¡›æ˜Ÿ: {availableData.starlink.satellites}é¡†</p>
                            <p>â° æ›´æ–°æ™‚é–“: {availableData.starlink.lastUpdate}</p>
                        </div>
                        <div className="constellation-characteristics">
                            <span className="char-tag">é«˜å¯†åº¦</span>
                            <span className="char-tag">å¿«é€Ÿæ›æ‰‹</span>
                        </div>
                    </label>
                </div>
                
                <div className="constellation-option oneweb">
                    <input 
                        type="radio"
                        id="oneweb"
                        name="constellation"
                        value="oneweb"
                        checked={currentConstellation === 'oneweb'}
                        onChange={() => onSwitch('oneweb')}
                        disabled={isLoading}
                    />
                    <label htmlFor="oneweb">
                        <div className="constellation-header">
                            <span className="constellation-name">OneWeb</span>
                            <span className="constellation-badge oneweb-badge">MEO</span>
                        </div>
                        <div className="constellation-details">
                            <p>ğŸŒ è»Œé“é«˜åº¦: 1200km</p>
                            <p>ğŸ“ è»Œé“å‚¾è§’: 87Â°</p>
                            <p>ğŸ›°ï¸ å¯ç”¨è¡›æ˜Ÿ: {availableData.oneweb.satellites}é¡†</p>
                            <p>â° æ›´æ–°æ™‚é–“: {availableData.oneweb.lastUpdate}</p>
                        </div>
                        <div className="constellation-characteristics">
                            <span className="char-tag">æ¥µåœ°è¦†è“‹</span>
                            <span className="char-tag">ç©©å®šé€£æ¥</span>
                        </div>
                    </label>
                </div>
            </div>
            
            {isLoading && (
                <div className="switching-loader">
                    <div className="spinner"></div>
                    <p>æ­£åœ¨åˆ‡æ›æ˜Ÿåº§æ•¸æ“š...</p>
                </div>
            )}
            
            <div className="switching-stats">
                <h5>ğŸ’¡ æ˜Ÿåº§å°æ¯”åˆ†æ</h5>
                <div className="comparison-grid">
                    <div className="comparison-item">
                        <span className="metric">æ›æ‰‹é »ç‡</span>
                        <span className="starlink-value">é«˜</span>
                        <span className="vs">vs</span>
                        <span className="oneweb-value">ä¸­</span>
                    </div>
                    <div className="comparison-item">
                        <span className="metric">ä¿¡è™Ÿç©©å®šæ€§</span>
                        <span className="starlink-value">ä¸­</span>
                        <span className="vs">vs</span>
                        <span className="oneweb-value">é«˜</span>
                    </div>
                    <div className="comparison-item">
                        <span className="metric">è¦†è“‹ç¯„åœ</span>
                        <span className="starlink-value">è‰¯å¥½</span>
                        <span className="vs">vs</span>
                        <span className="oneweb-value">å„ªç§€</span>
                    </div>
                </div>
            </div>
        </div>
    )
}
```

### D2åœ–è¡¨åˆ‡æ›æ•´åˆ
```typescript
// ä¿®æ”¹: EnhancedD2Chart.tsx 
export const EnhancedD2Chart: React.FC<D2ChartProps> = (props) => {
    const [constellation, setConstellation] = useState<'starlink' | 'oneweb'>('starlink')
    const [isLoadingSwitch, setIsLoadingSwitch] = useState(false)
    const [d2Data, setD2Data] = useState<D2TimeSeriesData>(null)
    
    // çµ±ä¸€æ™‚é–“æ§åˆ¶å™¨
    const timeController = useUnifiedTimeController()
    
    // æ˜Ÿåº§åˆ‡æ›è™•ç†
    const handleConstellationSwitch = useCallback(async (newConstellation: string) => {
        if (newConstellation === constellation) return
        
        setIsLoadingSwitch(true)
        
        try {
            // 1. æš«åœç•¶å‰å‹•ç•«
            timeController.pause()
            
            // 2. ç²å–æ–°æ˜Ÿåº§æ•¸æ“š
            const newData = await fetchD2Data({
                constellation: newConstellation,
                duration: 290,
                includeRawData: true
            })
            
            // 3. æ›´æ–°æ•¸æ“šå’Œç‹€æ…‹
            setD2Data(newData)
            setConstellation(newConstellation as 'starlink' | 'oneweb')
            
            // 4. é‡ç½®æ™‚é–“æ§åˆ¶å™¨
            timeController.reset()
            
            // 5. é€šçŸ¥ 3D è¦–åœ–åŒæ­¥åˆ‡æ›
            timeController.notifyConstellationChange(newConstellation)
            
            // 6. é‡æ–°é–‹å§‹æ’­æ”¾
            timeController.play()
            
        } catch (error) {
            console.error('æ˜Ÿåº§åˆ‡æ›å¤±æ•—:', error)
            // é¡¯ç¤ºéŒ¯èª¤æç¤º
        } finally {
            setIsLoadingSwitch(false)
        }
    }, [constellation, timeController])
    
    return (
        <div className="enhanced-d2-chart-container">
            {/* æ˜Ÿåº§åˆ‡æ›æ§åˆ¶å™¨ */}
            <ConstellationSwitcher
                currentConstellation={constellation}
                onSwitch={handleConstellationSwitch}
                isLoading={isLoadingSwitch}
                availableData={{
                    starlink: { satellites: 40, lastUpdate: d2Data?.metadata?.lastUpdate },
                    oneweb: { satellites: 30, lastUpdate: d2Data?.metadata?.lastUpdate }
                }}
            />
            
            {/* D2 åœ–è¡¨ä¸»é«” */}
            <div className="d2-chart-wrapper">
                <Chart
                    type="line"
                    data={generateChartData(d2Data, constellation)}
                    options={generateChartOptions(constellation)}
                />
                
                {/* æ•¸æ“šä¾†æºè³‡è¨Š */}
                <DataSourceInfoPanel
                    constellation={constellation}
                    dataMetadata={d2Data?.metadata}
                    sgp4Info={d2Data?.sgp4Info}
                />
            </div>
        </div>
    )
}
```

## ğŸŒ 3Dè¦–åœ–åŒæ­¥åˆ‡æ›

### 3Dæ˜Ÿåº§è¦–è¦ºåŒ–åˆ‡æ›
```typescript
// ä¿®æ”¹: Satellite3DVisualization.tsx
export const Satellite3DVisualization: React.FC<Satellite3DProps> = (props) => {
    const [constellation, setConstellation] = useState<'starlink' | 'oneweb'>('starlink')
    const [satelliteModels, setSatelliteModels] = useState<Map<string, THREE.Mesh>>(new Map())
    
    // çµ±ä¸€æ™‚é–“æ§åˆ¶å™¨
    const timeController = useUnifiedTimeController()
    
    // ç›£è½æ˜Ÿåº§åˆ‡æ›äº‹ä»¶
    useEffect(() => {
        const handleConstellationChange = (newConstellation: string) => {
            switchConstellation3D(newConstellation)
        }
        
        timeController.onConstellationChange = handleConstellationChange
        
        return () => {
            timeController.onConstellationChange = null
        }
    }, [])
    
    // 3Dæ˜Ÿåº§åˆ‡æ›è™•ç†
    const switchConstellation3D = useCallback(async (newConstellation: string) => {
        if (\!sceneRef.current || newConstellation === constellation) return
        
        try {
            // 1. æ¸…é™¤ç•¶å‰è¡›æ˜Ÿæ¨¡å‹
            satelliteModels.forEach((mesh, id) => {
                sceneRef.current?.remove(mesh)
            })
            setSatelliteModels(new Map())
            
            // 2. æ›´æ–°è»Œé“è»Œè·¡é¡è‰²æ–¹æ¡ˆ
            const colorScheme = getConstellationColorScheme(newConstellation)
            updateOrbitTrailColors(colorScheme)
            
            // 3. è¼‰å…¥æ–°æ˜Ÿåº§è¡›æ˜Ÿæ•¸æ“š
            const satelliteData = await fetch3DSatelliteData(newConstellation)
            
            // 4. å‰µå»ºæ–°çš„è¡›æ˜Ÿæ¨¡å‹
            const newModels = new Map<string, THREE.Mesh>()
            
            satelliteData.satellites.forEach(satellite => {
                const mesh = createSatelliteMesh(satellite, colorScheme)
                sceneRef.current?.add(mesh)
                newModels.set(satellite.id, mesh)
            })
            
            setSatelliteModels(newModels)
            setConstellation(newConstellation as 'starlink' | 'oneweb')
            
            // 5. æ›´æ–°æ”å½±æ©Ÿè¦–è§’ï¼ˆé‡å°ä¸åŒè»Œé“é«˜åº¦ï¼‰
            updateCameraForConstellation(newConstellation)
            
        } catch (error) {
            console.error('3Dæ˜Ÿåº§åˆ‡æ›å¤±æ•—:', error)
        }
    }, [constellation, satelliteModels])
    
    // æ˜Ÿåº§é¡è‰²æ–¹æ¡ˆ
    const getConstellationColorScheme = (constellation: string) => {
        const schemes = {
            starlink: {
                primary: '#059669',      // æ·±ç¶ è‰²
                secondary: '#34D399',    // æ·ºç¶ è‰²
                orbit: 'rgba(5, 150, 105, 0.3)',
                connection: '#10B981'
            },
            oneweb: {
                primary: '#2563EB',      // æ·±è—è‰²
                secondary: '#60A5FA',    // æ·ºè—è‰²  
                orbit: 'rgba(37, 99, 235, 0.3)',
                connection: '#3B82F6'
            }
        }
        return schemes[constellation] || schemes.starlink
    }
    
    return (
        <div className="satellite-3d-container">
            <canvas ref={canvasRef} />
            
            {/* æ˜Ÿåº§ä¿¡æ¯é¢æ¿ */}
            <div className="constellation-info-overlay">
                <div className="active-constellation">
                    <span className={"constellation-indicator ${constellation}"}>
                        {constellation === 'starlink' ? 'ğŸŸ¢' : 'ğŸ”µ'}
                    </span>
                    <span className="constellation-name">
                        {constellation === 'starlink' ? 'Starlink' : 'OneWeb'}
                    </span>
                </div>
                
                <div className="satellite-stats">
                    <p>å¯è¦‹è¡›æ˜Ÿ: {visibleSatellites.length}é¡†</p>
                    <p>ä¸»æœå‹™è¡›æ˜Ÿ: {activeSatellite?.name || 'ç„¡'}</p>
                    <p>æ›æ‰‹å€™é¸: {handoverCandidates.length}é¡†</p>
                </div>
            </div>
        </div>
    )
}
```

## ğŸš€ å¾Œç«¯å¯¦æ–½æ–¹æ¡ˆ

### é›™æ˜Ÿåº§æ•¸æ“šæœå‹™
```python
# æ–°å»º: constellation_manager.py
from typing import Dict, Optional, Literal
from dataclasses import dataclass
from datetime import datetime, timedelta
import asyncio

@dataclass
class ConstellationMetadata:
    name: str
    satellites_count: int
    orbital_altitude_km: int
    inclination_deg: float
    last_updated: datetime
    data_freshness: str
    coverage_area: str

class ConstellationManager:
    """çµ±ä¸€æ˜Ÿåº§ç®¡ç†æœå‹™"""
    
    def __init__(self):
        self.active_constellation: Literal['starlink', 'oneweb'] = 'starlink'
        self.data_cache: Dict[str, any] = {}
        self.metadata_cache: Dict[str, ConstellationMetadata] = {}
        self._initialize_metadata()
    
    def _initialize_metadata(self):
        """åˆå§‹åŒ–æ˜Ÿåº§å…ƒæ•¸æ“š"""
        self.metadata_cache = {
            'starlink': ConstellationMetadata(
                name='Starlink',
                satellites_count=40,  # æ™ºèƒ½ç¯©é¸å¾Œæ•¸é‡
                orbital_altitude_km=550,
                inclination_deg=53.0,
                last_updated=datetime.utcnow(),
                data_freshness='å¯¦æ™‚',
                coverage_area='å…¨çƒï¼ˆç‰¹åˆ¥å„ªåŒ–äºå¤ªå€åŸŸï¼‰'
            ),
            'oneweb': ConstellationMetadata(
                name='OneWeb', 
                satellites_count=30,  # æ™ºèƒ½ç¯©é¸å¾Œæ•¸é‡
                orbital_altitude_km=1200,
                inclination_deg=87.0,
                last_updated=datetime.utcnow(),
                data_freshness='å¯¦æ™‚',
                coverage_area='å…¨çƒï¼ˆæ¥µåœ°è¦†è“‹å„ªç§€ï¼‰'
            )
        }
    
    async def switch_constellation(
        self, 
        new_constellation: Literal['starlink', 'oneweb'],
        force_refresh: bool = False
    ) -> Dict[str, any]:
        """æ˜Ÿåº§åˆ‡æ›ä¸»è¦é‚è¼¯"""
        
        if new_constellation == self.active_constellation and not force_refresh:
            return self.get_current_constellation_data()
        
        # 1. æª¢æŸ¥ç›®æ¨™æ˜Ÿåº§æ•¸æ“šæ˜¯å¦å·²å¿«å–
        cache_key = f"{new_constellation}_d2_timeseries"
        
        if cache_key not in self.data_cache or force_refresh:
            # 2. è¼‰å…¥æ–°æ˜Ÿåº§æ•¸æ“š
            print(f"è¼‰å…¥ {new_constellation} æ˜Ÿåº§æ•¸æ“š...")
            constellation_data = await self._load_constellation_data(new_constellation)
            self.data_cache[cache_key] = constellation_data
        
        # 3. æ›´æ–°æ´»èºæ˜Ÿåº§
        self.active_constellation = new_constellation
        
        # 4. æ›´æ–°å…ƒæ•¸æ“šæ™‚é–“æˆ³
        self.metadata_cache[new_constellation].last_updated = datetime.utcnow()
        
        return {
            'constellation': new_constellation,
            'metadata': self.metadata_cache[new_constellation],
            'timeseries_data': self.data_cache[cache_key]['d2_measurements'],
            'satellite_positions': self.data_cache[cache_key]['satellite_positions'],
            'switch_timestamp': datetime.utcnow().isoformat()
        }
    
    async def _load_constellation_data(self, constellation: str) -> Dict[str, any]:
        """è¼‰å…¥æŒ‡å®šæ˜Ÿåº§çš„å®Œæ•´æ•¸æ“š"""
        
        # 1. å¾é è™•ç†æ–‡ä»¶è¼‰å…¥åŸºç¤æ™‚é–“åºåˆ—æ•¸æ“š
        timeseries_file = f"/app/data/{constellation}_120min_timeseries.json"
        
        try:
            with open(timeseries_file, 'r') as f:
                timeseries_data = json.load(f)
        except FileNotFoundError:
            # Fallback: å‹•æ…‹ç”Ÿæˆæ•¸æ“š
            print(f"é è™•ç†æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå‹•æ…‹ç”Ÿæˆ {constellation} æ•¸æ“š")
            timeseries_data = await self._generate_dynamic_data(constellation)
        
        # 2. è™•ç† D2 æ¸¬é‡äº‹ä»¶æ•¸æ“š
        d2_processor = EnhancedD2DataProcessor()
        d2_measurements = d2_processor.process_d2_measurements(
            timeseries_data['satellites'],
            duration_minutes=5  # 290ç§’ â‰ˆ 4.83åˆ†é˜
        )
        
        # 3. æå– 3D ä½ç½®æ•¸æ“š
        satellite_positions = self._extract_3d_positions(timeseries_data)
        
        return {
            'constellation': constellation,
            'd2_measurements': d2_measurements,
            'satellite_positions': satellite_positions,
            'metadata': timeseries_data.get('metadata', {}),
            'load_timestamp': datetime.utcnow().isoformat()
        }
    
    def _extract_3d_positions(self, timeseries_data: Dict) -> List[Dict]:
        """æå–è¡›æ˜Ÿ3Dä½ç½®æ•¸æ“šç”¨æ–¼ç«‹é«”åœ–é¡¯ç¤º"""
        positions = []
        
        for satellite in timeseries_data['satellites'][:10]:  # å‰10é¡†ç”¨æ–¼3Dé¡¯ç¤º
            satellite_positions = []
            
            for time_point in satellite['positions'][:30]:  # 290ç§’ï¼Œ10ç§’é–“éš” = 30å€‹é»
                satellite_positions.append({
                    'timestamp': time_point['timestamp'],
                    'position': self._spherical_to_cartesian(
                        time_point['elevation_deg'],
                        time_point['azimuth_deg'], 
                        time_point['range_km']
                    ),
                    'is_visible': time_point['is_visible']
                })
            
            positions.append({
                'satellite_id': satellite.get('satellite_id', f"sat_{len(positions)}"),
                'positions': satellite_positions
            })
        
        return positions
    
    def _spherical_to_cartesian(self, elevation: float, azimuth: float, range_km: float) -> List[float]:
        """çƒåæ¨™è½‰ç¬›å¡çˆ¾åæ¨™"""
        import math
        
        # è½‰æ›ç‚ºå¼§åº¦
        elev_rad = math.radians(elevation)
        azim_rad = math.radians(azimuth)
        
        # ç¬›å¡çˆ¾åæ¨™è¨ˆç®—
        x = range_km * math.cos(elev_rad) * math.sin(azim_rad)
        y = range_km * math.cos(elev_rad) * math.cos(azim_rad)
        z = range_km * math.sin(elev_rad)
        
        return [x, y, z]

# å…¨å±€æ˜Ÿåº§ç®¡ç†å¯¦ä¾‹
constellation_manager = ConstellationManager()
```

### API ç«¯é»æ“´å±•
```python
# ä¿®æ”¹: measurement_events_router.py
from fastapi import APIRouter, HTTPException, BackgroundTasks
from pydantic import BaseModel
from typing import Literal, Optional

router = APIRouter(prefix="/api/measurement-events", tags=["measurement-events"])

class ConstellationSwitchRequest(BaseModel):
    constellation: Literal['starlink', 'oneweb']
    duration_minutes: int = 5
    force_refresh: bool = False
    include_3d_positions: bool = True

@router.post("/constellation/switch")
async def switch_constellation(
    request: ConstellationSwitchRequest,
    background_tasks: BackgroundTasks
):
    """
    é›™æ˜Ÿåº§åˆ‡æ› API
    æ”¯æ´ Starlink â†” OneWeb å³æ™‚åˆ‡æ›
    """
    try:
        # åŸ·è¡Œæ˜Ÿåº§åˆ‡æ›
        switch_result = await constellation_manager.switch_constellation(
            new_constellation=request.constellation,
            force_refresh=request.force_refresh
        )
        
        # èƒŒæ™¯ä»»å‹™ï¼šé è¼‰å¦ä¸€å€‹æ˜Ÿåº§çš„æ•¸æ“š
        other_constellation = 'oneweb' if request.constellation == 'starlink' else 'starlink'
        background_tasks.add_task(
            preload_constellation_data, 
            other_constellation
        )
        
        return {
            "success": True,
            "data": {
                "constellation": switch_result['constellation'],
                "metadata": {
                    "name": switch_result['metadata'].name,
                    "satellites_count": switch_result['metadata'].satellites_count,
                    "orbital_altitude_km": switch_result['metadata'].orbital_altitude_km,
                    "inclination_deg": switch_result['metadata'].inclination_deg,
                    "last_updated": switch_result['metadata'].last_updated.isoformat(),
                    "coverage_area": switch_result['metadata'].coverage_area
                },
                "d2_timeseries": switch_result['timeseries_data'],
                "satellite_3d_positions": switch_result['satellite_positions'] if request.include_3d_positions else None,
                "switch_duration_ms": (datetime.utcnow() - datetime.fromisoformat(switch_result['switch_timestamp'].replace('Z', '+00:00'))).total_seconds() * 1000
            }
        }
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"æ˜Ÿåº§åˆ‡æ›å¤±æ•—: {str(e)}"
        )

@router.get("/constellation/status")
async def get_constellation_status():
    """ç²å–ç•¶å‰æ˜Ÿåº§ç‹€æ…‹"""
    current_metadata = constellation_manager.metadata_cache[constellation_manager.active_constellation]
    
    return {
        "active_constellation": constellation_manager.active_constellation,
        "metadata": {
            "name": current_metadata.name,
            "satellites_count": current_metadata.satellites_count,
            "orbital_altitude_km": current_metadata.orbital_altitude_km,
            "inclination_deg": current_metadata.inclination_deg,
            "last_updated": current_metadata.last_updated.isoformat(),
            "data_freshness": current_metadata.data_freshness,
            "coverage_area": current_metadata.coverage_area
        },
        "available_constellations": list(constellation_manager.metadata_cache.keys()),
        "cache_status": {
            constellation: bool(f"{constellation}_d2_timeseries" in constellation_manager.data_cache)
            for constellation in constellation_manager.metadata_cache.keys()
        }
    }

@router.get("/constellation/compare")
async def compare_constellations():
    """æ˜Ÿåº§å°æ¯”åˆ†æ API"""
    
    comparison_data = {
        "starlink": {
            "characteristics": {
                "altitude_km": 550,
                "inclination_deg": 53.0,
                "satellites_in_analysis": 40,
                "handover_frequency": "é«˜",
                "signal_stability": "ä¸­",
                "coverage_quality": "è‰¯å¥½",
                "research_focus": "é«˜å¯†åº¦æ›æ‰‹åˆ†æ"
            },
            "advantages": [
                "è¡›æ˜Ÿå¯†åº¦é«˜ï¼Œæ›æ‰‹å ´æ™¯è±å¯Œ",
                "è¼ƒä½è»Œé“ï¼Œä¿¡è™Ÿå»¶é²å°",
                "äºå¤ªåœ°å€è¦†è“‹è‰¯å¥½"
            ]
        },
        "oneweb": {
            "characteristics": {
                "altitude_km": 1200,
                "inclination_deg": 87.0,
                "satellites_in_analysis": 30,
                "handover_frequency": "ä¸­",
                "signal_stability": "é«˜",
                "coverage_quality": "å„ªç§€",
                "research_focus": "ç©©å®šæ€§èˆ‡æ¥µåœ°è¦†è“‹ç ”ç©¶"
            },
            "advantages": [
                "è¿‘æ¥µåœ°è»Œé“ï¼Œå…¨çƒè¦†è“‹å„ªç§€",
                "æ›´é«˜è»Œé“ï¼Œé€£æ¥ç›¸å°ç©©å®š",
                "æ¥µåœ°å’Œé«˜ç·¯åº¦åœ°å€è¦†è“‹ä½³"
            ]
        }
    }
    
    return {
        "comparison": comparison_data,
        "research_recommendations": {
            "dense_handover_study": "é¸æ“‡ Starlinkï¼Œåˆ†æé«˜é »ç‡æ›æ‰‹è¡Œç‚º", 
            "stability_analysis": "é¸æ“‡ OneWebï¼Œç ”ç©¶é•·æœŸé€£æ¥ç©©å®šæ€§",
            "polar_coverage": "é¸æ“‡ OneWebï¼Œåˆ†ææ¥µåœ°åœ°å€æ›æ‰‹ç‰¹æ€§",
            "comparative_study": "åŒæ™‚ä½¿ç”¨å…©å€‹æ˜Ÿåº§ï¼Œé€²è¡Œå°æ¯”ç ”ç©¶"
        }
    }

async def preload_constellation_data(constellation: str):
    """èƒŒæ™¯ä»»å‹™ï¼šé è¼‰æ˜Ÿåº§æ•¸æ“š"""
    try:
        await constellation_manager.switch_constellation(
            new_constellation=constellation,
            force_refresh=False
        )
        print(f"èƒŒæ™¯é è¼‰ {constellation} æ•¸æ“šå®Œæˆ")
    except Exception as e:
        print(f"èƒŒæ™¯é è¼‰ {constellation} æ•¸æ“šå¤±æ•—: {e}")
```

## âš¡ æ€§èƒ½å„ªåŒ–ç­–ç•¥

### æ•¸æ“šå¿«å–æ©Ÿåˆ¶
```python
# å¿«å–ç®¡ç†ç³»çµ±
class ConstellationDataCache:
    def __init__(self, max_cache_size_mb: int = 200):
        self.cache = {}
        self.cache_timestamps = {}
        self.max_cache_size = max_cache_size_mb * 1024 * 1024  # è½‰æ›ç‚ºä½å…ƒçµ„
        self.cache_ttl = timedelta(hours=6)  # 6å°æ™‚å¿«å–æœ‰æ•ˆæœŸ
    
    def is_cache_valid(self, key: str) -> bool:
        """æª¢æŸ¥å¿«å–æ˜¯å¦æœ‰æ•ˆ"""
        if key not in self.cache_timestamps:
            return False
        
        return datetime.utcnow() - self.cache_timestamps[key] < self.cache_ttl
    
    def get_cache_size(self) -> int:
        """è¨ˆç®—ç•¶å‰å¿«å–å¤§å°"""
        import sys
        total_size = 0
        for data in self.cache.values():
            total_size += sys.getsizeof(str(data))
        return total_size
    
    def evict_old_cache(self):
        """æ¸…é™¤éæœŸå¿«å–"""
        current_time = datetime.utcnow()
        keys_to_remove = []
        
        for key, timestamp in self.cache_timestamps.items():
            if current_time - timestamp > self.cache_ttl:
                keys_to_remove.append(key)
        
        for key in keys_to_remove:
            self.cache.pop(key, None)
            self.cache_timestamps.pop(key, None)
        
        print(f"æ¸…é™¤äº† {len(keys_to_remove)} å€‹éæœŸå¿«å–é …ç›®")
```

### 3Dæ¸²æŸ“å„ªåŒ–
```typescript
// 3Dæ¸²æŸ“æ€§èƒ½å„ªåŒ–
class ConstellationRenderOptimizer {
    private geometryCache = new Map<string, THREE.BufferGeometry>()
    private materialCache = new Map<string, THREE.Material>()
    
    // å¹¾ä½•é«”è¤‡ç”¨
    getOrCreateSatelliteGeometry(constellation: string): THREE.BufferGeometry {
        const cacheKey = `satellite_${constellation}`
        
        if (\!this.geometryCache.has(cacheKey)) {
            const geometry = new THREE.SphereGeometry(
                constellation === 'starlink' ? 2 : 3,  // ä¸åŒæ˜Ÿåº§ä¸åŒå¤§å°
                16, 16
            )
            this.geometryCache.set(cacheKey, geometry)
        }
        
        return this.geometryCache.get(cacheKey)\!
    }
    
    // æè³ªè¤‡ç”¨
    getOrCreateSatelliteMaterial(constellation: string, state: 'active' | 'candidate' | 'inactive'): THREE.Material {
        const cacheKey = `${constellation}_${state}`
        
        if (\!this.materialCache.has(cacheKey)) {
            const colorScheme = this.getConstellationColors(constellation)
            const material = new THREE.MeshBasicMaterial({
                color: colorScheme[state],
                transparent: true,
                opacity: state === 'active' ? 1.0 : (state === 'candidate' ? 0.8 : 0.4)
            })
            this.materialCache.set(cacheKey, material)
        }
        
        return this.materialCache.get(cacheKey)\!
    }
    
    // æ‰¹é‡æ›´æ–°è¡›æ˜Ÿä½ç½®ï¼ˆæ€§èƒ½å„ªåŒ–ï¼‰
    batchUpdateSatellitePositions(
        satellites: Map<string, THREE.Mesh>,
        positionData: SatellitePositionData[],
        currentTime: number
    ) {
        const updateBatch = []
        
        // æ”¶é›†éœ€è¦æ›´æ–°çš„è¡›æ˜Ÿ
        positionData.forEach(data => {
            const mesh = satellites.get(data.satellite_id)
            if (mesh) {
                const position = this.interpolatePosition(data.positions, currentTime)
                updateBatch.push({ mesh, position })
            }
        })
        
        // æ‰¹é‡æ›´æ–°ï¼ˆæ¸›å°‘æ¸²æŸ“èª¿ç”¨ï¼‰
        updateBatch.forEach(({ mesh, position }) => {
            mesh.position.set(position.x, position.y, position.z)
        })
    }
    
    private getConstellationColors(constellation: string) {
        return constellation === 'starlink' ? {
            active: 0x059669,
            candidate: 0x34D399,
            inactive: 0x6B7280
        } : {
            active: 0x2563EB,
            candidate: 0x60A5FA,
            inactive: 0x6B7280
        }
    }
}
```

## ğŸ“Š æ¸¬è©¦é©—è­‰è¨ˆåŠƒ

### åŠŸèƒ½æ¸¬è©¦æ¸…å–®
```bash
# 1. æ˜Ÿåº§åˆ‡æ›åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
curl -X POST "http://localhost:8888/api/measurement-events/constellation/switch" \
  -H "Content-Type: application/json" \
  -d '{"constellation": "starlink", "duration_minutes": 5}'

curl -X POST "http://localhost:8888/api/measurement-events/constellation/switch" \
  -H "Content-Type: application/json" \
  -d '{"constellation": "oneweb", "duration_minutes": 5}'

# 2. æ˜Ÿåº§ç‹€æ…‹æª¢æŸ¥
curl -X GET "http://localhost:8888/api/measurement-events/constellation/status"

# 3. æ˜Ÿåº§å°æ¯”åˆ†æ
curl -X GET "http://localhost:8888/api/measurement-events/constellation/compare"
```

### æ€§èƒ½æ¸¬è©¦æŒ‡æ¨™
```typescript
// æ€§èƒ½æ¸¬è©¦å¥—ä»¶
describe('é›™æ˜Ÿåº§åˆ‡æ›æ€§èƒ½æ¸¬è©¦', () => {
    test('æ˜Ÿåº§åˆ‡æ›éŸ¿æ‡‰æ™‚é–“', async () => {
        const startTime = performance.now()
        
        await switchConstellation('oneweb')
        
        const switchTime = performance.now() - startTime
        expect(switchTime).toBeLessThan(2000) // <2ç§’è¦æ±‚
    })
    
    test('3Dæ¸²æŸ“å¹€ç‡', async () => {
        const frameRates = []
        const testDuration = 10000 // 10ç§’æ¸¬è©¦
        
        const startTime = performance.now()
        while (performance.now() - startTime < testDuration) {
            const frameStart = performance.now()
            
            // åŸ·è¡Œä¸€å¹€æ¸²æŸ“
            renderer.render(scene, camera)
            
            const frameTime = performance.now() - frameStart
            const fps = 1000 / frameTime
            frameRates.push(fps)
            
            await new Promise(resolve => requestAnimationFrame(resolve))
        }
        
        const averageFPS = frameRates.reduce((a, b) => a + b) / frameRates.length
        expect(averageFPS).toBeGreaterThan(30) // >30 FPSè¦æ±‚
    })
    
    test('æ•¸æ“šåŒæ­¥ç²¾åº¦', async () => {
        const timeController = new UnifiedTimeController()
        const d2Chart = new D2ChartSyncAdapter()
        const satellite3D = new Satellite3DSyncAdapter()
        
        // è¨»å†ŠåŒæ­¥ç›®æ¨™
        timeController.registerSyncTarget('d2', d2Chart)
        timeController.registerSyncTarget('3d', satellite3D)
        
        // åˆ‡æ›æ˜Ÿåº§
        await switchConstellation('starlink')
        
        // æ¸¬è©¦åŒæ­¥ç²¾åº¦
        const testTime = 150.5
        timeController.updateTime(testTime)
        
        expect(Math.abs(d2Chart.getCurrentTime() - testTime)).toBeLessThan(0.1) // Â±100ms
        expect(Math.abs(satellite3D.getCurrentTime() - testTime)).toBeLessThan(0.1)
    })
})
```

## ğŸ¯ å¯¦æ–½è·¯ç·šåœ–

### Phase 1: åŸºç¤é›™æ˜Ÿåº§æ¶æ§‹ (2-3å¤©)
- [x] ConstellationManager æ ¸å¿ƒæœå‹™å¯¦æ–½
- [x] åŸºæœ¬åˆ‡æ› API ç«¯é»é–‹ç™¼
- [x] å‰ç«¯ ConstellationSwitcher çµ„ä»¶
- [x] D2åœ–è¡¨æ˜Ÿåº§åˆ‡æ›æ•´åˆ

### Phase 2: 3DåŒæ­¥æ•´åˆ (2-3å¤©)  
- [x] 3Dè¦–åœ–æ˜Ÿåº§åˆ‡æ›é‚è¼¯
- [x] çµ±ä¸€æ™‚é–“æ§åˆ¶å™¨æ˜Ÿåº§äº‹ä»¶è™•ç†
- [x] é¡è‰²æ–¹æ¡ˆå’Œè¦–è¦ºå€åˆ†
- [x] æ”å½±æ©Ÿè¦–è§’è‡ªå‹•èª¿æ•´

### Phase 3: æ€§èƒ½å„ªåŒ–èˆ‡æ¸¬è©¦ (2-3å¤©)
- [x] æ•¸æ“šå¿«å–æ©Ÿåˆ¶å¯¦æ–½
- [x] 3Dæ¸²æŸ“æ‰¹é‡æ›´æ–°å„ªåŒ–
- [x] èƒŒæ™¯é è¼‰åŠŸèƒ½
- [x] å®Œæ•´æ¸¬è©¦å¥—ä»¶é–‹ç™¼

## âœ… æˆåŠŸæ¨™æº–

### åŠŸèƒ½å®Œæ•´æ€§
- [ ] Starlink â†” OneWeb ç„¡ç¸«åˆ‡æ›
- [ ] D2åœ–è¡¨èˆ‡3Dè¦–åœ–å®Œå…¨åŒæ­¥åˆ‡æ›
- [ ] æ•¸æ“šä¸€è‡´æ€§ä¿è­‰
- [ ] æ˜Ÿåº§ç‰¹æ€§æ¸…æ™°å±•ç¤º

### æ€§èƒ½æŒ‡æ¨™
- [ ] æ˜Ÿåº§åˆ‡æ›éŸ¿æ‡‰æ™‚é–“ â‰¤2ç§’
- [ ] 3Dæ¸²æŸ“å¹€ç‡ â‰¥30 FPS
- [ ] æ•¸æ“šåŒæ­¥ç²¾åº¦ â‰¤100ms
- [ ] è¨˜æ†¶é«”ä½¿ç”¨ç©©å®š

### ç”¨æˆ¶é«”é©—
- [ ] åˆ‡æ›éç¨‹æµæš¢ï¼Œç„¡å¡é “
- [ ] æ˜Ÿåº§å·®ç•°æ¸…æ™°å¯è¦‹
- [ ] æ•¸æ“šä¾†æºè³‡è¨Šé€æ˜
- [ ] å­¸è¡“ç ”ç©¶åƒ¹å€¼æ˜é¡¯

---

**é›™æ˜Ÿåº§åˆ‡æ›åŠŸèƒ½å°‡ç‚º LEO è¡›æ˜Ÿæ›æ‰‹ç ”ç©¶æä¾›å‰æ‰€æœªæœ‰çš„å°æ¯”åˆ†æèƒ½åŠ›ï¼Œæ”¯æ´ä¸åŒè»Œé“ç‰¹æ€§çš„æ·±åº¦ç ”ç©¶ã€‚**
