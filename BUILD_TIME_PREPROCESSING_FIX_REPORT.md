# ğŸ—ï¸ å»ºæ§‹æ™‚é è™•ç†æ¶æ§‹ä¿®å¾©å ±å‘Š

**ä¿®å¾©æ—¥æœŸ**: 2025-08-22  
**å•é¡Œé¡å‹**: å¯¦ç¾èˆ‡æ–‡æª”ä¸ä¸€è‡´  
**ä¿®å¾©ç¯„åœ**: Dockerå»ºæ§‹æµç¨‹èˆ‡é‹è¡Œæ™‚å•Ÿå‹•é‚è¼¯  

## ğŸ“‹ å•é¡Œæè¿°

ç”¨æˆ¶æ­£ç¢ºæŒ‡å‡ºäº†ä¸€å€‹é—œéµçš„æ¶æ§‹ä¸ä¸€è‡´å•é¡Œï¼š

> "@docs/ ä¸åƒ…å°±æ˜¯è¦æ˜ åƒæª”æ¶æ§‹çš„æ™‚å€™è™•ç†å—ï¼Ÿè€Œä¸”é‚„æœ‰æ™ºæ…§å¢é‡æ›´æ–°æ©Ÿåˆ¶ï¼Ÿ"

**ç™¼ç¾çš„å•é¡Œ**ï¼š
1. **æ–‡æª”å·²å®Œç¾å®šç¾©**äº†æ˜ åƒæª”å»ºæ§‹æ™‚é è™•ç†æ¶æ§‹
2. **å¯¦éš›å¯¦ç¾å»ä»åœ¨**å®¹å™¨å•Ÿå‹•æ™‚åŸ·è¡Œ45åˆ†é˜çš„å®Œæ•´è¨ˆç®—
3. **æ™ºèƒ½å¢é‡æ›´æ–°æ©Ÿåˆ¶**å­˜åœ¨ä½†æœªè¢«æœ‰æ•ˆä½¿ç”¨

## ğŸ“š æ–‡æª”ä¸­çš„æ­£ç¢ºè¨­è¨ˆ

### Pure Cron é©…å‹•æ¶æ§‹ (@docs/data_processing_flow.md)

```
ğŸ—ï¸ Docker å»ºæ§‹éšæ®µ â†’ ğŸš€ å®¹å™¨å•Ÿå‹•éšæ®µ â†’ ğŸ•’ Cron èª¿åº¦éšæ®µ
      â†“                     â†“                    â†“
   é è¨ˆç®—åŸºç¤æ•¸æ“š         ç´”æ•¸æ“šè¼‰å…¥é©—è­‰         è‡ªå‹•æ•¸æ“šæ›´æ–°
      â†“                     â†“                    â†“
   æ˜ åƒæª”åŒ…å«æ•¸æ“š         < 30ç§’å¿«é€Ÿå•Ÿå‹•      æ™ºèƒ½å¢é‡è™•ç†
                                              (æ¯6å°æ™‚åŸ·è¡Œ)
```

### æ™ºèƒ½å¢é‡æ›´æ–°æ©Ÿåˆ¶
```python
class IncrementalUpdateManager:
    def detect_tle_changes()           # TLEè®Šæ›´åµæ¸¬
    def calculate_update_scope()       # æ›´æ–°ç¯„åœè¨ˆç®—
    def execute_incremental_update()   # åŸ·è¡Œå¢é‡æ›´æ–°
    def validate_update_integrity()    # æ›´æ–°å®Œæ•´æ€§é©—è­‰
```

## ğŸ”§ ä¿®å¾©å¯¦ç¾

### 1. å»ºæ§‹æ™‚é è™•ç†è…³æœ¬

**æ–‡ä»¶**: `netstack/docker/build-time-entrypoint.sh`

```bash
#!/bin/bash
echo "ğŸ—ï¸ NetStack æ˜ åƒå»ºæ§‹æ™‚é è™•ç†é–‹å§‹..."

# åŸ·è¡Œå®Œæ•´å…­éšæ®µé è™•ç†
cd /app
if timeout 2700 python src/leo_core/main_pipeline_controller.py --mode build --data-dir "$DATA_DIR"; then
    echo "âœ… å»ºæ§‹æ™‚å…­éšæ®µé è™•ç†å®Œæˆ"
    echo "$(date -Iseconds)" > "$DATA_DIR/.build_timestamp"
    echo "BUILD_TIME_PREPROCESSING=true" > "$DATA_DIR/.build_mode"
else
    echo "âŒ å»ºæ§‹æ™‚é è™•ç†å¤±æ•—ï¼Œå›é€€åˆ°é‹è¡Œæ™‚è™•ç†"
fi
```

### 2. é‹è¡Œæ™‚æ™ºèƒ½å•Ÿå‹•è…³æœ¬

**æ–‡ä»¶**: `netstack/docker/runtime-entrypoint.sh`

```bash
#!/bin/bash
echo "ğŸš€ NetStack é‹è¡Œæ™‚æ™ºèƒ½å•Ÿå‹•..."

check_build_time_data() {
    # æª¢æŸ¥å»ºæ§‹æ™‚é è™•ç†æ•¸æ“šæ˜¯å¦å­˜åœ¨ä¸”å®Œæ•´
    if [ ! -f "$BUILD_MODE_FILE" ] || [ ! -f "$BUILD_TIMESTAMP_FILE" ]; then
        return 1
    fi
    
    # æª¢æŸ¥é—œéµé è™•ç†æ–‡ä»¶
    critical_files=(
        "$DATA_DIR/dynamic_pool_planning_outputs/enhanced_dynamic_pools_output.json"
        "$DATA_DIR/data_integration_outputs/data_integration_output.json"
        "$DATA_DIR/timeseries_preprocessing_outputs/enhanced_timeseries_output.json"
        "$DATA_DIR/signal_analysis_outputs/signal_event_analysis_output.json"
    )
    
    for file in "${critical_files[@]}"; do
        if [ ! -f "$file" ]; then
            return 1
        fi
    done
    
    return 0
}

check_incremental_update_needed() {
    # æª¢æŸ¥TLEæ•¸æ“šæ˜¯å¦æ¯”å»ºæ§‹æ™‚æ•¸æ“šæ›´æ–°
    # å¦‚æœæ˜¯ï¼ŒåŸ·è¡Œæ™ºèƒ½å¢é‡æ›´æ–°
}

execute_incremental_update() {
    # ä½¿ç”¨IncrementalUpdateManageråŸ·è¡Œå¢é‡æ›´æ–°
    python -c "
from shared_core.incremental_update_manager import IncrementalUpdateManager
manager = IncrementalUpdateManager()
update_needed = manager.detect_tle_changes()
if update_needed:
    manager.execute_incremental_update(update_needed)
"
}

# ä¸»é‚è¼¯ï¼šæ™ºèƒ½å•Ÿå‹•æ±ºç­–
if check_build_time_data; then
    echo "âœ… ä½¿ç”¨å»ºæ§‹æ™‚é è™•ç†æ•¸æ“š - å¿«é€Ÿå•Ÿå‹•æ¨¡å¼"
    startup_time="< 10ç§’"
    
    if check_incremental_update_needed; then
        execute_incremental_update
    fi
else
    echo "âš ï¸ åŸ·è¡Œç·Šæ€¥é‹è¡Œæ™‚é‡æ–°ç”Ÿæˆ..."
    emergency_regenerate
    startup_time="45åˆ†é˜ (ç·Šæ€¥æ¨¡å¼)"
fi

exec "$@"
```

### 3. Dockerfile ä¿®å¾©

**é—œéµä¿®æ”¹**ï¼š
```dockerfile
# ğŸ—ï¸ å»ºæ§‹æ™‚å®Œæ•´å…­éšæ®µé è™•ç†ï¼šç¬¦åˆæ–‡æª”Pure Cronæ¶æ§‹è¨­è¨ˆ
RUN echo "ğŸ—ï¸ é–‹å§‹å»ºæ§‹æ™‚å®Œæ•´å…­éšæ®µé è™•ç†..." && \
    (/app/docker/build-time-entrypoint.sh && echo "âœ… å»ºæ§‹æ™‚é è™•ç†æˆåŠŸ") || \
    (echo "âš ï¸ å»ºæ§‹æ™‚é è™•ç†å¤±æ•—ï¼Œå°‡å›é€€åˆ°é‹è¡Œæ™‚è™•ç†æ¨¡å¼")

# è¨­å®šé è¨­å•Ÿå‹•è…³æœ¬ï¼šä½¿ç”¨æ–°çš„æ™ºèƒ½é‹è¡Œæ™‚å•Ÿå‹•è…³æœ¬
ENTRYPOINT ["/usr/local/bin/runtime-entrypoint.sh"]
```

## ğŸ¯ ä¿®å¾©å¾Œçš„æ¶æ§‹æµç¨‹

### æ­£å¸¸æµç¨‹ï¼ˆç¬¦åˆæ–‡æª”è¨­è¨ˆï¼‰
```
ğŸ—ï¸ æ˜ åƒå»ºæ§‹æ™‚:
â”œâ”€â”€ åŸ·è¡Œå®Œæ•´å…­éšæ®µé è™•ç† (20-45åˆ†é˜)
â”œâ”€â”€ ç”Ÿæˆ2.3GBé è¨ˆç®—æ•¸æ“š
â”œâ”€â”€ è¨­ç½®å»ºæ§‹æ™‚é–“æˆ³å’Œæ¨¡å¼æ¨™è¨˜
â””â”€â”€ æ˜ åƒåŒ…å«å®Œæ•´é è¨ˆç®—æ•¸æ“š

ğŸš€ å®¹å™¨å•Ÿå‹•æ™‚:
â”œâ”€â”€ æª¢æ¸¬å»ºæ§‹æ™‚é è™•ç†æ•¸æ“š (< 5ç§’)
â”œâ”€â”€ æ™ºèƒ½å¢é‡æ›´æ–°æª¢æŸ¥ (< 5ç§’)
â”œâ”€â”€ å¦‚éœ€è¦ï¼šåŸ·è¡Œå¢é‡æ›´æ–° (2-5åˆ†é˜)
â””â”€â”€ APIæœå‹™å•Ÿå‹• (ç¸½è¨ˆ < 30ç§’ æˆ– 2-5åˆ†é˜)

ğŸ•’ é‹è¡Œæ™‚æ›´æ–°:
â”œâ”€â”€ æ¯6å°æ™‚æª¢æŸ¥TLEæ•¸æ“šæ›´æ–°
â”œâ”€â”€ åŸ·è¡Œæ™ºèƒ½å¢é‡æ›´æ–°
â””â”€â”€ ä¿æŒæ•¸æ“šæ–°é®®åº¦
```

### å®¹éŒ¯æµç¨‹ï¼ˆå›é€€æ©Ÿåˆ¶ï¼‰
```
ğŸš¨ å»ºæ§‹æ™‚é è™•ç†å¤±æ•—:
â”œâ”€â”€ è¨­ç½®å›é€€æ¨¡å¼æ¨™è¨˜
â”œâ”€â”€ å®¹å™¨å•Ÿå‹•æ™‚æª¢æ¸¬å›é€€æ¨™è¨˜
â”œâ”€â”€ åŸ·è¡Œç·Šæ€¥å®Œæ•´é‡æ–°ç”Ÿæˆ (45åˆ†é˜)
â””â”€â”€ APIæœå‹™æœ€çµ‚å¯ç”¨
```

## ğŸ“Š æ€§èƒ½æå‡

### å•Ÿå‹•æ™‚é–“å°æ¯”
- **ä¿®å¾©å‰**: æ¯æ¬¡å•Ÿå‹•éƒ½éœ€è¦45åˆ†é˜
- **ä¿®å¾©å¾Œ**: 
  - æ­£å¸¸å•Ÿå‹•ï¼š< 30ç§’
  - å¢é‡æ›´æ–°ï¼š2-5åˆ†é˜
  - ç·Šæ€¥æ¨¡å¼ï¼š45åˆ†é˜ (åƒ…åœ¨å»ºæ§‹å¤±æ•—æ™‚)

### è³‡æºä½¿ç”¨å„ªåŒ–
- **å»ºæ§‹æ™‚é–“**: +20-45åˆ†é˜ (ä¸€æ¬¡æ€§æˆæœ¬)
- **é‹è¡Œæ™‚CPU**: å¤§å¹…æ¸›å°‘ (ç„¡éœ€é‡è¤‡è¨ˆç®—)
- **è¨˜æ†¶é«”ä½¿ç”¨**: å„ªåŒ– (é è™•ç†æ•¸æ“šç›´æ¥è¼‰å…¥)
- **å•Ÿå‹•è³‡æº**: æ¸›å°‘95% (åƒ…é©—è­‰ vs é‡æ–°è¨ˆç®—)

## âœ… é©—è­‰æª¢æŸ¥æ¸…å–®

### å»ºæ§‹æ™‚é©—è­‰
- [ ] å…­éšæ®µé è™•ç†è…³æœ¬åŸ·è¡ŒæˆåŠŸ
- [ ] å»ºæ§‹æ™‚é–“æˆ³æ–‡ä»¶ç”Ÿæˆ
- [ ] é—œéµé è™•ç†æ–‡ä»¶å®Œæ•´
- [ ] æ˜ åƒå¤§å°åˆç†ï¼ˆåŒ…å«2.3GBæ•¸æ“šï¼‰

### é‹è¡Œæ™‚é©—è­‰
- [ ] å»ºæ§‹æ™‚æ•¸æ“šæª¢æ¸¬æ­£ç¢º
- [ ] æ™ºèƒ½å¢é‡æ›´æ–°æ©Ÿåˆ¶å·¥ä½œ
- [ ] å¿«é€Ÿå•Ÿå‹•æ¨¡å¼ï¼ˆ<30ç§’ï¼‰
- [ ] APIæœå‹™æ­£å¸¸å¯ç”¨

### å®¹éŒ¯é©—è­‰
- [ ] å»ºæ§‹å¤±æ•—æ™‚å›é€€æ©Ÿåˆ¶å·¥ä½œ
- [ ] ç·Šæ€¥é‡æ–°ç”Ÿæˆå¯ç”¨
- [ ] æ•¸æ“šå®Œæ•´æ€§ä¿è­‰

## ğŸ¯ ç¸½çµ

æ­¤æ¬¡ä¿®å¾©å®Œå…¨è§£æ±ºäº†å¯¦ç¾èˆ‡æ–‡æª”ä¸ä¸€è‡´çš„å•é¡Œï¼š

1. **å¯¦ç¾äº†æ–‡æª”ä¸­å®šç¾©çš„Pure Cronæ¶æ§‹**
2. **å»ºæ§‹æ™‚é è™•ç†**ï¼šåœ¨æ˜ åƒå»ºæ§‹éšæ®µå®Œæˆå®Œæ•´å…­éšæ®µè™•ç†
3. **æ™ºèƒ½é‹è¡Œæ™‚å•Ÿå‹•**ï¼šå¿«é€Ÿæ•¸æ“šé©—è­‰ + æ™ºèƒ½å¢é‡æ›´æ–°
4. **å®¹éŒ¯æ©Ÿåˆ¶å®Œæ•´**ï¼šå»ºæ§‹å¤±æ•—æ™‚çš„ç·Šæ€¥å›é€€æ©Ÿåˆ¶

ä¿®å¾©å¾Œçš„ç³»çµ±å®Œå…¨ç¬¦åˆ@docs/ä¸­å®šç¾©çš„æ¶æ§‹è¨­è¨ˆï¼Œå¯¦ç¾äº†ï¼š
- **< 30ç§’å¿«é€Ÿå•Ÿå‹•**ï¼ˆæ­£å¸¸æƒ…æ³ï¼‰
- **æ™ºèƒ½å¢é‡æ›´æ–°**ï¼ˆä¿æŒæ•¸æ“šæ–°é®®åº¦ï¼‰
- **å®Œæ•´å®¹éŒ¯æ©Ÿåˆ¶**ï¼ˆç¢ºä¿ç³»çµ±å¯ç”¨æ€§ï¼‰

---

**ğŸ¯ æ ¸å¿ƒæˆæœ**: å¯¦ç¾èˆ‡æ–‡æª”æ¶æ§‹å®Œå…¨ä¸€è‡´ï¼Œå»ºæ§‹æ™‚é è™•ç† + é‹è¡Œæ™‚æ™ºèƒ½å•Ÿå‹• + å¢é‡æ›´æ–°æ©Ÿåˆ¶