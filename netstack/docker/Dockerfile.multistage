# NetStack API Multi-Stage Dockerfile - å„ªåŒ–ç‰ˆæœ¬
# å¤šéšæ®µæ§‹å»ºï¼Œæ¸›å°‘æ˜ åƒå¤§å°å’Œæé«˜æ§‹å»ºæ•ˆç‡

# ===== Stage 1: Base Dependencies =====
FROM python:3.11-slim as base
WORKDIR /app

# å®‰è£ç³»çµ±ä¾è³´ (æ§‹å»ºåŸºç¤)
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# ===== Stage 2: Python Dependencies =====
FROM base as python-deps

# å‰µå»ºè™›æ“¬ç’°å¢ƒ
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# è¤‡è£½éœ€æ±‚æ–‡ä»¶ (å„ªåŒ– Docker ç·©å­˜)
COPY requirements.txt ./requirements.txt

# å®‰è£ Python ä¾è³´ (åˆ†é›¢å®‰è£ï¼Œæœ€å¤§åŒ–ç·©å­˜)
RUN pip install --upgrade pip && \
    pip config set global.timeout 600 && \
    pip config set global.retries 5 && \
    pip install --no-cache-dir --default-timeout=600 -r requirements.txt

# ===== Stage 3: Development (å¯é¸) =====
FROM python-deps as development
ARG INSTALL_DEV_TOOLS=false

# è¤‡è£½é–‹ç™¼ä¾è³´ä¸¦å®‰è£
COPY requirements-dev.txt ./requirements-dev.txt
RUN if [ "$INSTALL_DEV_TOOLS" = "true" ]; then \
        pip install --no-cache-dir -r requirements-dev.txt; \
    fi

# å®‰è£é–‹ç™¼å·¥å…·
RUN if [ "$INSTALL_DEV_TOOLS" = "true" ]; then \
        apt-get update && apt-get install -y \
        vim htop strace jq netcat-openbsd \
        && rm -rf /var/lib/apt/lists/*; \
    fi

# è¨­å®šé–‹ç™¼ç’°å¢ƒ
ENV PYTHONPATH="/app:/app/src"
ENV PYTHONUNBUFFERED=1
ENV BUILD_ENV=development

# æš´éœ²ç«¯å£
EXPOSE 8080

# é–‹ç™¼æ¨¡å¼å•Ÿå‹•å‘½ä»¤
CMD ["uvicorn", "netstack_api.main:app", "--host", "0.0.0.0", "--port", "8080", "--reload"]

# ===== Stage 4: Production =====
FROM python-deps as production

# å‰µå»ºérootç”¨æˆ¶
RUN groupadd -r netstack && useradd -r -g netstack netstack

# è¤‡è£½æ‡‰ç”¨ä»£ç¢¼ (æœ€å¾Œè¤‡è£½ï¼Œæœ€å¤§åŒ–ç·©å­˜æ•ˆç›Š)
COPY . .

# Phase 0 é è¨ˆç®—è¨­ç½®
COPY docker/build_with_phase0_data_refactored.py /app/build_with_phase0_data.py

# å‰µå»ºå¿…è¦ç›®éŒ„
RUN mkdir -p /app/data /app/tle_data /app/logs /var/log/netstack \
             /app/models /app/results /tmp/matplotlib

# è¨­å®šç”Ÿç”¢ç’°å¢ƒè®Šæ•¸
ENV PYTHONPATH="/app:/app/src"
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV MPLCONFIGDIR="/tmp/matplotlib"
ENV PRECOMPUTED_DATA_ENABLED=true
ENV ORBIT_CACHE_PRELOAD=true
ENV BUILD_ENV=production

# Phase 0 æ··åˆæ¨¡å¼ï¼šå»ºæ§‹æ™‚é è¨ˆç®—åŸºç¤æ•¸æ“š
RUN echo "ğŸš€ Phase 0 ç”Ÿç”¢æ¨¡å¼ï¼šåŸ·è¡Œé è¨ˆç®—..." && \
    python build_with_phase0_data.py || echo "âš ï¸ å»ºæ§‹æ™‚é è¨ˆç®—æœªå®Œæˆï¼Œå°‡åœ¨é‹è¡Œæ™‚è™•ç†" && \
    if [ -f /app/data/phase0_precomputed_orbits.json ]; then \
        echo "$(date -Iseconds)" > /app/data/.build_timestamp && \
        echo "âœ… å»ºæ§‹æ™‚é è¨ˆç®—å®Œæˆï¼Œæ•¸æ“šå·²å°±ç·’"; \
    else \
        echo "â„¹ï¸ å»ºæ§‹æ™‚é è¨ˆç®—è·³éï¼Œå°‡ä½¿ç”¨é‹è¡Œæ™‚è¨ˆç®—"; \
    fi

# è¤‡è£½ä¸¦è¨­å®šå•Ÿå‹•è…³æœ¬
COPY docker/healthcheck.sh /usr/local/bin/healthcheck.sh
COPY docker/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
COPY docker/smart-entrypoint.sh /usr/local/bin/smart-entrypoint.sh

RUN chmod +x /usr/local/bin/healthcheck.sh \
             /usr/local/bin/docker-entrypoint.sh \
             /usr/local/bin/smart-entrypoint.sh

# è¨­å®šæ¬Šé™
RUN chown -R netstack:netstack /var/log/netstack /app/models /app/results \
                               /app/data /app/tle_data /tmp/matplotlib

# åˆ‡æ›åˆ°érootç”¨æˆ¶
USER netstack

# æš´éœ²ç«¯å£
EXPOSE 8080

# ç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /usr/local/bin/healthcheck.sh

# ç”Ÿç”¢ç’°å¢ƒå•Ÿå‹•
ENTRYPOINT ["/usr/local/bin/smart-entrypoint.sh"]
CMD ["uvicorn", "netstack_api.main:app", "--host", "0.0.0.0", "--port", "8080"]

# ===== Labels =====
LABEL stage="production"
LABEL version="1.0.0"
LABEL architecture="multi-stage-optimized"
LABEL description="NetStack API multi-stage optimized build"