"""
NetStack API - Open5GS + UERANSIM é›™ Slice ç®¡ç† API

åŸºæ–¼ Hexagonal Architecture çš„ FastAPI æ‡‰ç”¨ç¨‹å¼ï¼Œ
æä¾› 5G æ ¸å¿ƒç¶² UE ç®¡ç†å’Œ Slice æ›æ‰‹åŠŸèƒ½ã€‚

é‡æ§‹èªªæ˜ï¼š
- åŸæœ¬ 3119 è¡Œçš„å·¨å‹æ–‡ä»¶å·²é‡æ§‹ç‚ºæ¨¡çµ„åŒ–æ¶æ§‹
- å°‡ 79 å€‹è·¯ç”±ç«¯é»åˆ†çµ„åˆ°ä¸åŒçš„è·¯ç”±å™¨æ¨¡çµ„ä¸­
- ä¿æŒæ‰€æœ‰åŸæœ‰åŠŸèƒ½ï¼Œä½†æé«˜å¯ç¶­è­·æ€§
- ä½¿ç”¨å·²æœ‰çš„è·¯ç”±å™¨ï¼Œä¸¦æ–°å¢å¥åº·æª¢æŸ¥å’ŒUEç®¡ç†çš„ç¨ç«‹æ¨¡çµ„
"""

import asyncio
import json
import logging
import os
from contextlib import asynccontextmanager
from datetime import datetime
from typing import Any, Dict, List, Optional

import structlog
from fastapi import FastAPI, HTTPException, status, Query, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse, PlainTextResponse
from fastapi.encoders import jsonable_encoder
from prometheus_client import Counter, Histogram, generate_latest, CollectorRegistry
from prometheus_client.exposition import generate_latest
from fastapi import Response

# é©é…å™¨å°å…¥
from .adapters.mongo_adapter import MongoAdapter
from .adapters.redis_adapter import RedisAdapter
from .adapters.open5gs_adapter import Open5GSAdapter

# æœå‹™å°å…¥
from .services.ue_service import UEService
from .services.slice_service import SliceService, SliceType
from .services.health_service import HealthService
from .services.ueransim_service import UERANSIMConfigService
from .services.satellite_gnb_mapping_service import SatelliteGnbMappingService
from .services.sionna_integration_service import SionnaIntegrationService
from .services.interference_control_service import InterferenceControlService
from .services.connection_quality_service import ConnectionQualityService
from .services.mesh_bridge_service import MeshBridgeService
from .services.uav_mesh_failover_service import (
    UAVMeshFailoverService,
    NetworkMode,
    FailoverTriggerReason,
)

# æ¨¡å‹å°å…¥
from .models.requests import SliceSwitchRequest
from .models.ueransim_models import UERANSIMConfigRequest, UERANSIMConfigResponse
from .models.responses import (
    HealthResponse,
    UEInfoResponse,
    UEStatsResponse,
    SliceSwitchResponse,
    ErrorResponse,
)
from .models.uav_models import (
    TrajectoryCreateRequest,
    TrajectoryUpdateRequest,
    UAVCreateRequest,
    UAVMissionStartRequest,
    UAVPositionUpdateRequest,
    TrajectoryResponse,
    UAVStatusResponse,
    UAVListResponse,
    TrajectoryListResponse,
    TrajectoryPoint,
    UAVUEConfig,
    UAVPosition,
    UAVConnectionQualityMetrics,
    ConnectionQualityAssessment,
    ConnectionQualityHistoricalData,
    ConnectionQualityThresholds,
    UAVSignalQuality,
)
from .models.mesh_models import (
    MeshNodeCreateRequest,
    MeshNodeUpdateRequest,
    BridgeGatewayCreateRequest,
    BridgeGatewayUpdateRequest,
    MeshRoutingUpdateRequest,
    NetworkTopologyResponse,
    MeshPerformanceMetrics,
    BridgePerformanceMetrics,
    MeshNode,
    Bridge5GMeshGateway,
    MeshNetworkTopology,
)

# æŒ‡æ¨™å°å…¥
from .metrics.prometheus_exporter import metrics_exporter

# æ‰€æœ‰ç¾æœ‰è·¯ç”±å™¨å°å…¥
from .routers.unified_api_router import unified_router
from .routers.ai_decision_router import (
    router as ai_decision_router,
    initialize_ai_services,
    shutdown_ai_services,
)
from .routers.core_sync_router import router as core_sync_router
from .routers.intelligent_fallback_router import router as intelligent_fallback_router
# å°å…¥å¯ç”¨çš„è·¯ç”±å™¨ï¼ˆè¨»é‡‹æ‰å¯èƒ½æœ‰å•é¡Œçš„è·¯ç”±å™¨ï¼‰
try:
    from .routers.performance_router import router as performance_router
except ImportError:
    performance_router = None
    print("è­¦å‘Š: Performance router å°å…¥å¤±æ•—ï¼Œè·³é")

try:
    from .routers.rl_monitoring_router import router as rl_monitoring_router
except ImportError:
    rl_monitoring_router = None
    print("è­¦å‘Š: RL monitoring router å°å…¥å¤±æ•—ï¼Œè·³é")

try:
    from .routers.satellite_tle_router import router as satellite_tle_router
except ImportError:
    satellite_tle_router = None
    print("è­¦å‘Š: Satellite TLE router å°å…¥å¤±æ•—ï¼Œè·³é")

try:
    from .routers.scenario_test_router import router as scenario_test_router
except ImportError:
    scenario_test_router = None
    print("è­¦å‘Š: Scenario test router å°å…¥å¤±æ•—ï¼Œè·³é")

# æ–°çš„æ¨¡çµ„åŒ–è·¯ç”±å™¨å°å…¥
from .app.api.health import router as health_router
from .app.api.v1.ue import router as ue_router
from .app.api.v1.handover import router as handover_router

# æ—¥èªŒè¨­å®š
logger = structlog.get_logger(__name__)

# å…¨åŸŸè®Šæ•¸
mongo_adapter = None
redis_adapter = None
open5gs_adapter = None

# Prometheus æŒ‡æ¨™è¨­å®š
REQUEST_COUNT = Counter(
    "netstack_requests_total",
    "Total number of requests",
    ["method", "endpoint", "status"]
)

REQUEST_DURATION = Histogram(
    "netstack_request_duration_seconds",
    "Request duration in seconds",
    ["method", "endpoint"]
)


@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    æ‡‰ç”¨ç¨‹å¼ç”Ÿå‘½é€±æœŸç®¡ç†
    è™•ç†å•Ÿå‹•å’Œé—œé–‰æ™‚çš„è³‡æºåˆå§‹åŒ–å’Œæ¸…ç†
    """
    global mongo_adapter, redis_adapter, open5gs_adapter
    
    logger.info("ğŸš€ NetStack API æ­£åœ¨å•Ÿå‹•...")
    
    try:
        # åˆå§‹åŒ–é©é…å™¨
        mongo_url = os.getenv("DATABASE_URL", "mongodb://mongo:27017/open5gs")
        redis_url = os.getenv("REDIS_URL", "redis://redis:6379")
        mongo_host = os.getenv("MONGO_HOST", "mongo")
        
        mongo_adapter = MongoAdapter(mongo_url)
        redis_adapter = RedisAdapter(redis_url)
        open5gs_adapter = Open5GSAdapter(mongo_host=mongo_host, mongo_port=27017)
        
        await mongo_adapter.connect()
        await redis_adapter.connect()
        # Open5GSAdapter æ²’æœ‰ connect æ–¹æ³•ï¼Œè·³é
        
        # åˆå§‹åŒ–æœå‹™ä¸¦æ³¨å…¥åˆ° app.state (æŒ‰ä¾è³´é †åº)
        app.state.ue_service = UEService(mongo_adapter, open5gs_adapter)
        app.state.slice_service = SliceService(mongo_adapter, open5gs_adapter, redis_adapter)
        app.state.health_service = HealthService(mongo_adapter, redis_adapter)
        app.state.ueransim_service = UERANSIMConfigService()
        app.state.satellite_service = SatelliteGnbMappingService(mongo_adapter)
        app.state.sionna_service = SionnaIntegrationService()
        app.state.interference_service = InterferenceControlService()
        
        # é¦–å…ˆåˆå§‹åŒ–åŸºç¤æœå‹™
        app.state.connection_service = ConnectionQualityService(mongo_adapter)
        app.state.mesh_service = MeshBridgeService(mongo_adapter, redis_adapter, open5gs_adapter)
        
        # ç„¶å¾Œåˆå§‹åŒ–ä¾è³´æ–¼å…¶ä»–æœå‹™çš„æœå‹™
        app.state.uav_failover_service = UAVMeshFailoverService(
            mongo_adapter, 
            redis_adapter,
            app.state.connection_service,
            app.state.mesh_service
        )
        
        # åˆå§‹åŒ– AI æœå‹™
        await initialize_ai_services(redis_adapter)
        
        logger.info("âœ… NetStack API å•Ÿå‹•å®Œæˆ")
        
        yield  # æ‡‰ç”¨ç¨‹å¼é‹è¡ŒæœŸé–“
        
    except Exception as e:
        logger.error("ğŸ’¥ NetStack API å•Ÿå‹•å¤±æ•—", error=str(e))
        raise
    finally:
        # æ¸…ç†è³‡æº
        logger.info("ğŸ”§ NetStack API æ­£åœ¨é—œé–‰...")
        
        await shutdown_ai_services()
        
        if mongo_adapter:
            await mongo_adapter.disconnect()
        if redis_adapter:
            await redis_adapter.disconnect()
        # Open5GSAdapter æ²’æœ‰ disconnect æ–¹æ³•ï¼Œè·³é
            
        logger.info("âœ… NetStack API å·²é—œé–‰")


# å»ºç«‹ FastAPI æ‡‰ç”¨ç¨‹å¼
app = FastAPI(
    title="NetStack API",
    description="Open5GS + UERANSIM é›™ Slice æ ¸å¿ƒç¶²ç®¡ç† API",
    version="1.0.0",
    lifespan=lifespan,
    docs_url="/docs",
    redoc_url="/redoc",
    openapi_url="/openapi.json",
)

# CORS è¨­å®š
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ç”Ÿç”¢ç’°å¢ƒæ‡‰é™åˆ¶å…·é«”åŸŸå
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# è«‹æ±‚æ—¥èªŒå’ŒæŒ‡æ¨™ä¸­é–“ä»¶
@app.middleware("http")
async def log_and_metrics_middleware(request: Request, call_next):
    """è¨˜éŒ„è«‹æ±‚æ—¥èªŒå’Œæ”¶é›† Prometheus æŒ‡æ¨™"""
    start_time = datetime.utcnow()
    
    # è¨˜éŒ„è«‹æ±‚é–‹å§‹
    logger.info(
        "HTTPè«‹æ±‚é–‹å§‹",
        method=request.method,
        url=str(request.url),
        client_ip=request.client.host if request.client else None
    )
    
    try:
        response = await call_next(request)
        
        # è¨ˆç®—è™•ç†æ™‚é–“
        duration = (datetime.utcnow() - start_time).total_seconds()
        
        # è¨˜éŒ„ Prometheus æŒ‡æ¨™
        method = request.method
        endpoint = request.url.path
        REQUEST_COUNT.labels(
            method=method, endpoint=endpoint, status=response.status_code
        ).inc()
        REQUEST_DURATION.labels(method=method, endpoint=endpoint).observe(duration)
        
        # è¨˜éŒ„è«‹æ±‚å®Œæˆ
        logger.info(
            "HTTPè«‹æ±‚å®Œæˆ",
            method=method,
            url=endpoint,
            status_code=response.status_code,
            duration=duration
        )
        
        return response
        
    except Exception as e:
        duration = (datetime.utcnow() - start_time).total_seconds()
        logger.error(
            "HTTPè«‹æ±‚å¤±æ•—",
            method=request.method,
            url=str(request.url),
            error=str(e),
            duration=duration
        )
        
        # è¨˜éŒ„éŒ¯èª¤æŒ‡æ¨™
        REQUEST_COUNT.labels(
            method=request.method, endpoint=request.url.path, status=500
        ).inc()
        
        raise


# ===== è·¯ç”±å™¨è¨»å†Š =====
# è¨»å†Šæ‰€æœ‰è·¯ç”±å™¨ï¼ŒåŒ…æ‹¬ç¾æœ‰çš„å’Œæ–°é‡æ§‹çš„

# æ–°çš„æ¨¡çµ„åŒ–è·¯ç”±å™¨ï¼ˆå°‡å–ä»£åŸä¾†çš„ç›´æ¥å®šç¾©è·¯ç”±ï¼‰
app.include_router(health_router, tags=["å¥åº·æª¢æŸ¥"])
app.include_router(ue_router, tags=["UE ç®¡ç†"])
app.include_router(handover_router)

# ç¾æœ‰çš„çµ±ä¸€è·¯ç”±å™¨
app.include_router(unified_router, tags=["çµ±ä¸€ API"])

# AI æ±ºç­–è·¯ç”±å™¨
app.include_router(ai_decision_router, tags=["AI æ™ºæ…§æ±ºç­–"])

# æ ¸å¿ƒåŒæ­¥è·¯ç”±å™¨
app.include_router(core_sync_router, tags=["æ ¸å¿ƒåŒæ­¥æ©Ÿåˆ¶"])

# æ™ºèƒ½å›é€€è·¯ç”±å™¨
app.include_router(intelligent_fallback_router, tags=["æ™ºèƒ½å›é€€æ©Ÿåˆ¶"])

# æ¢ä»¶æ€§è¨»å†Šè·¯ç”±å™¨ï¼ˆåªæœ‰æˆåŠŸå°å…¥çš„æ‰è¨»å†Šï¼‰
if performance_router:
    app.include_router(performance_router, tags=["æ€§èƒ½ç›£æ§"])

if rl_monitoring_router:
    app.include_router(rl_monitoring_router, tags=["RL è¨“ç·´ç›£æ§"])

if satellite_tle_router:
    app.include_router(satellite_tle_router, tags=["è¡›æ˜Ÿ TLE æ©‹æ¥"])

if scenario_test_router:
    app.include_router(scenario_test_router, tags=["å ´æ™¯æ¸¬è©¦é©—è­‰"])


# ===== æ ¹è·¯å¾‘è™•ç† =====
@app.get("/", summary="API æ ¹è·¯å¾‘")
async def root():
    """
    API æ ¹è·¯å¾‘
    è¿”å›æ‡‰ç”¨ç¨‹å¼çš„åŸºæœ¬è³‡è¨Šå’Œå¯ç”¨ç«¯é»
    """
    return {
        "name": "NetStack API",
        "version": "1.0.0",
        "description": "Open5GS + UERANSIM é›™ Slice æ ¸å¿ƒç¶²ç®¡ç† API",
        "status": "é‡æ§‹å®Œæˆ - åŸ3119è¡Œå·²æ¨¡çµ„åŒ–",
        "timestamp": datetime.utcnow().isoformat(),
        "endpoints": {
            "docs": "/docs",
            "redoc": "/redoc", 
            "health": "/health",
            "metrics": "/metrics",
            "openapi": "/openapi.json"
        },
        "features": [
            "UE ç®¡ç†",
            "Slice ç®¡ç†", 
            "è¡›æ˜Ÿ gNodeB æ˜ å°„",
            "OneWeb è¡›æ˜Ÿæ•´åˆ",
            "Sionna æ•´åˆ",
            "AI æ±ºç­–å¼•æ“",
            "Mesh ç¶²è·¯æ©‹æ¥",
            "UAV ç®¡ç†",
            "å¹²æ“¾æ§åˆ¶",
            "UERANSIM é…ç½®"
        ]
    }


# ===== å…¨åŸŸç•°å¸¸è™•ç† =====
@app.exception_handler(404)
async def not_found_handler(request: Request, exc):
    """è™•ç† 404 éŒ¯èª¤"""
    return JSONResponse(
        status_code=404,
        content={
            "error": "Not Found",
            "message": f"è·¯å¾‘ {request.url.path} ä¸å­˜åœ¨",
            "timestamp": datetime.utcnow().isoformat(),
            "available_docs": "/docs"
        }
    )


@app.exception_handler(500)
async def internal_server_error_handler(request: Request, exc):
    """è™•ç† 500 éŒ¯èª¤"""
    logger.error("å…§éƒ¨æœå‹™å™¨éŒ¯èª¤", error=str(exc))
    return JSONResponse(
        status_code=500,
        content={
            "error": "Internal Server Error", 
            "message": "æœå‹™å™¨å…§éƒ¨éŒ¯èª¤",
            "timestamp": datetime.utcnow().isoformat()
        }
    )


@app.exception_handler(HTTPException)
async def http_exception_handler(request: Request, exc: HTTPException):
    """è™•ç† HTTP ç•°å¸¸"""
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "error": f"HTTP {exc.status_code}",
            "message": exc.detail,
            "timestamp": datetime.utcnow().isoformat()
        }
    )


# ===== å•Ÿå‹•è¨­å®š =====
if __name__ == "__main__":
    import uvicorn
    
    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=8080,
        reload=True,
        log_level="info"
    )