# A4 事件統一化開發計劃書

**版本**: 1.0.0  
**建立日期**: 2025-08-04  
**專案範圍**: LEO 衛星切換系統 Event A4 統一化重構  
**開發理念**: 真實數據優先、架構統一、學術研究導向  

## 🎯 專案背景與目標

### 📊 現況分析
- **D2 事件**: ✅ 完整成熟架構，支援真實 NetStack 數據整合
- **A4 事件**: ❌ 實現不完整，PureA4Chart 缺失，僅支援靜態 CSV 數據
- **核心問題**: 架構不統一，用戶體驗不一致，缺乏真實數據支援

### 🚀 專案目標
1. **統一架構**: 將 A4 事件整合到 D2 的成熟架構模式
2. **真實數據**: 整合 NetStack API，支援真實 RSRP 測量數據
3. **完整功能**: 恢復缺失的圖表組件和動態數據管理
4. **學術價值**: 提供符合 3GPP TS 38.331 標準的完整 A4 事件實現

## 🛠️ 技術架構設計

### 📋 架構統一策略
基於 D2 事件的成功模式，採用以下統一架構：

```
A4 事件架構 (參照 D2 模式)
├── A4DataManager Hook      # 數據管理層
├── PureA4Chart Component   # 圖表可視化層  
├── A4NarrationPanel        # 動畫解說層
├── A4AnimationController   # 動畫控制層
└── A4ThemeManager          # 主題管理層
```

### 🔄 數據流設計
```
數據源 → A4DataManager → PureA4Chart → 用戶界面
   ↓
├── CSV 數據 (兼容模式)
├── NetStack RSRP API (真實數據)
└── 模擬數據生成 (研究模式)
```

## 📅 開發計劃時程

### 🎯 **Phase 1: 數據管理層重構** ⏱️ 2-3天

#### 步驟 1.1: A4DataManager Hook 開發
**文件位置**: `simworld/frontend/src/components/domains/measurement/charts/a4-components/A4DataManager.tsx`

**核心功能**:
```typescript
export const useA4DataManager = ({
    params: EventA4Params,
    onDataLoad: (data: A4DataPoint[]) => void,
    onError: (error: string) => void,
    onLoadingChange: (loading: boolean) => void
}) => {
    // 數據源管理
    const [selectedDataSource, setSelectedDataSource] = useState<'csv' | 'netstack' | 'simulation'>('simulation')
    
    // CSV 數據載入 (保持兼容性)
    const loadCSVData = async () => { ... }
    
    // NetStack RSRP 數據整合
    const loadNetstackData = async () => {
        // 整合現有 NetStack API
        // 獲取真實 RSRP 測量數據
    }
    
    // 模擬數據生成 (基於 A4 事件特性)
    const generateSimulationData = () => { ... }
    
    return {
        realA4Data,
        isLoadingRealData,
        realDataError,
        selectedDataSource,
        handleDataSourceChange,
        loadRealData: loadNetstackData
    }
}
```

#### 步驟 1.2: 數據格式標準化
**目標**: 統一 A4 事件的數據格式，確保與現有系統兼容

```typescript
interface A4DataPoint {
    time: string              // ISO 時間格式
    time_offset_seconds: number
    rsrp_dbm: number         // RSRP 信號強度 (dBm)
    threshold_dbm: number    // 當前門檻值
    hysteresis_db: number    // 磁滯值
    event_triggered: boolean // 事件觸發狀態
    effective_rsrp: number   // 有效 RSRP (含偏移)
}
```

#### 步驟 1.3: NetStack API 整合
**API 端點設計**:
```bash
# 新增 A4 事件專用端點
GET /api/v1/measurement_events/a4/rsrp_data
POST /api/v1/measurement_events/a4/trigger_simulation
```

**驗證標準**:
- [ ] A4DataManager Hook 成功創建
- [ ] 支援三種數據源切換 (CSV/NetStack/Simulation)
- [ ] 數據格式標準化完成
- [ ] NetStack API 整合測試通過

---

### 🎨 **Phase 2: 圖表組件重建** ⏱️ 3-4天

#### 步驟 2.1: PureA4Chart 組件開發
**文件位置**: `simworld/frontend/src/components/domains/measurement/charts/PureA4Chart.tsx`

**參考模式**: 基於 `PureD2Chart.tsx` 的設計架構

**核心功能**:
```typescript
interface PureA4ChartProps {
    threshold: number           // a4-Threshold (dBm)
    hysteresis: number         // Hysteresis (dB)
    offsetFreq: number         // Frequency offset (dB)
    offsetCell: number         // Cell offset (dB)
    showThresholdLines: boolean
    currentTime: number
    isDarkTheme: boolean
    dataMode: 'simulation' | 'realtime'
    realTimeSeriesData?: A4DataPoint[]
    onDataModeToggle: (mode: string) => void
}
```

**圖表特性**:
- RSRP 信號強度時序圖
- 動態門檻線顯示 (進入/離開門檻)
- 事件觸發狀態指示
- 3GPP A4 條件可視化
- 支援暗色/亮色主題

#### 步驟 2.2: 圖表動畫系統
**功能需求**:
- 時間軸動畫播放 (參考 D2 的動畫控制)
- 事件觸發瞬間的視覺效果
- 門檻線的動態調整動畫
- 平滑的數據更新轉場

#### 步驟 2.3: 事件邏輯實現
**3GPP TS 38.331 A4 事件條件**:
```typescript
// A4-1 進入條件: Mn + Ofn + Ocn - Hys > Thresh
const enterCondition = (rsrp: number, ofn: number, ocn: number, hys: number, thresh: number) => {
    return (rsrp + ofn + ocn - hys) > thresh
}

// A4-2 離開條件: Mn + Ofn + Ocn + Hys < Thresh  
const leaveCondition = (rsrp: number, ofn: number, ocn: number, hys: number, thresh: number) => {
    return (rsrp + ofn + ocn + hys) < thresh
}
```

**驗證標準**:
- [ ] PureA4Chart 組件完成開發
- [ ] RSRP 時序圖正確顯示
- [ ] 門檻線動態更新正常
- [ ] 事件觸發邏輯符合 3GPP 標準
- [ ] 動畫效果流暢無卡頓

---

### 🎬 **Phase 3: UI 組件統一** ⏱️ 1-2天

#### 步驟 3.1: A4NarrationPanel 開發
**文件位置**: `simworld/frontend/src/components/domains/measurement/charts/a4-components/A4NarrationPanel.tsx`

**參考模式**: 基於 `D2NarrationPanel.tsx` 的解說系統

**解說內容設計**:
```typescript
interface A4NarrationContent {
    phase: 'monitoring' | 'triggered' | 'exiting'
    phaseTitle: string
    description: string
    technicalNote: string          // 3GPP 公式和計算過程
    decisionProcess: string        // 換手決策流程
    handoverStage: string          // 當前換手階段
    nextAction: string             // 下一步行動
    scenarioContext: string        // 場景情境說明
    currentRSRP: string           // 當前 RSRP 值
    effectiveRSRP: string         // 有效 RSRP 值
}
```

#### 步驟 3.2: 動畫控制器整合
**策略**: 複用 `D2AnimationController`，確保操作一致性
- 播放/暫停控制
- 速度調整 (1x-10x)
- 時間軸拖拽
- 重置功能

#### 步驟 3.3: 主題管理統一
**策略**: 複用 `D2ThemeManager`，確保視覺一致性
- 暗色/亮色主題切換
- 顏色配置統一
- 圖表樣式同步

**驗證標準**:
- [ ] A4NarrationPanel 解說內容豐富且準確
- [ ] 動畫控制器功能完整
- [ ] 主題切換正常工作
- [ ] UI 風格與 D2 保持一致

---

### ⚙️ **Phase 4: 配置整合與測試** ⏱️ 1天

#### 步驟 4.1: EventConfig 更新
**文件**: `simworld/frontend/src/components/domains/measurement/config/eventConfig.ts`

**重新啟用 A4 事件**:
```typescript
export const EVENT_CONFIGS: Record<EventType, EventConfig> = {
    A4: {
        id: 'A4',
        name: 'Event A4',
        description: 'Neighbour becomes better than threshold',
        shortName: 'A4',
        status: 'available',        // 從 removed 改為 available
        category: 'signal',
        standard: '3GPP TS 38.331 Section 5.5.4.5',
        ViewerComponent: EventA4Viewer,  // 使用重構後的組件
        icon: '📡',
        // ... 其他配置
    },
    D2: {
        // 保持 D2 配置不變，實現雙事件並存
    }
}
```

#### 步驟 4.2: 路由配置更新
確保 A4 和 D2 事件都能正常從 navbar 訪問

#### 步驟 4.3: 整合測試
**測試項目**:
```bash
# 容器內測試 (遵循 CLAUDE.md 規範)
docker exec -it simworld_frontend npm run test

# 建置測試
npm run build

# 代碼品質檢查
npm run lint
```

**驗證標準**:
- [ ] A4 事件在 navbar 中正常顯示
- [ ] A4 和 D2 事件可以並存運行
- [ ] 所有測試通過
- [ ] 代碼品質檢查無 error

---

## 🔧 技術實現細節

### 📊 數據源優先級
根據 CLAUDE.md 的真實數據原則：

1. **CRITICAL 級別**: NetStack RSRP 測量數據 (真實)
2. **HIGH 級別**: 歷史 RSRP 數據文件 (真實)  
3. **MEDIUM 級別**: CSV 數據文件 (兼容)
4. **LOW 級別**: 模擬數據生成 (研究用)

### 🛡️ API 配置規範
遵循統一配置系統，禁止硬編碼 URL：

```typescript
// ✅ 正確方式
import { netstackFetch } from '../config/api-config'
const rsrpData = await netstackFetch('/api/v1/measurement_events/a4/rsrp_data')

// ❌ 禁止方式
const response = await fetch('http://localhost:8080/api/...')
```

### 🧪 環境隔離測試
遵循 CLAUDE.md 測試規範：

```bash
# 容器內測試 (首選)
docker exec -it simworld_frontend bash
npm run test

# 虛擬環境測試 (次選)
cd /home/sat/ntn-stack
python3 -m venv leo_test_env
source leo_test_env/bin/activate
# 執行測試...
deactivate
```

## ✅ 驗收標準

### 🎯 功能完整性驗收
- [ ] A4 事件有完整的圖表顯示
- [ ] 支援真實 NetStack RSRP 數據
- [ ] 事件觸發邏輯符合 3GPP TS 38.331 標準
- [ ] 用戶界面與 D2 事件一致

### 🔧 技術品質驗收  
- [ ] 所有 `npm run lint` 檢查通過 (無 error)
- [ ] 所有單元測試通過
- [ ] API 響應時間 < 100ms
- [ ] 圖表動畫流暢 (60 FPS)

### 🚀 重構驗證流程
遵循 CLAUDE.md 重構標準：

```bash
# 1. 完全重啟
make down && make up

# 2. 檢查狀態 (等待30-60秒)  
make status

# 3. 檢查日誌無錯誤
docker logs simworld_frontend 2>&1 | tail -20

# 4. 健康檢查
curl -s http://localhost:5173 | grep "Event A4"
```

**重構完成標準**:
- [ ] `make status` 所有服務 "Up" 且 "healthy"
- [ ] `docker logs` 無 error/exception  
- [ ] 前端可正常訪問 A4 事件
- [ ] A4 和 D2 事件功能對等

## 🚨 風險管控

### ⚠️ 主要技術風險
1. **數據格式差異**: A4 (RSRP) vs D2 (距離) 的數據結構不同
   - **緩解策略**: 建立獨立的 A4DataPoint 介面，確保類型安全

2. **NetStack API 依賴**: 真實數據整合可能遇到 API 變更
   - **緩解策略**: 保持 CSV 數據作為回退方案，確保向後兼容

3. **性能影響**: 統一架構可能增加 bundle 大小
   - **緩解策略**: 使用 React.lazy() 動態載入，按需載入組件

### 🛡️ 品質保證措施
- **代碼審查**: 每個 Phase 完成後進行代碼審查
- **漸進式測試**: 每個組件開發完成後立即測試
- **回滾策略**: 保持原有 EventA4Viewer 作為備份

## 📋 成功指標

### 🎯 定量指標
- **開發效率**: 完整實現時間 ≤ 7 天
- **代碼品質**: Lint 錯誤數 = 0
- **測試覆蓋**: 新增代碼測試覆蓋率 ≥ 80%
- **性能指標**: 圖表渲染時間 ≤ 100ms

### 🚀 定性指標  
- **架構統一**: A4 和 D2 使用相同的設計模式
- **用戶體驗**: 操作方式和視覺風格保持一致
- **學術價值**: 提供符合 3GPP 標準的真實測量事件
- **可維護性**: 代碼結構清晰，易於後續擴展

## 🎓 學術研究價值

### 📊 真實數據優勢
- **符合 3GPP 標準**: 完整實現 TS 38.331 Event A4 規範
- **真實測量數據**: 整合 NetStack RSRP 測量，提供真實信號環境
- **可重現性**: 歷史數據支援實驗重現和對比分析
- **論文支撐**: 為 LEO 衛星切換研究提供可信的數據基礎

### 🔬 研究場景支援
- **算法對比**: A4 vs D2 不同事件類型的切換決策比較
- **參數優化**: 門檻值、磁滯等參數對切換性能的影響
- **環境適應**: 不同信號環境下的事件觸發特性分析

---

## 📞 專案聯絡

**開發團隊**: LEO 衛星系統工程團隊  
**技術負責**: 資深衛星通訊系統工程師  
**品質保證**: 遵循 CLAUDE.md 開發規範  
**文檔維護**: 與系統更新同步維護  

---

**⚡ 核心理念：正確性 > 可靠性 > 性能 > 可維護性**

**🎯 專案使命：建立統一、真實、高品質的 LEO 衛星切換事件可視化系統，為學術研究提供可信的數據支撐。**
