# è¡›æ˜Ÿè™•ç†ç³»çµ± - æ¸¬è©¦å°ˆç”¨ Makefile
# ğŸ§ª TDDé‡æ§‹æ¸¬è©¦è‡ªå‹•åŒ–å‘½ä»¤

.PHONY: help test-runner test-sgp4 test-fast test-coverage check lint performance install-deps setup dev-check release-check view-coverage test-status clean-test

# é è¨­ç›®æ¨™
.DEFAULT_GOAL := help

# é¡è‰²å®šç¾©
BLUE = \033[0;34m
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

help: ## é¡¯ç¤ºæ‰€æœ‰å¯ç”¨æ¸¬è©¦å‘½ä»¤
	@echo "$(BLUE)ğŸ§ª è¡›æ˜Ÿè™•ç†ç³»çµ± - æ¸¬è©¦å‘½ä»¤$(NC)"
	@echo "================================================================"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)ğŸš€ æ¨è–¦ä½¿ç”¨é †åº:$(NC)"
	@echo "  1. make -f Makefile.test test-fast    # å¿«é€Ÿæª¢æŸ¥"
	@echo "  2. make -f Makefile.test test-sgp4    # æ ¸å¿ƒæ¸¬è©¦"  
	@echo "  3. make -f Makefile.test test-runner  # å®Œæ•´æ¸¬è©¦"
	@echo ""

# æ¸¬è©¦ç›¸é—œå‘½ä»¤
test-runner: ## åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶ (æ¨è–¦)
	@echo "$(BLUE)ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶$(NC)"
	@./scripts/test-runner.sh

test-sgp4: ## åƒ…åŸ·è¡ŒSGP4è»Œé“å¼•æ“æ¸¬è©¦
	@echo "$(BLUE)ğŸ›°ï¸ åŸ·è¡ŒSGP4æ¸¬è©¦$(NC)"
	python -m pytest tests/unit/algorithms/test_sgp4_orbital_engine.py -v

test-fast: ## å¿«é€Ÿæ¸¬è©¦ (åƒ…é—œéµæ¸¬è©¦)
	@echo "$(BLUE)âš¡ å¿«é€Ÿæ¸¬è©¦$(NC)"
	python -m pytest tests/unit/algorithms/test_sgp4_orbital_engine.py::TestSGP4OrbitalEngine::test_tle_epoch_time_usage_mandatory -v

test-coverage: ## ç”Ÿæˆæ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
	@echo "$(BLUE)ğŸ“Š ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š$(NC)"
	python -m pytest tests/unit/ --cov=src --cov-report=html:tests/reports/coverage_html --cov-report=term-missing
	@echo "$(GREEN)ğŸ“ˆ è¦†è“‹ç‡å ±å‘Š: tests/reports/coverage_html/index.html$(NC)"

# ä»£ç¢¼å“è³ªæª¢æŸ¥
check: ## åŸ·è¡Œé æäº¤æª¢æŸ¥
	@echo "$(BLUE)ğŸ›¡ï¸ åŸ·è¡Œé æäº¤æª¢æŸ¥$(NC)"
	@./scripts/pre-commit-check.sh

lint: ## æª¢æŸ¥ä»£ç¢¼èªæ³• (è¼•é‡ç´š)
	@echo "$(BLUE)ğŸ æª¢æŸ¥Pythonèªæ³•$(NC)"
	python -m py_compile src/shared/engines/sgp4_orbital_engine.py
	@echo "$(GREEN)âœ… èªæ³•æª¢æŸ¥é€šé$(NC)"

# æ€§èƒ½æ¸¬è©¦
performance: ## åŸ·è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦
	@echo "$(BLUE)âš¡ æ€§èƒ½åŸºæº–æ¸¬è©¦$(NC)"
	python -m pytest tests/unit/algorithms/test_sgp4_orbital_engine.py::TestSGP4OrbitalEngine::test_sgp4_calculation_performance -v
	python -m pytest tests/unit/algorithms/test_sgp4_orbital_engine.py::TestSGP4OrbitalEngine::test_batch_calculation_performance -v

# é–‹ç™¼æµç¨‹å¿«æ·å‘½ä»¤
dev-check: check test-sgp4 ## é–‹ç™¼æª¢æŸ¥ (é æäº¤ + æ ¸å¿ƒæ¸¬è©¦)
	@echo "$(GREEN)ğŸ‰ é–‹ç™¼æª¢æŸ¥å®Œæˆï¼$(NC)"

release-check: test-runner test-coverage ## ç™¼å¸ƒæª¢æŸ¥ (å®Œæ•´æ¸¬è©¦ + è¦†è“‹ç‡)
	@echo "$(GREEN)ğŸš€ ç™¼å¸ƒæª¢æŸ¥å®Œæˆï¼$(NC)"

# æ¸¬è©¦ç’°å¢ƒè¨­ç½®
install-deps: ## å®‰è£æ¸¬è©¦ä¾è³´
	@echo "$(BLUE)ğŸ“¦ å®‰è£æ¸¬è©¦ä¾è³´$(NC)"
	pip install -r requirements.txt
	@echo "$(GREEN)âœ… ä¾è³´å®‰è£å®Œæˆ$(NC)"

setup: install-deps ## åˆå§‹åŒ–æ¸¬è©¦ç’°å¢ƒ
	@echo "$(BLUE)ğŸ”§ åˆå§‹åŒ–æ¸¬è©¦ç’°å¢ƒ$(NC)"
	mkdir -p tests/reports
	@echo "$(GREEN)âœ… æ¸¬è©¦ç’°å¢ƒè¨­ç½®å®Œæˆ$(NC)"

# æ¸…ç†
clean-test: ## æ¸…ç†æ¸¬è©¦å ±å‘Šå’Œç·©å­˜
	@echo "$(BLUE)ğŸ§¹ æ¸…ç†æ¸¬è©¦æ–‡ä»¶$(NC)"
	rm -rf tests/reports/
	rm -rf .pytest_cache/
	rm -rf __pycache__/
	rm -rf src/__pycache__/
	rm -rf tests/__pycache__/
	rm -rf .coverage
	find . -name "*.pyc" -delete
	find . -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(NC)"

# ç‹€æ…‹æª¢æŸ¥
test-status: ## é¡¯ç¤ºæ¸¬è©¦ç’°å¢ƒç‹€æ…‹
	@echo "$(BLUE)ğŸ“Š æ¸¬è©¦ç’°å¢ƒç‹€æ…‹$(NC)"
	@echo "================================================================"
	@echo "Pythonç‰ˆæœ¬: $$(python --version)"
	@echo "pytestç‰ˆæœ¬: $$(python -m pytest --version 2>/dev/null || echo 'æœªå®‰è£')"
	@echo "TLEæ•¸æ“šæ–‡ä»¶: $$(ls data/tle_data/starlink/tle/*.tle 2>/dev/null | wc -l) å€‹"
	@echo "æœ€è¿‘æ¸¬è©¦: $$(ls -t tests/reports/*.html 2>/dev/null | head -1 | xargs ls -l 2>/dev/null || echo 'ç„¡')"
	@echo "Git hooks: $$([ -x /home/sat/ntn-stack/.git/hooks/pre-commit ] && echo 'å·²é…ç½®' || echo 'æœªé…ç½®')"
	@echo "================================================================"

# å ±å‘ŠæŸ¥çœ‹
view-coverage: ## åœ¨ç€è¦½å™¨ä¸­æŸ¥çœ‹è¦†è“‹ç‡å ±å‘Š
	@if [ -f tests/reports/coverage_html/index.html ]; then \
		echo "$(BLUE)ğŸ“Š è¦†è“‹ç‡å ±å‘Šä½ç½®: tests/reports/coverage_html/index.html$(NC)"; \
		echo "$(YELLOW)å¯ä»¥ç”¨ç€è¦½å™¨æ‰“é–‹æŸ¥çœ‹$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸ è¦†è“‹ç‡å ±å‘Šä¸å­˜åœ¨ï¼Œè«‹å…ˆåŸ·è¡Œ: make -f Makefile.test test-coverage$(NC)"; \
	fi