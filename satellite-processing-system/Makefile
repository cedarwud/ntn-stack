# è¡›æ˜Ÿè™•ç†ç³»çµ± Makefile
# ç°¡åŒ–é–‹ç™¼å’Œéƒ¨ç½²æµç¨‹

.PHONY: help build up down dev-up dev-down logs status clean test health tle-setup tle-status tle-download tle-cleanup

# é»˜èªç›®æ¨™
help:
	@echo "ğŸš€ è¡›æ˜Ÿè™•ç†ç³»çµ± Docker ç®¡ç†"
	@echo ""
	@echo "ğŸ“¦ åŸºæœ¬å‘½ä»¤:"
	@echo "  build       - æ§‹å»º Docker æ˜ åƒæª”"
	@echo "  up          - å•Ÿå‹•ç”Ÿç”¢ç’°å¢ƒæœå‹™"
	@echo "  down        - åœæ­¢ç”Ÿç”¢ç’°å¢ƒæœå‹™"
	@echo "  logs        - æŸ¥çœ‹æœå‹™æ—¥èªŒ"
	@echo "  status      - æª¢æŸ¥æœå‹™ç‹€æ…‹"
	@echo ""
	@echo "ğŸ› ï¸ é–‹ç™¼å‘½ä»¤:"
	@echo "  dev-up      - å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ (æ”¯æ´ç†±é‡è¼‰)"
	@echo "  dev-down    - åœæ­¢é–‹ç™¼ç’°å¢ƒ"
	@echo "  dev-logs    - æŸ¥çœ‹é–‹ç™¼ç’°å¢ƒæ—¥èªŒ"
	@echo "  dev-exec    - é€²å…¥é–‹ç™¼å®¹å™¨"
	@echo ""
	@echo "ğŸ“¡ TLE æ•¸æ“šç®¡ç†:"
	@echo "  tle-setup   - å®‰è£ TLE è‡ªå‹•ä¸‹è¼‰æ’ç¨‹"
	@echo "  tle-status  - æª¢æŸ¥ TLE ä¸‹è¼‰ç‹€æ…‹"
	@echo "  tle-download- æ‰‹å‹•ä¸‹è¼‰ TLE æ•¸æ“š"
	@echo "  tle-cleanup - æ¸…ç†éæœŸ TLE æ•¸æ“š"
	@echo ""
	@echo "ğŸ§ª è™•ç†å‘½ä»¤:"
	@echo "  run-stages  - åŸ·è¡Œå®Œæ•´å¤šéšæ®µè™•ç†"
	@echo "  run-stage1  - åªåŸ·è¡Œéšæ®µ1"
	@echo "  run-fast    - ä½¿ç”¨ FAST é©—è­‰æ¨¡å¼åŸ·è¡Œ"
	@echo "  health      - å¥åº·æª¢æŸ¥"
	@echo ""
	@echo "ğŸ› ï¸ ç¶­è­·å‘½ä»¤:"
	@echo "  clean       - æ¸…ç†æœªä½¿ç”¨çš„ Docker è³‡æº"
	@echo "  clean-data  - æ¸…ç†è¼¸å‡ºæ•¸æ“š (è¬¹æ…ä½¿ç”¨!)"
	@echo "  test        - åŸ·è¡Œæ¸¬è©¦å¥—ä»¶"

# ğŸ“¦ åŸºæœ¬ Docker å‘½ä»¤
build:
	@echo "ğŸ”¨ æ§‹å»ºå…­éšæ®µè™•ç†ç³»çµ±æ˜ åƒæª”..."
	docker-compose build

up:
	@echo "ğŸš€ å•Ÿå‹•å…­éšæ®µè™•ç†ç³»çµ± (ç”Ÿç”¢æ¨¡å¼)..."
	docker-compose up -d
	@echo "âœ… æœå‹™å·²å•Ÿå‹•ï¼Œä½¿ç”¨ 'make status' æª¢æŸ¥ç‹€æ…‹"

down:
	@echo "ğŸ›‘ åœæ­¢å…­éšæ®µè™•ç†ç³»çµ±..."
	docker-compose down

logs:
	@echo "ğŸ“‹ æŸ¥çœ‹æœå‹™æ—¥èªŒ..."
	docker-compose logs -f --tail=100

status:
	@echo "ğŸ“Š æœå‹™ç‹€æ…‹:"
	docker-compose ps
	@echo ""
	@echo "ğŸ” å¥åº·ç‹€æ…‹:"
	@docker exec satellite-processor python /satellite-processing/scripts/health_check.py 2>/dev/null || echo "âŒ å®¹å™¨æœªé‹è¡Œæˆ–å¥åº·æª¢æŸ¥å¤±æ•—"

# ğŸ“¡ TLE æ•¸æ“šç®¡ç†å‘½ä»¤
tle-setup:
	@echo "ğŸ“¡ å®‰è£ TLE è‡ªå‹•ä¸‹è¼‰æ’ç¨‹..."
	@docker exec satellite-processor /satellite-processing/scripts/tle_management/tle_cron_scheduler.sh install || \
	 docker exec satellite-dev /satellite-processing/scripts/tle_management/tle_cron_scheduler.sh install

tle-status:
	@echo "ğŸ“Š TLE ä¸‹è¼‰ç‹€æ…‹æª¢æŸ¥..."
	@docker exec satellite-processor /satellite-processing/scripts/tle_management/tle_cron_scheduler.sh status || \
	 docker exec satellite-dev /satellite-processing/scripts/tle_management/tle_cron_scheduler.sh status

tle-download:
	@echo "ğŸŒ æ‰‹å‹•ä¸‹è¼‰ TLE æ•¸æ“š..."
	@docker exec satellite-processor /satellite-processing/scripts/tle_management/daily_tle_download_enhanced.sh || \
	 docker exec satellite-dev /satellite-processing/scripts/tle_management/daily_tle_download_enhanced.sh

tle-download-force:
	@echo "âš¡ å¼·åˆ¶é‡æ–°ä¸‹è¼‰ TLE æ•¸æ“š..."
	@docker exec satellite-processor /satellite-processing/scripts/tle_management/daily_tle_download_enhanced.sh --force || \
	 docker exec satellite-dev /satellite-processing/scripts/tle_management/daily_tle_download_enhanced.sh --force

tle-cleanup:
	@echo "ğŸ§¹ æ¸…ç†éæœŸ TLE æ•¸æ“š..."
	@docker exec satellite-processor /satellite-processing/scripts/tle_management/intelligent_data_cleanup.sh || \
	 docker exec satellite-dev /satellite-processing/scripts/tle_management/intelligent_data_cleanup.sh

tle-logs:
	@echo "ğŸ“‹ æŸ¥çœ‹ TLE ä¸‹è¼‰æ—¥èªŒ..."
	@docker exec satellite-processor /satellite-processing/scripts/tle_management/tle_cron_scheduler.sh logs 50 || \
	 docker exec satellite-dev /satellite-processing/scripts/tle_management/tle_cron_scheduler.sh logs 50

# ğŸ› ï¸ é–‹ç™¼ç’°å¢ƒå‘½ä»¤
dev-up:
	@echo "ğŸ› ï¸ å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "âœ… é–‹ç™¼ç’°å¢ƒå·²å•Ÿå‹•"
	@echo "ğŸ’¡ é€²å…¥å®¹å™¨: make dev-exec"
	@echo "ğŸš€ åŸ·è¡Œè™•ç†: make dev-run-stages"

dev-down:
	@echo "ğŸ›‘ åœæ­¢é–‹ç™¼ç’°å¢ƒ..."
	docker-compose -f docker-compose.dev.yml down

dev-logs:
	@echo "ğŸ“‹ é–‹ç™¼ç’°å¢ƒæ—¥èªŒ..."
	docker-compose -f docker-compose.dev.yml logs -f --tail=50

dev-exec:
	@echo "ğŸ–¥ï¸ é€²å…¥é–‹ç™¼å®¹å™¨..."
	docker exec -it satellite-dev bash

dev-status:
	@echo "ğŸ“Š é–‹ç™¼ç’°å¢ƒç‹€æ…‹:"
	docker-compose -f docker-compose.dev.yml ps

# ğŸ§ª å…­éšæ®µè™•ç†å‘½ä»¤
run-stages:
	@echo "ğŸš€ åŸ·è¡Œå®Œæ•´å…­éšæ®µè™•ç†..."
	docker exec satellite-processor python /satellite-processing/scripts/run_six_stages_with_validation.py --validation-level=STANDARD

run-fast:
	@echo "âš¡ åŸ·è¡Œå…­éšæ®µè™•ç† (FAST æ¨¡å¼)..."
	docker exec satellite-processor python /satellite-processing/scripts/run_six_stages_with_validation.py --validation-level=FAST

run-comprehensive:
	@echo "ğŸ” åŸ·è¡Œå…­éšæ®µè™•ç† (COMPREHENSIVE æ¨¡å¼)..."
	docker exec satellite-processor python /satellite-processing/scripts/run_six_stages_with_validation.py --validation-level=COMPREHENSIVE

run-stage1:
	@echo "ğŸ“¡ åŸ·è¡Œéšæ®µ1 (TLEè»Œé“è¨ˆç®—)..."
	docker exec satellite-processor python /satellite-processing/scripts/run_six_stages_with_validation.py --stage=1

run-stage6:
	@echo "ğŸŒ åŸ·è¡Œéšæ®µ6 (å‹•æ…‹æ± è¦åŠƒ)..."
	docker exec satellite-processor python /satellite-processing/scripts/run_six_stages_with_validation.py --stage=6

# é–‹ç™¼ç’°å¢ƒè™•ç†å‘½ä»¤
dev-run-stages:
	@echo "ğŸ› ï¸ é–‹ç™¼ç’°å¢ƒï¼šåŸ·è¡Œå®Œæ•´å…­éšæ®µè™•ç†..."
	docker exec satellite-dev python /satellite-processing/scripts/run_six_stages_with_validation.py --validation-level=FAST

dev-run-stage:
	@echo "ğŸ› ï¸ é–‹ç™¼ç’°å¢ƒï¼šåŸ·è¡Œéšæ®µ $(STAGE)..."
	docker exec satellite-dev python /satellite-processing/scripts/run_six_stages_with_validation.py --stage=$(STAGE) --validation-level=FAST

# ğŸ” å¥åº·å’Œç›£æ§
health:
	@echo "ğŸ” åŸ·è¡Œå¥åº·æª¢æŸ¥..."
	@docker exec satellite-processor python /satellite-processing/scripts/health_check.py || \
	 docker exec satellite-dev python /satellite-processing/scripts/health_check.py 2>/dev/null || \
	 echo "âŒ ç„¡æ³•åŸ·è¡Œå¥åº·æª¢æŸ¥ - è«‹ç¢ºèªå®¹å™¨é‹è¡Œç‹€æ…‹"

show-outputs:
	@echo "ğŸ“‚ æŸ¥çœ‹è¼¸å‡ºç›®éŒ„:"
	@docker exec satellite-processor ls -la /satellite-processing/data/outputs/ 2>/dev/null || \
	 docker exec satellite-dev ls -la /satellite-processing/data/outputs/ 2>/dev/null || \
	 echo "âŒ ç„¡æ³•è¨ªå•è¼¸å‡ºç›®éŒ„"

show-validation:
	@echo "ğŸ“‹ æŸ¥çœ‹é©—è­‰å¿«ç…§:"
	@docker exec satellite-processor ls -la /satellite-processing/data/validation_snapshots/ 2>/dev/null || \
	 docker exec satellite-dev ls -la /satellite-processing/data/validation_snapshots/ 2>/dev/null || \
	 echo "âŒ ç„¡æ³•è¨ªå•é©—è­‰ç›®éŒ„"

# ğŸ§ª æ¸¬è©¦å‘½ä»¤
test:
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦å¥—ä»¶..."
	@docker exec satellite-processor python -m pytest /satellite-processing/tests/ -v 2>/dev/null || \
	 docker exec satellite-dev python -m pytest /satellite-processing/tests/ -v 2>/dev/null || \
	 echo "âŒ ç„¡æ³•åŸ·è¡Œæ¸¬è©¦ - è«‹ç¢ºèªå®¹å™¨é‹è¡Œç‹€æ…‹"

# ğŸ› ï¸ ç¶­è­·å‘½ä»¤
clean:
	@echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„ Docker è³‡æº..."
	docker system prune -f
	docker volume prune -f

clean-data:
	@echo "âš ï¸ æ¸…ç†è¼¸å‡ºæ•¸æ“šç›®éŒ„..."
	@read -p "ç¢ºå®šè¦æ¸…ç†æ‰€æœ‰è¼¸å‡ºæ•¸æ“šå—? (y/N): " confirm && \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker exec satellite-processor rm -rf /satellite-processing/data/outputs/* 2>/dev/null || true; \
		docker exec satellite-processor rm -rf /satellite-processing/data/validation_snapshots/* 2>/dev/null || true; \
		docker exec satellite-dev rm -rf /satellite-processing/data/outputs/* 2>/dev/null || true; \
		docker exec satellite-dev rm -rf /satellite-processing/data/validation_snapshots/* 2>/dev/null || true; \
		echo "âœ… æ•¸æ“šå·²æ¸…ç†"; \
	else \
		echo "âŒ å–æ¶ˆæ¸…ç†"; \
	fi

restart:
	@echo "ğŸ”„ é‡å•Ÿæœå‹™..."
	make down
	make up

dev-restart:
	@echo "ğŸ”„ é‡å•Ÿé–‹ç™¼ç’°å¢ƒ..."
	make dev-down
	make dev-up

# ğŸ“Š ä¿¡æ¯å‘½ä»¤
info:
	@echo "â„¹ï¸ å…­éšæ®µè™•ç†ç³»çµ±ä¿¡æ¯:"
	@echo "  ğŸ—ï¸ é …ç›®åç¨±: Six Stages Satellite Processing System"
	@echo "  ğŸ“¦ Docker æ˜ åƒ: satellite-processing-system"
	@echo "  ğŸŒ ç¶²è·¯: satellite-network (172.30.0.0/16)"
	@echo "  ğŸ“‚ æ•¸æ“šç›®éŒ„: ./data/"
	@echo "  ğŸ”§ é…ç½®æ–‡ä»¶: ./config/"
	@echo "  ğŸ“ æºç¢¼ç›®éŒ„: ./src/"
	@echo ""
	@echo "ğŸ“‹ å¿«é€Ÿå•Ÿå‹•:"
	@echo "  1. make build        # é¦–æ¬¡æ§‹å»º"
	@echo "  2. make up          # å•Ÿå‹•æœå‹™"  
	@echo "  3. make run-stages  # åŸ·è¡Œè™•ç†"
	@echo ""
	@echo "ğŸ› ï¸ é–‹ç™¼æ¨¡å¼:"
	@echo "  1. make dev-up       # å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ"
	@echo "  2. make dev-exec     # é€²å…¥å®¹å™¨"
	@echo "  3. make dev-run-stages  # åŸ·è¡Œè™•ç†"