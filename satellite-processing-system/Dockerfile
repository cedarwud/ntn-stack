FROM python:3.11-slim

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /satellite-processing

# ğŸ› ï¸ å®‰è£åŸºç¤é–‹ç™¼å·¥å…·ï¼ˆGPUé€šénvidia-container-runtimeæä¾›ï¼‰
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# è¤‡è£½ Python ä¾è³´å®šç¾©
COPY requirements.txt .

# å®‰è£ Python ä¾è³´
RUN pip install --no-cache-dir -r requirements.txt

# è¤‡è£½æ ¸å¿ƒä»£ç¢¼ (é€šé volume æ›è¼‰åœ¨é–‹ç™¼æ™‚)
# ç”Ÿç”¢æ™‚å¯ä»¥ç›´æ¥ COPYï¼Œé–‹ç™¼æ™‚é€šé volume è¦†è“‹
COPY src/ ./src/
COPY scripts/ ./scripts/

# è¨­ç½®ç’°å¢ƒè®Šé‡
ENV PYTHONPATH=/satellite-processing/src:/satellite-processing
ENV SATELLITE_PROCESSING_HOME=/satellite-processing
ENV TLE_DATA_DIR=/satellite-processing/data/tle_data
ENV OUTPUT_DIR=/satellite-processing/data/outputs
ENV VALIDATION_DIR=/satellite-processing/data/validation_snapshots

# å‰µå»ºå¿…è¦ç›®éŒ„
RUN mkdir -p /satellite-processing/data/{tle_data,outputs,validation_snapshots,logs}

# è¨­ç½®æ¬Šé™
RUN chmod +x /satellite-processing/scripts/*.py

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD python /satellite-processing/scripts/health_check.py || exit 1

# é»˜èªå‘½ä»¤
CMD ["python", "/satellite-processing/scripts/run_six_stages_with_validation.py", "--validation-level=STANDARD"]