# ğŸ› ï¸ é–‹ç™¼æ¨¡å¼ Docker Compose é…ç½®
# ç”¨æ–¼é–‹ç™¼æ™‚çš„å®¹å™¨é…ç½®ï¼Œæ”¯æ´ç†±é‡è¼‰å’Œå³æ™‚èª¿è©¦

services:
  satellite-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: satellite-dev

    # ğŸš€ GPU æ”¯æ´é…ç½® (RTX 4090) - å·²å•Ÿç”¨
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    # ğŸ”„ é–‹ç™¼æ¨¡å¼ Volume æ›è¼‰
    volumes:
      # ğŸ“ æºç¢¼ç†±é‡è¼‰æ›è¼‰
      - ./src:/satellite-processing/src                          # å…­éšæ®µæ ¸å¿ƒä»£ç¢¼
      - ./config:/satellite-processing/config                    # é…ç½®æ–‡ä»¶
      - ./scripts:/satellite-processing/scripts                  # åŸ·è¡Œè…³æœ¬
      - ./tests:/satellite-processing/tests                      # æ¸¬è©¦æ–‡ä»¶
      
      # ğŸ“Š é–‹ç™¼æ•¸æ“šæ›è¼‰ (ä½¿ç”¨æœ¬åœ°ç›®éŒ„)
      - ./data/tle_data:/satellite-processing/data/tle_data      # TLE æ­·å²æ•¸æ“š
      - ./data/outputs:/satellite-processing/data/outputs        # é€šç”¨è¼¸å‡ºç›®éŒ„
      - ./data/outputs/stage1:/satellite-processing/data/stage1_outputs # éšæ®µä¸€è¼¸å‡º
      - ./data/outputs/stage2:/satellite-processing/data/stage2_outputs # éšæ®µäºŒè¼¸å‡º  
      - ./data/outputs/stage3:/satellite-processing/data/stage3_outputs # éšæ®µä¸‰è¼¸å‡º
      - ./data/outputs/stage4:/satellite-processing/data/stage4_outputs # éšæ®µå››è¼¸å‡º
      - ./data/outputs/stage5:/satellite-processing/data/stage5_outputs # éšæ®µäº”è¼¸å‡º
      - ./data/outputs/stage6:/satellite-processing/data/stage6_outputs # éšæ®µå…­è¼¸å‡º
      - ./data/validation_snapshots:/satellite-processing/data/validation_snapshots  # é©—è­‰å¿«ç…§
      - ./data/logs:/satellite-processing/data/logs              # é–‹ç™¼æ—¥èªŒ
      
      # ğŸ› ï¸ é–‹ç™¼å·¥å…·
      - ./docs:/satellite-processing/docs                        # æ–‡æª”ç›®éŒ„
      - ./.env:/satellite-processing/.env                        # ç’°å¢ƒè®Šé‡æ–‡ä»¶
    
    # ğŸŒ é–‹ç™¼ç’°å¢ƒè®Šé‡ (å¾ .env æ–‡ä»¶è®€å–)
    environment:
      - PYTHONPATH=${PYTHONPATH}
      - SATELLITE_ENV=${SATELLITE_ENV}
      - VALIDATION_LEVEL=${VALIDATION_LEVEL}
      - LOG_LEVEL=${LOG_LEVEL}
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - RELOAD_ON_CHANGE=${RELOAD_ON_CHANGE}
      - DATA_BASE_PATH=${DATA_BASE_PATH}
      - TLE_DATA_PATH=${TLE_DATA_PATH}
      - OUTPUTS_PATH=${OUTPUTS_PATH}
      - LOGS_PATH=${LOGS_PATH}
      - VALIDATION_PATH=${VALIDATION_PATH}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - DATABASE_URL=${DATABASE_URL}
      # ğŸš€ GPU æ”¯æ´ç’°å¢ƒè®Šé‡
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    
    # ğŸ”Œ ç«¯å£æ˜ å°„ (å¾ .env æ–‡ä»¶è®€å–)
    ports:
      - "${HEALTH_CHECK_PORT}:8900"   # å¥åº·æª¢æŸ¥ç«¯é»
      - "${DEV_API_PORT}:8901"        # é–‹ç™¼ API ç«¯é»
      - "${PYTHON_DEBUG_PORT}:5678"   # Python èª¿è©¦ç«¯å£
    
    # ğŸƒ é–‹ç™¼æ¨¡å¼å‘½ä»¤ (ä¿æŒå®¹å™¨é‹è¡Œ)
    command: >
      sh -c "
        echo 'ğŸš€ å…­éšæ®µé–‹ç™¼æ¨¡å¼å•Ÿå‹•...'
        echo 'ğŸ“‚ æºç¢¼ç›®éŒ„: /satellite-processing/src'
        echo 'ğŸ“Š æ•¸æ“šç›®éŒ„: /satellite-processing/data'
        echo 'âš¡ ä½¿ç”¨ FAST é©—è­‰æ¨¡å¼'
        
        # æª¢æŸ¥å¥åº·ç‹€æ…‹
        python /satellite-processing/scripts/health_check.py
        
        # ä¿æŒå®¹å™¨é‹è¡Œï¼Œç­‰å¾…æ‰‹å‹•åŸ·è¡Œ
        echo 'âœ… å®¹å™¨å°±ç·’ï¼Œå¯ä»¥åŸ·è¡Œè™•ç†ä»»å‹™'
        echo 'ğŸ’¡ åŸ·è¡Œå‘½ä»¤: docker exec satellite-dev python /satellite-processing/scripts/run_six_stages_with_validation.py'
        
        tail -f /dev/null
      "
    
    # ğŸ”„ é–‹ç™¼é‡å•Ÿç­–ç•¥
    restart: unless-stopped
    
    # ğŸ“‹ ä¾è³´æœå‹™
    depends_on:
      - postgres-dev
    
    # ğŸŒ é–‹ç™¼ç¶²è·¯
    networks:
      - satellite-dev-network
    
    # ğŸ·ï¸ é–‹ç™¼æ¨™ç±¤
    labels:
      - "satellite.env=development"
      - "satellite.auto-reload=true"

  # ğŸ“Š é–‹ç™¼ç”¨ PostgreSQL
  postgres-dev:
    image: postgres:15
    container_name: satellite-postgres-dev
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres-dev-data:/var/lib/postgresql/data
      - ./sql:/docker-entrypoint-initdb.d              # é–‹ç™¼ç”¨ SQL è…³æœ¬
    ports:
      - "${POSTGRES_EXTERNAL_PORT}:5432"  # é¿å…èˆ‡ä¸»æ©Ÿ PostgreSQL è¡çª
    networks:
      - satellite-dev-network
    restart: unless-stopped

  # ğŸ“ˆ é–‹ç™¼ç›£æ§å·¥å…·
  dev-monitor:
    image: alpine:latest
    container_name: satellite-dev-monitor
    command: >
      sh -c "
        echo 'ğŸ“Š é–‹ç™¼ç›£æ§å•Ÿå‹•...'
        while true; do
          echo '=== $(date) ==='
          echo 'ğŸ“‚ è¼¸å‡ºç›®éŒ„:'
          ls -la /data/outputs/ 2>/dev/null || echo '  (ç©º)'
          echo 'ğŸ” é©—è­‰å¿«ç…§:'
          ls -la /data/validation/ 2>/dev/null || echo '  (ç©º)' 
          echo 'ğŸ“ æœ€æ–°æ—¥èªŒ:'
          tail -n 3 /data/logs/*.log 2>/dev/null || echo '  (ç„¡æ—¥èªŒ)'
          echo '================================='
          sleep 30
        done
      "
    volumes:
      - ./data/outputs:/data/outputs:ro
      - ./data/validation_snapshots:/data/validation_snapshots:ro  
      - ./data/logs:/data/logs:ro
    networks:
      - satellite-dev-network
    restart: unless-stopped

# ğŸ’¾ é–‹ç™¼æ•¸æ“šå·
volumes:
  postgres-dev-data:
    driver: local

# ğŸŒ é–‹ç™¼ç¶²è·¯
networks:
  satellite-dev-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.0.0/16