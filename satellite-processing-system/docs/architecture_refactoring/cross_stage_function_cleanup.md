# ğŸ”§ è·¨éšæ®µåŠŸèƒ½æ¸…ç†è¨ˆç•« (Cross-Stage Function Cleanup Plan)

## ğŸ¯ æ¸…ç†ç›®æ¨™

**åŸºæ–¼éšæ®µè·è²¬åˆ†æç™¼ç¾çš„åŠŸèƒ½é‡è¤‡å’Œè¶Šç•Œå•é¡Œï¼Œåˆ¶å®šç³»çµ±æ€§æ¸…ç†è¨ˆç•«ï¼Œæ¶ˆé™¤è·¨éšæ®µåŠŸèƒ½é‡è¤‡ï¼Œç¢ºä¿æ¯å€‹éšæ®µåŠŸèƒ½é‚Šç•Œæ¸…æ™°ã€‚**

### ğŸ“Š åŠŸèƒ½é‡è¤‡å•é¡Œæ¦‚è¦½

| é‡è¤‡åŠŸèƒ½é¡åˆ¥ | æ¶‰åŠéšæ®µ | é‡è¤‡åš´é‡åº¦ | æ¸…ç†å„ªå…ˆç´š | å½±éŸ¿ç¯„åœ |
|------------|----------|------------|------------|----------|
| **å¼·åŒ–å­¸ç¿’é è™•ç†** | Stage 3,4,6 | ğŸ”´ é«˜ | ğŸ”¥ ç·Šæ€¥ | ç³»çµ±æ¶æ§‹ |
| **è§€æ¸¬è€…è¨ˆç®—** | Stage 1,2 | ğŸ”´ é«˜ | ğŸ”¥ ç·Šæ€¥ | æ•¸æ“šæµ |
| **ç‰©ç†æ¨™æº–è¨ˆç®—** | Stage 2,3 | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­æœŸ | è¨ˆç®—ç²¾åº¦ |
| **åº§æ¨™è½‰æ›** | Stage 1,2,3 | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­æœŸ | æ€§èƒ½ |
| **æ™‚é–“åŸºæº–è™•ç†** | Stage 1,4,5 | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­æœŸ | æ™‚åºåŒæ­¥ |

---

## ğŸ”¥ ç·Šæ€¥æ¸…ç†é …ç›®

### 1. å¼·åŒ–å­¸ç¿’é è™•ç†åŠŸèƒ½çµ±ä¸€

#### ğŸ“‹ å•é¡Œç¾ç‹€
- **Stage 3**: åŒ…å« RL é è™•ç†é‚è¼¯
- **Stage 4**: ä¸»è¦ RL é è™•ç†å¯¦ç¾
- **Stage 6**: é‡è¤‡çš„ RL é è™•ç†åŠŸèƒ½

#### ğŸ¯ æ¸…ç†ç›®æ¨™
```
Stage 3 â†’ ç§»é™¤ RL é è™•ç† â†’ å°ˆæ³¨ä¿¡è™Ÿåˆ†æ
Stage 4 â†’ ä¿ç•™æ ¸å¿ƒ RL é è™•ç† â†’ æ¨™æº–åŒ–ä»‹é¢
Stage 6 â†’ ç§»é™¤é‡è¤‡ RL é è™•ç† â†’ å°ˆæ³¨å‹•æ…‹è¦åŠƒ
```

#### ğŸ› ï¸ å¯¦æ–½æ­¥é©Ÿ

**Step 1: Stage 3 æ¸…ç†**
```python
# ğŸš« ç§»é™¤ï¼šStage 3 ä¸­çš„ RL é è™•ç†ä»£ç¢¼
# æ–‡ä»¶ï¼šstage3_signal_analysis_processor.py
- _prepare_rl_features()
- _normalize_rl_data()
- _create_rl_state_vectors()

# âœ… ä¿ç•™ï¼šç´”ä¿¡è™Ÿåˆ†æåŠŸèƒ½
- calculate_rsrp()
- calculate_rsrq()
- analyze_3gpp_events()
```

**Step 2: Stage 4 æ¨™æº–åŒ–**
```python
# âœ… çµ±ä¸€ï¼šStage 4 RL é è™•ç†ä»‹é¢
class UnifiedRLPreprocessor:
    def preprocess_for_handover(self, signal_data):
        """æ¨™æº–åŒ–æ›æ‰‹ RL é è™•ç†"""
        pass

    def preprocess_for_coverage(self, coverage_data):
        """æ¨™æº–åŒ–è¦†è“‹ RL é è™•ç†"""
        pass
```

**Step 3: Stage 6 æ¸…ç†**
```python
# ğŸš« ç§»é™¤ï¼šStage 6 ä¸­é‡è¤‡çš„ RL é è™•ç†
# æ”¹ç‚ºï¼šèª¿ç”¨ Stage 4 çš„æ¨™æº–åŒ–ä»‹é¢
from stages.stage4.unified_rl_preprocessor import UnifiedRLPreprocessor

rl_processor = UnifiedRLPreprocessor()
processed_data = rl_processor.preprocess_for_coverage(data)
```

### 2. è§€æ¸¬è€…è¨ˆç®—åŠŸèƒ½é‚Šç•Œæ¸…ç†

#### ğŸ“‹ å•é¡Œç¾ç‹€
- **Stage 1**: åŒ…å«è§€æ¸¬è€…å¹¾ä½•è¨ˆç®— (è¶Šç•Œ)
- **Stage 2**: é‡è¤‡å¯¦ç¾è§€æ¸¬è€…è¨ˆç®—

#### ğŸ¯ æ¸…ç†ç›®æ¨™
```
Stage 1 â†’ ç§»é™¤æ‰€æœ‰è§€æ¸¬è€…è¨ˆç®— â†’ ç´” ECI è¼¸å‡º
Stage 2 â†’ çµ±ä¸€è§€æ¸¬è€…è¨ˆç®—å¯¦ç¾ â†’ æ¨™æº–åŒ–ä»‹é¢
```

#### ğŸ› ï¸ å¯¦æ–½æ­¥é©Ÿ

**Step 1: Stage 1 è§€æ¸¬è€…åŠŸèƒ½ç§»é™¤**
```python
# ğŸš« å®Œå…¨ç§»é™¤çš„æ–¹æ³• (ç´„400è¡Œä»£ç¢¼)
- _add_observer_geometry()           # 1637-1674è¡Œ
- _calculate_observer_geometry()     # 1722-1772è¡Œ
- _calculate_elevation_azimuth()     # 1774-1796è¡Œ
- _enhance_satellite_with_observer_data()  # 1676-1691è¡Œ
- _add_observer_data_to_position()   # 1693-1720è¡Œ
```

**Step 2: Stage 2 è§€æ¸¬è€…è¨ˆç®—æ¨™æº–åŒ–**
```python
# âœ… çµ±ä¸€è§€æ¸¬è€…è¨ˆç®—ä»‹é¢
class StandardObserverCalculator:
    def calculate_elevation_azimuth(self, eci_position, observer_location):
        """æ¨™æº–ä»°è§’æ–¹ä½è§’è¨ˆç®—"""
        pass

    def determine_visibility(self, elevation_deg, constellation):
        """æ¨™æº–å¯è¦‹æ€§åˆ¤æ–·"""
        pass
```

---

## ğŸŸ¡ ä¸­æœŸæ¸…ç†é …ç›®

### 3. ç‰©ç†æ¨™æº–è¨ˆç®—çµ±ä¸€

#### ğŸ“‹ å•é¡Œç¾ç‹€
- **Stage 2**: åŸºæœ¬ç‰©ç†è¨ˆç®— (è·é›¢ã€ä»°è§’)
- **Stage 3**: é«˜ç´šç‰©ç†è¨ˆç®— (ä¿¡è™Ÿå‚³æ’­ã€è¡°æ¸›)

#### ğŸ¯ æ¸…ç†ç›®æ¨™
å»ºç«‹çµ±ä¸€çš„ç‰©ç†è¨ˆç®—åº«ï¼Œé¿å…é‡è¤‡å¯¦ç¾åŸºç¤ç‰©ç†å…¬å¼

#### ğŸ› ï¸ å¯¦æ–½æ–¹æ¡ˆ
```python
# å»ºç«‹ï¼šshared/physics_library.py
class UnifiedPhysicsCalculator:
    @staticmethod
    def calculate_distance(pos1, pos2):
        """çµ±ä¸€è·é›¢è¨ˆç®—"""
        pass

    @staticmethod
    def calculate_elevation_angle(satellite_pos, observer_pos):
        """çµ±ä¸€ä»°è§’è¨ˆç®—"""
        pass

    @staticmethod
    def calculate_path_loss(distance_km, frequency_ghz):
        """çµ±ä¸€è·¯å¾‘æè€—è¨ˆç®—"""
        pass
```

### 4. åº§æ¨™è½‰æ›åŠŸèƒ½çµ±ä¸€

#### ğŸ“‹ å•é¡Œç¾ç‹€
- **Stage 1**: ECI åº§æ¨™è¨ˆç®—
- **Stage 2**: ECI â†’ åœ°å¹³åº§æ¨™è½‰æ›
- **Stage 3**: åº§æ¨™ç³»çµ±é–“è½‰æ›

#### ğŸ¯ æ¸…ç†ç›®æ¨™
å»ºç«‹æ¨™æº–åº§æ¨™è½‰æ›åº«ï¼Œé¿å…é‡è¤‡å¯¦ç¾è½‰æ›é‚è¼¯

#### ğŸ› ï¸ å¯¦æ–½æ–¹æ¡ˆ
```python
# å»ºç«‹ï¼šshared/coordinate_transformer.py
class StandardCoordinateTransformer:
    @staticmethod
    def eci_to_local_horizontal(eci_pos, observer_location, timestamp):
        """ECI â†’ åœ°å¹³åº§æ¨™ç³»è½‰æ›"""
        pass

    @staticmethod
    def calculate_relative_geometry(satellite_eci, observer_eci):
        """ç›¸å°å¹¾ä½•è¨ˆç®—"""
        pass
```

### 5. æ™‚é–“åŸºæº–è™•ç†çµ±ä¸€

#### ğŸ“‹ å•é¡Œç¾ç‹€
- **Stage 1**: TLE epoch æ™‚é–“è™•ç†
- **Stage 4**: æ™‚åºæ•¸æ“šæ™‚é–“è™•ç†
- **Stage 5**: è·¨éšæ®µæ™‚é–“åŒæ­¥

#### ğŸ¯ æ¸…ç†ç›®æ¨™
å»ºç«‹çµ±ä¸€æ™‚é–“åŸºæº–ç®¡ç†ç³»çµ±

#### ğŸ› ï¸ å¯¦æ–½æ–¹æ¡ˆ
```python
# å»ºç«‹ï¼šshared/time_base_manager.py
class UnifiedTimeBaseManager:
    @staticmethod
    def get_calculation_base_time(tle_epoch):
        """çµ±ä¸€è¨ˆç®—åŸºæº–æ™‚é–“"""
        pass

    @staticmethod
    def synchronize_stage_timestamps(stage_data):
        """éšæ®µé–“æ™‚é–“æˆ³åŒæ­¥"""
        pass
```

---

## ğŸ“‹ æ¸…ç†å¯¦æ–½è·¯ç·šåœ–

### Phase 1: ç·Šæ€¥åŠŸèƒ½æ¸…ç† (2é€±)

**Week 1: å¼·åŒ–å­¸ç¿’é è™•ç†çµ±ä¸€**
- Day 1-2: Stage 3 RL åŠŸèƒ½ç§»é™¤
- Day 3-4: Stage 4 RL é è™•ç†æ¨™æº–åŒ–
- Day 5: Stage 6 RL é‡è¤‡åŠŸèƒ½æ¸…ç†

**Week 2: è§€æ¸¬è€…è¨ˆç®—é‚Šç•Œæ¸…ç†**
- Day 1-3: Stage 1 è§€æ¸¬è€…åŠŸèƒ½å®Œå…¨ç§»é™¤
- Day 4-5: Stage 2 è§€æ¸¬è€…è¨ˆç®—æ¨™æº–åŒ–

### Phase 2: ä¸­æœŸåŠŸèƒ½çµ±ä¸€ (3é€±)

**Week 3: ç‰©ç†è¨ˆç®—åº«å»ºç«‹**
- çµ±ä¸€ç‰©ç†è¨ˆç®—å¯¦ç¾
- Stage 2,3 èª¿ç”¨æ¨™æº–åº«

**Week 4: åº§æ¨™è½‰æ›åº«å»ºç«‹**
- çµ±ä¸€åº§æ¨™è½‰æ›å¯¦ç¾
- Stage 1,2,3 èª¿ç”¨æ¨™æº–åº«

**Week 5: æ™‚é–“åŸºæº–ç³»çµ±çµ±ä¸€**
- çµ±ä¸€æ™‚é–“è™•ç†å¯¦ç¾
- Stage 1,4,5 èª¿ç”¨æ¨™æº–åº«

---

## ğŸ§ª æ¸…ç†é©—è­‰æ¨™æº–

### åŠŸèƒ½å®Œæ•´æ€§é©—è­‰
```python
# âœ… å¿…é ˆé€šéçš„é©—è­‰é …ç›®
- 10/10 å­¸è¡“ç´šé©—è­‰æª¢æŸ¥é€šé
- 8,932é¡†è¡›æ˜Ÿ 100%è™•ç†æˆåŠŸç‡
- æ•¸æ“šæµå®Œæ•´æ€§ä¿è­‰
- éšæ®µé–“ä»‹é¢ç©©å®šæ€§
```

### æ€§èƒ½æ”¹å–„ç›®æ¨™
```bash
# é‡è¤‡åŠŸèƒ½æ¸…ç†å¾Œé æœŸæ”¹å–„
ä»£ç¢¼é‡è¤‡ç‡: é™ä½40%
è¨˜æ†¶é«”ä½¿ç”¨: æ¸›å°‘25%
è™•ç†æ™‚é–“: æå‡15%
ç¶­è­·è¤‡é›œåº¦: é™ä½50%
```

### æ¶æ§‹æ¸…æ™°åº¦é©—è­‰
```python
# âœ… ç¢ºä¿æ¶æ§‹é‚Šç•Œæ¸…æ™°
- ç„¡è·¨éšæ®µåŠŸèƒ½é‡è¤‡
- æ¨™æº–åŒ–ä»‹é¢èª¿ç”¨
- çµ±ä¸€çš„å…±äº«åº«å¯¦ç¾
- æ¸…æ™°çš„è·è²¬åˆ†é›¢
```

---

## ğŸ›¡ï¸ é¢¨éšªæ§åˆ¶æªæ–½

### æ¸…ç†é¢¨éšªè©•ä¼°
- **ğŸ”´ é«˜é¢¨éšª**: å¯èƒ½å½±éŸ¿å¤šå€‹éšæ®µçš„æ•¸æ“šæµ
- **ğŸŸ¡ ä¸­é¢¨éšª**: éœ€è¦èª¿æ•´éšæ®µé–“ä»‹é¢
- **ğŸŸ¢ ä½é¢¨éšª**: å…§éƒ¨å¯¦ç¾é‡æ§‹ï¼Œä»‹é¢ä¸è®Š

### é¢¨éšªç·©è§£ç­–ç•¥
1. **åˆ†éšæ®µå¯¦æ–½**: å…ˆæ¸…ç†å–®å€‹éšæ®µï¼Œå†èª¿æ•´ä»‹é¢
2. **å®Œæ•´å‚™ä»½**: æ¸…ç†å‰å®Œæ•´å‚™ä»½æ‰€æœ‰ç›¸é—œä»£ç¢¼
3. **å›æ­¸æ¸¬è©¦**: æ¯æ­¥å®Œæˆå¾Œé€²è¡Œå®Œæ•´åŠŸèƒ½æ¸¬è©¦
4. **ä»‹é¢ç©©å®š**: ä¿æŒå°å¤–ä»‹é¢ç©©å®šï¼Œåªèª¿æ•´å…§éƒ¨å¯¦ç¾

### å“è³ªä¿è­‰æª¢æŸ¥é»
- [ ] Phase 1å®Œæˆ: ç·Šæ€¥åŠŸèƒ½æ¸…ç†ç„¡éŒ¯èª¤
- [ ] Phase 2å®Œæˆ: ä¸­æœŸåŠŸèƒ½çµ±ä¸€æˆåŠŸ
- [ ] é©—è­‰é€šé: 10/10é©—è­‰æª¢æŸ¥
- [ ] æ€§èƒ½é”æ¨™: è™•ç†æ™‚é–“æå‡15%
- [ ] æ¶æ§‹æ¸…æ™°: ç„¡åŠŸèƒ½é‡è¤‡

---

## ğŸ“Š æ¸…ç†å¾Œé æœŸæ•ˆæœ

### ä»£ç¢¼å“è³ªæå‡
- **åŠŸèƒ½é‡è¤‡**: æ¶ˆé™¤4å€‹ä¸»è¦é‡è¤‡é …ç›®
- **ä»£ç¢¼é‡è¤‡ç‡**: å¾35%é™è‡³<10%
- **ç¶­è­·è¤‡é›œåº¦**: é™ä½50%

### æ¶æ§‹æ¸…æ™°åº¦
- **è·è²¬é‚Šç•Œ**: åš´æ ¼éµå¾ªSTAGE_RESPONSIBILITIES.md
- **æ¨™æº–ä»‹é¢**: çµ±ä¸€çš„è·¨éšæ®µä»‹é¢
- **å…±äº«åº«**: æ¨™æº–åŒ–çš„å…±äº«åŠŸèƒ½å¯¦ç¾

### æ€§èƒ½æ”¹å–„
- **è™•ç†æ™‚é–“**: æå‡15% (æ¸›å°‘é‡è¤‡è¨ˆç®—)
- **è¨˜æ†¶é«”ä½¿ç”¨**: æ¸›å°‘25% (çµ±ä¸€æ•¸æ“šçµæ§‹)
- **ç¶­è­·æˆæœ¬**: é™ä½40% (å–®ä¸€å¯¦ç¾ç¶­è­·)

---

## ğŸ”„ å¾ŒçºŒç¶­è­·ç­–ç•¥

### é˜²æ­¢é‡è¤‡æ©Ÿåˆ¶
```python
# å»ºç«‹ï¼šshared/function_registry.py
class FunctionRegistry:
    """é˜²æ­¢åŠŸèƒ½é‡è¤‡çš„è¨»å†Šæ©Ÿåˆ¶"""

    @staticmethod
    def register_function(func_name, stage, description):
        """è¨»å†Šéšæ®µåŠŸèƒ½"""
        pass

    @staticmethod
    def check_duplicates():
        """æª¢æŸ¥åŠŸèƒ½é‡è¤‡"""
        pass
```

### æŒçºŒç›£æ§
- **ä»£ç¢¼å¯©æŸ¥**: æ–°åŠŸèƒ½é–‹ç™¼å‰æª¢æŸ¥é‡è¤‡
- **è‡ªå‹•æª¢æ¸¬**: CI/CD ä¸­åŠ å…¥é‡è¤‡æª¢æ¸¬å·¥å…·
- **æ–‡æª”æ›´æ–°**: åŒæ­¥æ›´æ–° STAGE_RESPONSIBILITIES.md

---

**ä¸‹ä¸€æ­¥**: é–‹å§‹Phase 1ç·Šæ€¥åŠŸèƒ½æ¸…ç†
**ç›¸é—œæ–‡æª”**: [å¼·åŒ–å­¸ç¿’åŠŸèƒ½æ•´åˆ](./rl_preprocessing_consolidation.md)

---
**æ–‡æª”ç‰ˆæœ¬**: v1.0
**æœ€å¾Œæ›´æ–°**: 2025-09-18
**ç‹€æ…‹**: å¾…åŸ·è¡Œ